<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Roguelike! Single File</title>
	<link rel="shortcut icon" type="x-icon" href="roguelikeicon.ico" />
    <style>
	  #gameIcon {
		max-width: 15%;
		height: auto;
	  }
      #titleScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-image: url("background.webp");
		background-repeat: no-repeat;
		background-position: center;
		background-size: 1365px 600px;
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
		margin-top: 20px;
      }
	  
      #titleScreen h1 {
        font-size: 48px;
        margin-bottom: 20px;
      }
	  
      #titleScreen .subheading {
        font-size: 24px;
        margin-bottom: 10px;
        text-align: center;
        max-width: 80%;
      }
	  
      #titleScreen .subsubheading {
        font-size: 18px;
        margin-bottom: 30px;
      }
	  
      #titleScreen button {
        padding: 10px 20px;
        font-size: 20px;
       background: #000000;
	  color: white;
	  border: 1px solid white;
        cursor: pointer;
      }
	  
      #titleScreen button:hover {
        background: #777;
      }
	  body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: black;
  color: white;
  font-family: sans-serif;
  text-align: center;
  overflow: auto;
}

#loadingScreen {
  position: fixed;
  top: 0; left: 0; width: 100vw; height: 100vh;
  background: black;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  opacity: 1;
  transition: opacity 1s ease;
}
.loading-text {
  color: white;
  font-size: 2em;
  font-family: sans-serif;
}

@keyframes dotPulse {
  0%   { content: "."; }
  33%  { content: ".."; }
  66%  { content: "..."; }
  100% { content: ""; }
}

#dots::after {
  content: "";
  animation: dotPulse 1s infinite steps(1, end);
}

#difficultyMenu button {
  color: white;
  font-weight: bold;
  padding: 0.5em 1em;
  border: 1px solid white;
  border-radius: 4px;
  margin: 0.25em;
  cursor: pointer;
}

#normalBtn {
  background-color: gray;
  color: black;
}

#hardBtn {
  background-color: orange;
  color: black;
}

#extremeBtn {
  background-color: red;
  color: black;
}

#insaneBtn {
  background-color: #700000;
  color: black;
}

#calamityBtn {
  background-color: black;
  color: red;
}

#bossRushBtn {
  background-color: blue;
  color: white;
}

#doomBtn {
  background-color: #2e0000;
  width: 50px;
}

#ultimateBtn {
  background-color: #f4ff57;
  color: white;
}

#difficultyMenu button:hover {
  opacity: 0.85;
}

@keyframes levitate {
  0%, 100% { transform: translateY(0); }
  50%     { transform: translateY(-2px); }
}

@keyframes slow-zoom {
  0%, 100% { background-size: 100% 100%; }
  50%      { background-size: 102% 102%; }
}

#doomModeButton {
  max-width: 100%;
  max-height: 100%;
  height: auto;
  margin: 0 auto 0.0005px;
}

#doomTitleScreen {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: url("doomcover.jpg") center/cover no-repeat;
  background-repeat: no-repeat;
  background-position: center;
  background-size: cover;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding-top: 40px;
  z-index: 2000;
  font-family: "Copperplate Gothic Bold", "Copperplate Gothic", Copperplate, fantasy;
  font-weight: bold;
  animation: slow-zoom 20s ease-in-out infinite;
}

#doomTitleContent {
  text-align: center;
  padding: 20px;
  border-radius: 6px;
}

#doomTitleContent p {
	right: 500px;
	top: 50px;
	background: rgba(0, 0, 0, 0.5);
}

#doomTitleImage {
  max-width: 40%;
  height: auto;
  margin: 0 auto 30px;
  animation: levitate 3s ease-in-out infinite;
}

#doomTitleImg {
  max-width: 40%;
  height: auto;
  margin: 0 auto 30px;
  animation: levitate 3s ease-in-out infinite;
}

#beginJourneyBtn {
  background: none;
  color: white;
  font-size: 22px;
  border: none;
  cursor: pointer;
  font-family: "Copperplate Gothic Bold", "Copperplate Gothic", Copperplate, fantasy;
  font-weight: bold;
}

#beginJourneyBtn:hover {
  opacity: 0.8;
}

#doomFadeOverlay {
  position: fixed;
  top:0; left:0;
  width:100vw; height:100vh;
  background: black;
  opacity: 0;
  transition: opacity 3s;
  z-index: 3000;
}

body.doom-mode #stats {
  color: #ff6200;
  background-color: #2e0000;
  border: black;
}

body.doom-mode .room {
  background-color: #2e0000 !important;
  border: 2px solid #ff6200 !important;
}

body.doom-mode .player {
  width: 25px;
  height: 25px;
  background-color: #174000;
}

body.doom-mode .inventorySlot {
  width: 40px;
  height: 40px;
  background: #174000;
  display: inline-block;
  position: relative;
  margin: 2px;
  border: 1px solid black;
  box-sizing: border-box;
  text-align: center;
  line-height: 40px;
}

body.doom-mode .hpBar,
body.doom-mode .armorBar,
body.doom-mode .manaBar,
body.doom-mode .expBar {
  width: 200px;
  height: 20px;
  position: relative;
  display: inline-block;
  background: black;
  margin-top: 5px;
}

body.doom-mode .hpBarInner {
  height: 100%;
  background: #2e7300;
  width: 100%;
}

body.doom-mode .expBarInner {
  height: 100%;
  background: #eb9a05;
  width: 0%;
}

body.doom-mode .manaBarInner {
  height: 100%;
  background: gray;
  width: 100%;
}

body.doom-mode .armorBarInner {
  background: #303030;
}

body.doom-mode #battleMenu {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-120%, -50%);
  background: #174000;
  border: 2px solid black;
  padding: 20px;
  display: none;
  z-index: 100;
}

body.doom-mode #battleMenu h3 {
  margin: 0 0 10px;
  color: white;
}

body.doom-mode #battleOptions button {
  margin: 5px;
  padding: 5px 10px;
  background: black;
  border: #ff6200;
  color: white;
  cursor: pointer;
}

body.doom-mode #battleOptions button:hover {
  background: #1c1c1c;
}

body.doom-mode #battleLog {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(20%, -50%);
  background: #174000;
  border: 2px solid black;
  padding: 20px;
  display: none;
  z-index: 100;
  width: 250px;
  height: 200px;
  overflow-y: auto;
}

body.doom-mode #inventoryMenu {
  display: none;
  position: absolute;
  top: 70%;
  left: 50%;
  transform: translate(-50%, 0);
  background: #174000;
  border: 2px solid black;
  padding: 10px;
  z-index: 150;
}

body.doom-mode #inventoryMenu button {
  margin: 5px;
  padding: 5px 10px;
  background: black;
  border: none;
  color: white;
  cursor: pointer;
}

body.doom-mode #inventoryMenu button:hover {
  background: #1c1c1c;
}

body.doom-mode #levelUpMenu {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #174000;
  border: 2px solid black;
  padding: 20px;
  display: none;
  z-index: 200;
}

body.doom-mode #levelUpMenu button {
  margin: 5px;
  padding: 5px 10px;
  background: black;
  border: none;
  color: white;
  cursor: pointer;
}

body.doom-mode #levelUpMenu button:hover {
  background: #1c1c1c;
}

body.doom-mode #shopMenu {
  display: none;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #174000;
  border: 2px solid black;
  padding: 20px;
  z-index: 250;
  width: 300px;
}

body.doom-mode #shopMenu h3 {
  margin-top: 0;
  color: white;
}

body.doom-mode #shopMenu button {
  margin: 5px;
  padding: 5px 10px;
  background: black;
  border: none;
  color: white;
  cursor: pointer;
}

body.doom-mode #shopMenu button:hover {
  background: #1c1c1c;
}

body.doom-mode #deathMenu {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #174000;
  border: 2px solid black;
  padding: 20px;
  display: none;
  z-index: 300;
  text-align: center;
}

body.doom-mode #deathMenu button {
  margin-top: 10px;
  padding: 5px 10px;
  background: black;
  border: none;
  color: white;
  cursor: pointer;
}

body.doom-mode #deathMenu button:hover {
  background: #1c1c1c;
}

body.doom-mode #equipmentBtn {
  position: absolute;
  top: 320px;
  right: 1250px;
  width: 100px;
  height: 100px;
  background: #2e0000;
  border: 2px solid #ff6200;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 40;
  transition: background 0.2s;
}

body.doom-mode #equipmentBtn:hover {
  background: rgba(46, 0, 0, 0.5);
}

body.doom-mode #equipmentBtn img {
  width: 90px;
  height: 90px;
}

/* Equipment Menu Modal */
body.doom-mode #equipmentMenu.modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #174000;
  border: 2px solid black;
  padding: 20px;
  border-radius: 8px;
  z-index: 650;
  width: 300px;
  color: white;
}

body.doom-mode #equipmentMenu .modal-content {
  position: relative;
}

body.doom-mode #equipmentMenu .close-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  background: black;
  border: white;
  color: white;
  font-size: 18px;
  cursor: pointer;
}

body.doom-mode #equipmentMenu #equipmentSlots {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 20px;
}

body.doom-mode .equipmentSlot {
  border: 2px solid black;
  padding: 8px;
  position: relative;
  cursor: pointer;
}
body.doom-mode .equipmentSlot .slot-label {
  font-weight: bold;
}
body.doom-mode .equipmentSlot .unequipBtn {
  position: absolute;
  top: 4px;
  right: 4px;
  background: black;
  border: none;
  color: white;
  font-size: 14px;
  padding: 2px 6px;
  cursor: pointer;
  display: none;
}
body.doom-mode .equipmentSlot:hover .unequipBtn {
  display: block;
}

#titleBox {
  background: rgba(0, 0, 0, 0.75);
  padding: 40px;
  border-radius: 12px;
  text-align: center;
  max-width: 700px;
  box-shadow: 0 0 15px rgba(0,0,0,0.6);
}

#titleScreen h6 {
	position: fixed;
	top: -10px;
	left: 5px;
}

#titleBox h6 {
	margin-top: 100px;
}

#playButton {
  display: none;
  margin: 20px auto;
  margin-top: 50px;
}

#creditsToggle {
  margin: 10px auto 0 auto;
  width: 50px;
  padding: 5px 10px;
  font-size: 16px;
  cursor: pointer;
  background: #0a0a0a;
  border: 1px solid white;
}

#creditsCredits {
  position: absolute;
  left: 50%;
  top: 20%;
  transform: translateX(-50%);
  width: 400px;
  background: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 15px;
  border: 1px solid #888;
  display: none;
  z-index: 150;
  border-radius: 4px;
}

#creditsCredits h1 {
	font-family: 'Edwardian Script ITC', cursive;
}

#creditsCredits h2 {
	font-family: 'Edwardian Script ITC', cursive;
}

#creditsCredits .tabs {
  text-align: center;
  margin-bottom: 10px;
}

#creditsCredits button {
  padding: 5px 10px;
  cursor: pointer;
  margin: 0 5px;
}

#contentCredits.content.scrollable {
   max-height: 300px;
   overflow-y: auto;
   margin-top: 10px;
   font-size: 14px;
   line-height: 1.4;
}

#exitCredits {
  display: block;
  margin: 10px auto 0 auto;
  padding: 5px 10px;
  font-size: 16px;
  cursor: pointer;
}

#worldCounter {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 500;
  background: rgba(0, 0, 0, 0.5);
  padding: 5px 10px;
  border-radius: 5px;
  font-size: 18px;
}

#gameContainer {
  position: relative;
  width: 100vw;
  height: 100vh;
  overflow-x: auto;
  overflow-y: auto;
}

#map {
  position: absolute;
  top: 0;
  left: 0;
  transition: transform 0.3s ease;
}

.room {
  width: 100px;
  height: 100px;
  background: #222;
  position: absolute;
  border: 1px solid #444;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

.room:hover {
  border: 2px solid green;
  cursor: pointer;
}

.player {
  width: 20px;
  height: 20px;
  background: blue;
}

#stats {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 175px;
  background: #333;
  padding: 10px;
  box-sizing: border-box;
  border: 1px solid #111111;
}

.barContainer {
  display: inline-block;
  vertical-align: middle;
  margin-right: 20px;
}

.hpBar,
.manaBar,
.expBar,
.armorBar {
  width: 200px;
  height: 20px;
  position: relative;
  display: inline-block;
  border: 1px solid #111111;
  background: #555;
  margin-top: 5px;
}

.hpBarInner {
  height: 100%;
  background: green;
  width: 100%;
}

.expBarInner {
  height: 100%;
  background: yellow;
  width: 0%;
}

.manaBarInner {
  height: 100%;
  background: blue;
  width: 100%;
}

.armorBarInner {
  height: 100%;
  background: gray;
  width: 100%;
}

#statsText {
  display: inline-block;
  vertical-align: middle;
  margin-right: 20px;
}

#inventorySlots {
  display: inline-block;
  vertical-align: middle;
  position: relative;
}

.inventorySlot {
  width: 40px;
  height: 40px;
  background: #555;
  display: inline-block;
  position: relative;
  margin: 2px;
  border: 1px solid #777;
  box-sizing: border-box;
  text-align: center;
  line-height: 40px;
}

.inventorySlot.weapon {
  background-color: red;
  color: white;
}
.inventorySlot.armor {
  background-color: yellow;
  color: black;
}
.inventorySlot.accessory {
  background-color: green;
  color: white;
}
.inventorySlot.consumable {
  background-color: gray;
  color: white;
}
.inventorySlot.dragonball {
  background-color: orange;
  color: red;
}

.inventorySlot .delete-btn {
  position: absolute;
  top: 2px;
  right: 2px;
  width: 16px;
  height: 16px;
  line-height: 14px;
  text-align: center;
  font-size: 12px;
  background: rgba(255, 255, 255, 0.6);
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: none;
  padding: 0;
  margin: 0;
}

.inventorySlot:hover .delete-btn {
  display: block;
}

.inventorySlot span {
  display: inline-block;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

#battleTint {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 50;
}

#battleMenu {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-120%, -50%);
  background: #222;
  border: 2px solid white;
  padding: 20px;
  display: none;
  z-index: 100;
}

#battleMenu h3 {
  margin: 0 0 10px;
}

#battleOptions button {
  margin: 5px;
  padding: 5px 10px;
  background: #555;
  border: none;
  color: white;
  cursor: pointer;
}

#battleOptions button:hover {
  background: #777;
}

#battleLog {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(20%, -50%);
  background: #222;
  border: 2px solid white;
  padding: 20px;
  display: none;
  z-index: 100;
  width: 250px;
  height: 200px;
  overflow-y: auto;
}

#inventoryMenu {
  display: none;
  position: absolute;
  top: 70%;
  left: 50%;
  transform: translate(-50%, 0);
  background: #222;
  border: 2px solid white;
  padding: 10px;
  z-index: 150;
}

#inventoryMenu button {
  margin: 5px;
  padding: 5px 10px;
  background: #555;
  border: none;
  color: white;
  cursor: pointer;
}

#inventoryMenu button:hover {
  background: #777;
}

#levelUpMenu {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #222;
  border: 2px solid white;
  padding: 20px;
  display: none;
  z-index: 1000;
}

#levelUpMenu button {
  margin: 5px;
  padding: 5px 10px;
  background: #555;
  border: none;
  color: white;
  cursor: pointer;
}

#levelUpMenu button:hover {
  background: #777;
}

#shopMenu {
  display: none;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #222;
  border: 2px solid white;
  padding: 20px;
  z-index: 250;
  width: 300px;
}

#shopMenu h3 {
  margin-top: 0;
}

#shopMenu button {
  margin: 5px;
  padding: 5px 10px;
  background: #555;
  border: none;
  color: white;
  cursor: pointer;
}

#shopMenu button:hover {
  background: #777;
}

#deathMenu {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #222;
  border: 2px solid white;
  padding: 20px;
  display: none;
  z-index: 300;
  text-align: center;
}

#deathMenu h2 {
	font-family: 'Copperplate Gothic Light', 'Copperplate', fantasy;
}

#deathMenu button {
  margin-top: 10px;
  padding: 5px 10px;
  background: #555;
  border: none;
  color: white;
  cursor: pointer;
  height: 30px;
  width: 100px;
}

#deathMenu button:hover {
  background: #777;
}

#playerLevel {
  font-size: 18px;
  margin-bottom: 5px;
}

#casinoMenu {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #222;
  border: 2px solid white;
  padding: 20px;
  z-index: 350;
  text-align: center;
  width: 400px;
}

#casinoMenu h3 {
  margin-top: 0;
}

#casinoMenu input[type="number"] {
  width: 80px;
  padding: 5px;
  margin: 10px 0;
}

#casinoMenu .cardButtons button {
  margin: 5px;
  padding: 15px 20px;
  font-size: 18px;
  background: #555;
  border: none;
  color: white;
  cursor: pointer;
}

#casinoMenu .cardButtons button:hover {
  background: #777;
}

#casinoMenu .smallButton {
  padding: 8px 15px;
  font-size: 14px;
  background: #666;
  border: none;
  color: white;
  cursor: pointer;
  margin-top: 10px;
}

#casinoMenu .smallButton:hover {
  background: #888;
}

#guildMenu.modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 350;
  background: rgba(0, 0, 0, 0.9);
  padding: 20px;
  border: 2px solid #fff;
  border-radius: 10px;
  width: 300px;
  text-align: center;
}

#guildMenu .modal-content {
  position: relative;
}

#guildMenu .close-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: #444;
  border: none;
  color: #fff;
  font-size: 16px;
  padding: 5px 10px;
  cursor: pointer;
}

#guildMenu .close-btn:hover {
  background: #666;
}

#guildMenu .guild-buttons button {
  margin-top: 30px;
  padding: 10px 20px;
  background: #555;
  border: 2px solid black;
  color: #fff;
  cursor: pointer;
}

#guildMenu .guild-buttons button:hover {
  background: #777;
}

#libraryMenu {
  position: fixed;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 400px;
  height: 100vh;
  background: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 15px;
  border: 2px solid #888;
  border-radius: 8px;
  z-index: 400;
  overflow-y: auto;
}

#libraryMenu .tabs {
  text-align: center;
  margin-bottom: 10px;
}

#libraryMenu .tabs button {
  padding: 5px 10px;
  margin: 0 5px;
  cursor: pointer;
  background: #555;
  border: 2px solid black;
  color: white;
}

#libraryMenu .tabs button:hover {
  background: #777;
}

#libraryMenu .content.scrollable {
  max-height: 300px;
  overflow-y: auto;
  font-size: 14px;
  line-height: 1.4;
  margin-bottom: 10px;
}

#exitLibrary {
  display: block;
  margin: 0 auto;
  padding: 5px 10px;
  cursor: pointer;
  background: #555;
  border: none;
  color: white;
}

#exitLibrary:hover {
  background: #777;
}

#sellMenu {
	display: none;
     position: absolute;
     top: 50%;
     left: 50%;
     transform: translate(-50%, -50%);
     background: #222;
     border: 2px solid white;
     padding: 20px;
     z-index: 260;
     width: 300px;
}

#equipmentBtn {
  position: absolute;
  top: 320px;
  right: 1250px;
  width: 100px;
  height: 100px;
  background: gray;
  border: 2px solid white;
  display: none;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 40;
  transition: background 0.2s;
}

#equipmentBtn:hover {
  background: rgba(255, 255, 255, 0.1);
}

#equipmentBtn img {
  width: 90px;
  height: 90px;
}

#equipmentMenu.modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.9);
  border: 2px solid white;
  padding: 20px;
  border-radius: 8px;
  z-index: 650;
  width: 300px;
  color: white;
}

#equipmentMenu .modal-content {
  position: relative;
}

#equipmentMenu .close-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  background: #444;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
}
#equipmentMenu #equipmentSlots {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 20px;
}
.equipmentSlot {
  border: 1px solid #777;
  padding: 8px;
  position: relative;
  cursor: pointer;
}
.equipmentSlot .slot-label {
  font-weight: bold;
}
.equipmentSlot .unequipBtn {
  position: absolute;
  top: 4px;
  right: 4px;
  background: #555;
  border: none;
  color: white;
  font-size: 14px;
  padding: 2px 6px;
  cursor: pointer;
  display: none;
}
.equipmentSlot:hover .unequipBtn {
  display: block;
}

@keyframes zoomBeat {
  0%   { transform: scale(1); }
  25%  { transform: scale(1.05); }
  50%  { transform: scale(1); }
}

@keyframes zoomBeatShop {
  0%   { transform: translate(-50%, -50%) scale(1); }
  25%  { transform: translate(-50%, -50%) scale(1.025); }
  50%  { transform: translate(-50%, -50%) scale(1); }
}

.jump-zoom-shop {
  animation: zoomBeatShop 0.33s infinite;
  transform-origin: center center;
}

.jump-zoom-gojira {
  animation: zoomBeat 0.475s infinite;
  transform-origin: center center;
}

#wishMenu {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
}
#wishMenu .modal-content {
  background: #222;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
}

#wishMenu button {
 margin: 8px;
 padding: 10px 16px;
}

#tooltip {
  position: absolute;
  pointer-events: none;
  background: rgba(0,0,0,0.75);
  color: #fff;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 0.9rem;
  z-index: 9999;
  display: none;
  white-space: normal;
}
    </style>
  </head>
  <body>
  
  <div id="loadingScreen">
	<div class="loading-text">Loading Assets<span id="dots"></span></div>
  </div>
  
    <!-- Title Screen -->
    <div id="titleScreen">
  <div id="titleBox">
    <img id="gameIcon" src="roguelikeicon.png" alt="Roguelike! Single File">
    <h1>Roguelike! Single File</h1>
    <p>
      From a weak, random nobody in this mysterious world of monsters, to an overpowered, monster slayer razing through crowds of demons. With an unlimited amount of potential, journey through this mysterious world, get stronger, grind for new items and equipment, fight your way through endless waves of monsters, and battle the gods that sent you to this hellhole!
    </p>
    <button id="playButton" style="display: none;">Start Game</button>
	<p>(Press/click anywhere to begin)</p>
	<div id="creditsToggle" style="cursor:pointer;" onclick="toggleCredits()">Credits</div>
	</div>
  <div id="creditsCredits">
    <div id="contentCredits" class="content scrollable">
      <h1><strong>☆Credits☆</strong></h1>
	  <br>
	  ===============================================
	  <br>
	  <br>
      <p><strong>Creator:</strong><br><br>Gabriel A. Barabar</p>
	  <br>
	  --------------------------------------------------------------------------------
	  <br>
	  <p><strong>Inspired by:</strong>
		<br>
		<br>
		<br>
		Pokémon
		<br>
		<br>
		Exp Minima
		<br>
		<br>
		Dragon Ball
		<br>
		<br>
		Solo Leveling
		<br>
		<br>
		Daniel Krafft - "They Dared Me to Make a Minecraft Mod..."
		<br>
		<br>
		The DOOM franchise
		<br>
		<br>
		Soul Knight
		<br>
		<br>
		<br>
	  </p>
	  --------------------------------------------------------------------------------
	  <br>
	  <p>
		<strong>Used Songs:</strong>
		<br>
		<br>
		<br>
		"Empty Town (Remix Cover)" - Vetrom
		<br>
		<br>
		"Heroes Avatar" - Soul Knight OST
		<br>
		<br>
		"in case..." - BiSH
		<br>
		<br>
		"Poke Mart Remix" - Qumu
		<br>
		<br>
		"The End Begins" - GOW2
		<br>
		<br>
		"Iron Will Braves The Waves/Neo Isle" - Soul Knight OST
		<br>
		<br>
		"Chairman Rose Battle (Orchestral Arrangement)" - Minako Adachi, Go Ichinose
		<br>
		<br>
		"Volo Battle (Cover)" - Master of Sounds
		<br>
		<br>
		"Interdimensional Summit" - Dimmu Borgir
		<br>
		<br>
		"The Only Thing They Fear Is You" - Mick Gordon
		<br>
		<br>
		"Tuca Donka" - CURSEDEVIL, DJ FKU, Skorde
		<br>
		<br>
		"Trippin on Love" - Ashley Collins
		<br>
		<br>
		"Admiring You (Private Pure Love Train)" - Pharozen
		<br>
		<br>
		"Explorer" - AXS Music
		<br>
		<br>
		"Chisel Town" - Soul Knight OST
		<br>
		<br>
		"Tundra" - Skyrim OST
		<br>
		<br>
		"Desert Caravans" - Derek Fiechter
		<br>
		<br>
		"God Only Knows" - A-One
		<br>
		<br>
		"VS Team Sky" - Sobanoodles
		<br>
		<br>
		"Spider Dance (Lo-fi Remix)" - KaatuWaves
		<br>
		<br>
		"Judas" - Lady Gaga
		<br>
		<br>
		"Self-Embodiment of Perfection" - Alisa Okehazama
		<br>
		<br>
		"伏魔御廚子(Malevolent Shrine)" - Yoshimasa Terui
		<br>
		<br>
		<br>
		Along with many other free music on YouTube...
		<br>
		<br>
	  </p>
	  --------------------------------------------------------------------------------
	  <br>
	  <p><strong>Special Thanks:</strong>
	  <br>
	  <br>
	  <br>
	  Tiffany G. Sanchez <br><strong>(My beloved girlfriend that inspired me to keep going💪)</strong>
	  <br>
	  <br>
	  Prince Jayrick Belmes <br><strong>(Tester)</strong>
	  <br>
	  <br>
	  Jian Carmelo Dellosa <br><strong>(Tester)</strong>
	  <br>
	  <br>
	  Candice Ariane T. Babaylan <br><strong>(Tester and emotional support)</strong>
	  <br>
	  <br>
	  -The entirety of Arts/Dibuho Club <br><strong>(Testers)</strong>
	  <br>
	  <br>
	  Gabryll Vynn C. Asuncion <br><strong>(tester.)</strong>
	  </p>
	  <br>
	  --------------------------------------------------------------------------------
	  <br>
	  <br>
	  <p><strong>Project Started on:</strong><br><br>April 3, 2025</p>
	  <br>
	  --------------------------------------------------------------------------------
	  <br>
	  <br>
	  <br>
	  <p>Roguelike! Single File</p>
	  <br>
	  <br>
	  ===============================================
	  <br>
	  <h2><strong>☆Thank you, everyone! And please enjoy the game.☆</strong></h2>
    </div>
	<br>
	<button id="exitCredits">Back</button>
</div>
  </div>
  
<div id="doomTitleScreen" style="display:none;">
  <div id="doomTitleContent">
    <img src="doomtitle.png" alt="DOOM" id="doomTitleImg">
	<p>ROGUELIKE! SINGLE FILE VERSION</p>
	<br>
	<br>
	<br>
	<br>
	<br>
	<br>
	<br>
	<br>
	<button id="beginJourneyBtn">BEGIN JOURNEY</button>
  </div>
</div>

<div id="difficultyMenu"
     style="display:none;
            position:fixed;
            top:50%; left:50%;
            transform:translate(-50%,-50%);
            background: rgba(0,0,0,0.85);
            padding: 20px;
            border: 2px solid white;
            border-radius: 10px;
            z-index: 900;
            max-width: 800px;">
  <h2>Select Gamemode</h2>
  Difficulties:
  <br>
  <button id="normalBtn" data-tooltip="The 'easiest' difficuly in the game for loser ahh beginners.">Normal</button>
  <button id="hardBtn" data-tooltip="The base game.">Hard</button>
  <button id="extremeBtn" data-tooltip="More difficulty, more fun!">Extreme</button>
  <button id="insaneBtn" data-tooltip="Think you're so badass? Go for it.">Insane</button>
  <button id="calamityBtn" data-tooltip="Terraria reference?.">Calamity</button>
  <br>
  <br>
  Other Modes:
  <br>
  <button id="bossRushBtn" data-tooltip="Slay Legend after Legend, Titan after Titan, God after God in this legendary game mode for the strong.">Boss Rush</button>
  <button id="ultimateBtn" data-tooltip="Peak.">Ultimate Edition</button>
  <button id="doomBtn" data-tooltip="Rule 666: If it exists, it can run DOOM.">
	<img src="doomtitle.png" alt="DOOM" id="doomModeButton">
  </button>
</div>

<div id="abilityMenu" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  background: rgba(0,0,0,0.85); padding: 20px; border: 2px solid white; border-radius: 10px; z-index: 900; max-width:800px;">
  <h2>Decide your Innate Abilities</h2>
  <div style="display:flex; flex-wrap: wrap; gap:20px;">
    <!-- Spin / selection section -->
    <div style="flex:1; min-width:300px;">
	  <br><br>
	  <p>Player Attribute: <span id="playerPassiveAbility">None</span></p>
	  <p>Player Skill: <span id="playerActiveAbility">None</span></p>
	  <br><br>
      <button id="spinAbilityButton">Spin Ability</button>
      <br><br>
      <button id="confirmAbilitiesButton" disabled>Begin Journey!</button>
    </div>
    <!-- Scrollable ability list section -->
    <div style="flex:1; min-width:300px; max-height:300px; overflow-y:auto; border: 1px solid white; padding: 10px; box-sizing: border-box;">
      <h3>Possible Attributes:</h3>
      <ul id="passiveAbilitiesList" style="list-style:none; padding:0; margin:0;"></ul>
      <hr style="margin:10px 0; border-color: white;">
      <h3>Possible Skills:</h3>
      <ul id="activeAbilitiesList" style="list-style:none; padding:0; margin:0;"></ul>
    </div>
  </div>
</div>


    <!-- Game Container (initially hidden until play button is pressed) -->
    <div id="gameContainer" style="display: none;">
      <div id="worldCounter"></div>
	  <br>
	  <div id="timerDisplay"></div>
	  <!-- Mission Display (HUD) -->
<div id="missionDisplay" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; font-size: 18px; color: white;"></div>
      <!-- Dynamic Map -->
      <div id="map"></div>
      <!-- Stats Panel -->
      <div id="stats">
        <div id="playerLevel">Player Level: 1</div>
	<div id="guildRankText"> Guild Rank: None </div>
		<div id="playerAbilitiesDisplay">
			Player Attributes: <span id="hudPlayerPassive">None</span>&nbsp;&nbsp;&nbsp;&nbsp;Player Skill (Press Q to use): <span id="hudPlayerActive">None</span>&nbsp;&nbsp;&nbsp;&nbsp;Weapon Skill (Press E to use): <span id="hudWeaponSkill">None</span>
		</div>
		<div class="barContainer"> Vitality/HP: <span id="hpText">100/100</span>
          <div class="hpBar">
            <div class="hpBarInner" id="hpBarInner"></div>
          </div>
        </div>
		<div class="barContainer"> Armor: <span id="armorText">20/20</span>
          <div class="armorBar">
            <div class="armorBarInner" id="armorBarInner"></div>
          </div>
        </div>
		<div class="barContainer"> Mana: <span id="manaText">10/10</span>
			<div class="manaBar">
				<div class="manaBarInner" id="manaBarInner"></div>
			</div>
		</div>
        <div class="barContainer"> EXP: <span id="expText">0/5</span>
          <div class="expBar">
            <div class="expBarInner" id="expBarInner"></div>
          </div>
        </div>
        <br>
        <div id="statsText"> Strength: <span id="attackStat">2</span>&nbsp; Durability: <span id="defenseStat">2</span>&nbsp; Magic: <span id="magicStat">2</span>&nbsp;&nbsp;&nbsp; $<span id="moneyStat">10</span>
           <br> Agility: <span id="agilityStat">1</span>&nbsp; Perception: <span id="perceptionStat">1</span>
	   <div id="miscStats">
	   Potential: <span id="potentialStat">1</span>&nbsp; Luck: <span id="luckStat">1</span>&nbsp; Fortune: <span id="fortuneStat">1</span>
	   </div>
        </div> Inventory: <div id="inventorySlots">
          <div class="inventorySlot"></div>
          <div class="inventorySlot"></div>
          <div class="inventorySlot"></div>
          <div class="inventorySlot"></div>
          <div class="inventorySlot"></div>
          <div class="inventorySlot"></div>
          <div class="inventorySlot"></div>
          <div class="inventorySlot"></div>
          <div class="inventorySlot"></div>
          <div class="inventorySlot"></div>
        </div>
      </div>
    </div>

    <!-- Battle Tint -->
    <div id="battleTint"></div>
    <!-- Battle Menu -->
    <div id="battleMenu">
      <div id="enemyInfo"></div>
      <div id="battleOptions">
        <button id="attackBtn">Attack</button>
        <button id="magicBtn">Spell</button>
		<button id="abilityBtn">Skill</button>
        <button id="itemsBtn">Items</button>
        <button id="runBtn">Run</button>
      </div>
    </div>
    <!-- Battle Log -->
    <div id="battleLog"></div>
    <!-- Inventory Menu -->
    <div id="inventoryMenu"></div>
    <!-- Level Up Menu -->
    <div id="levelUpMenu">
      <h3>Level Up! Choose a stat to increase:</h3>
      <button data-stat="hp">Vitality</button> HP: <span id="hpText">100/100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	  <br>
      <button data-stat="attack">Strength</button> Strength: <span id="attackStat">2</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	  <br>
      <button data-stat="defense">Durability</button> Durability: <span id="defenseStat">2</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	  <br>
      <button data-stat="magic">Magic</button> Magic: <span id="magicStat">2</span> - Mana: <span id="manaText">10/10</span>
	  <br>
      <button data-stat="agility">Agility</button> Agility: <span id="agilityStat">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	  <br>
      <button data-stat="perception">Perception</button> Perception: <span id="perceptionStat">2</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	  <div id="miscStats2">
      <button data-stat="potential">Potential</button> Potential: <span id="potentialStat">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	  <br>
      <button data-stat="luck">Luck</button> Luck: <span id="luckStat">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	  <br>
      <button data-stat="fortune">Fortune</button> Fortune: <span id="fortuneStat">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	  </div>
    </div>
	<!-- Equipment Button (next to other HUD controls) -->
  <button id="equipmentBtn">
    <img src="equipment.png" alt="Equipment" />
  </button>

  <!-- Equipment Menu -->
  <div id="equipmentMenu" class="modal" style="display: none;">
    <div class="modal-content">
      <button id="closeEquipmentBtn" class="close-btn">×</button>
      <h2>Equipment</h2>
      <div id="equipmentSlots">
        <div class="equipmentSlot" data-slot="weapon">
          <span class="slot-label">Weapon:</span>
          <span class="slot-item">Empty</span>
          <button class="unequipBtn" data-slot="weapon">×</button>
        </div>
        <div class="equipmentSlot" data-slot="armor">
          <span class="slot-label">Armor:</span>
          <span class="slot-item">Empty</span>
          <button class="unequipBtn" data-slot="armor">×</button>
        </div>
        <div class="equipmentSlot" data-slot="accessory">
          <span class="slot-label">Accessory:</span>
          <span class="slot-item">Empty</span>
          <button class="unequipBtn" data-slot="accessory">×</button>
        </div>
      </div>
    </div>
  </div>
  
    <!-- Shop Menu -->
    <div id="shopMenu">
      <h3>Shop</h3>
      <div id="shopItems"></div>
	  <br>
	  <button id="sellBtn">Sell</button>
      <button id="closeShopBtn">Close</button>
    </div>
	<div id="sellMenu">
  <h3>Sell Items</h3>
  <div id="sellItems"></div>
  <button id="closeSellBtn">Close</button>
</div>
    <!-- Death Menu -->
    <div id="deathMenu">
      <h2>You Died!</h2>
	  <button id="resurrectBtn" style="display:none;">I can’t give up…</button>
	  <br>
	  <br>
	  <button id="retryBtn">Retry</button>
    </div>
    <!-- Casino Menu -->
    <div id="casinoMenu">
      <h3>CASINO!</h3>
	  <ul>Gamble your life savings away or earn millions!</ul>
	  <br>
      <div>
        <strong>Enemy:</strong>
        <span id="casinoEnemyTotal">0</span>
        <br />
        <strong>Player:</strong>
        <span id="casinoPlayerTotal">0</span>
      </div>
      <div>
        <label for="betInput">Bet money:</label>
        <input type="number" id="betInput" min="1" value="1" />
        <button id="placeBetBtn">Place Bet</button>
      </div>
      <div id="casinoGameArea" style="display: none;">
        <div class="cardButtons">
          <button class="hitBtn">Hit</button>
          <button class="hitBtn">Hit</button>
          <button class="hitBtn">Hit</button>
          <button class="hitBtn">Hit</button>
        </div>
        <button class="smallButton" id="standBtn">Stand</button>
      </div>
    </div>
	<div id="guildMenu" class="modal" style="display: none;">
  <div class="modal-content">
    <button id="closeGuildMenu" class="close-btn">X</button>
    <h2><strong>GUILD</strong></h2>
    <div id="guildRankText"> Guild Rank: Newbie </div>
    <div class="guild-buttons">
      <button id="missionButton">Mission</button>
      <button id="hireMercenaryButton">Hire Mercenary</button>
	  <button id="libraryButton">Library</button>
    </div>
  </div>
</div>

    <div id="libraryMenu" style="display:none;">
	<p><strong>The Library</strong></p>
      <div class="tabs">
		<button id="tabGuide">Guild Guide Vol. 1</button>
		<button id="tabGuide2">Guild Guide Vol. 2</button>
        <button id="tabHistory">World History</button>
        <button id="tabPlayer">Valrr Human Anatomy</button>
        <button id="tabInnates">Innates</button>
		<button id="tabMonsters">Monster Encyclopedia</button>
		<button id="tabLegends">The Legends of Valrr</button>
		<button id="tabCrime">Case 001: The Restricted One (UNSOLVED)</button>
      </div>
	  <div id="contentGuide" class="content scrollable" style="display:none;">
		<h1><strong>Guild Guide Vol. 1</strong></h1>
		<p>Welcome to the Guild! In this book, we will teach you information, tips and tricks about and to help you in your journey on this world!</p>
		<h4>Tip 1 - Rooms</h4>
		<p>In the world of Valrr, there are numerous areas called "<strong>domains</strong>". These domains are lands ruled by a <strong>Legend</strong>, and if you're a warrior, you're definitely gonna want to go there and fight some monsters to get stronger.<br>However, you may also notice that some areas have things in them, while some don't, well, these are thingies called "<strong>Rooms</strong>". Rooms are areas that are marked by previous adventurers from the Guild there to mark what they're for.</p>
		<p>Here I will be explaining which rooms are which, and what they do: </p>
		<ul>
			<li><em><strong>Empty rooms</strong>: </em>Empty rooms are, well, empty. They've been marked as previous <em>Battle rooms</em> that have already been cleared, and are getting ready to get modified by the government and construction team into another room.</li>
			<li><em><strong>Battle/Monster rooms</strong>: </em>Battle rooms are areas that contain monsters for warriors to battle, kill, and train in.</li>
			<li><em><strong>Ambush rooms</strong>: </em>Ambush rooms are old empty rooms that have been unsupervised for a long time, therefore monsters have inhabited them once again, and monsters even take advantage of it to ambush warriors nearby, hence the name. So be careful whenever you find a suspiciously empty room, it might just be an Ambush room!</li>
			<li><em><strong>Trap rooms</strong>: Trap rooms are empty rooms that have been set up with traps for monsters, however, some warriors might walk into them instead of monsters, so majority have been removed. However, some trap rooms have still been unidentified, so be careful on yur journey!</em></li>
			<li><em><strong>Rest/Healing Zones</strong>: </em>Rest rooms, aka Healing Zones are rooms set up by the Guild construction teams to let warriors rest and recover their Strength, stamina and Mana.</li>
			<li><em><strong>Shop rooms</strong>: </em>Shop rooms are set up by the Guild contruction teams for warriors to rest once more and buy items and equipment to help them on their adventure.</li>
			<li><em><strong>Shrines</strong>: </em>Shrines were old buildings built by humans from the Modern era to pray to the gods for forgiveness during the Judgement era. However, the gods seem to have answered their prayers all these years later, as encountering these Shrines and praying to them give the warriors who do a powerful boost.</li>
			<li><em><strong>Loot rooms</strong>: </em>Loot rooms were once considered "dumps" by the first warriors, where they would just throw away the materials dropped from monsters since they didn't know what to do with them yet. However, nowadays, people refer to them as Loot rooms as those materials are valuable to us now. Some Loot rooms even contain old equipment from past warriors who wandered here.</li>
			<li><em><strong>Casino/Gambling rooms</strong>: </em>Casinos, or Gambling rooms, are illegal rooms created by businesspeople to make some extra cash in the middle of a domain. These are considered illegal as, A, they didn't get permission from the Guild, nor the government to have this built, B, they could possibly scam you of all of your valuables while you're out here in the middle of a domain, leaving you with nothing while there are monsters out and about, and C, these could risk the lives of warriors and adventurers, as monsters still lurk around these areas! So we recommend you do not go to these places.</li>
			<li><em><strong>Legend/Boss rooms</strong>: </em>Legend rooms, or Boss rooms, are considered the danger zone of all rooms, as these rooms are where a Legend rests. Adventurers who go here either just came to look, the ones who marked the rooms, or are challengers who never came back out.</li>
			<li><em><strong>The Guild</strong>: </em>Lastly, the Guild rooms, where all of our establishments are!</li>
		</ul>
		<h4>Tip 2 - Shop Stocks/Items</h4>
		<p>In your adventure, you might find Shop rooms or Loot rooms, as mentioned earlier, and in those rooms you might be able to obtain specific items to help you out on your journey.</p>
		<p>Here is the list of possible items you can obtain from these places, what prices they could sell for in the shops, and what they do: </p>
		<ul>
			<li><em><strong>Healing Potions</strong>: </em>Healing Potions are potions created with magic to recover warriors' stamina and Vitality when consumed. They cost $50 to buy in shops.</li>
			<br>
			<li><em><strong>Mana Potions</strong>: </em>Mana Potions are exactly like Healing Potions, but were made for the purpose of recovering Mana when consumed. They cost $50 to buy in shops.</li>
			<br>
			<li><em><strong>Iron Potions</strong>: </em>Iron Potions are potions that make warriors tougher and harder to take down for one battle when consumed. They cost $150 to buy in shops.</li>
			<br>
			<li><em><strong>Rage Potions</strong>: </em>Rage Potions are potions made to awaken your inner Rage, boosting your power greatly in exchange for your mentality for one battle when consumed. They cost $100 to buy in shops.</li>
			<br>
			<li><em><strong>Poison Potions</strong>: </em>Posion Potions are deadly potions that are meant to be thrown at enemies, not consumed. When thrown, the bottle will break and start poisoning the target, dealing constant damage to them. They cost $150 to buy in shops.</li>
			<br>
			<li><em><strong>Weaken Potions</strong>: </em>Weaken Potions are potions that, same as Poison Potions, are not meant to be consumed. When thrown, the bottle will break and the target will be slowed down and weakened. This costs $100 to buy in shops.</li>
			<br>
			<p>Equipment: </p>
			<ul>
				<p>Weapon-type: </p>
				<ul>
					<li><em><strong>Sword</strong>: </em>The essential to a warriors journey. An extension to the arm, to help slice apart monsters that get in your way. They cost $320 to buy in shops.</li>
					<br>
					<li><em><strong>Dagger</strong>: </em>The dagger is a small blade meant for easy-weilding. Light, yet sharp, it's perfect for agile warriors. They cost $320 to buy in shops.</li>
					<br>
					<li><em><strong>Spear</strong>: </em>The spear is a heavy weapon made for attack-type warriors. With precision, this weapon allows the user to hit targets from a distance with immaculate accuracy. They cost $360 to buy in shops.</li>
					<br>
					<li><em><strong>Greatword</strong>: </em>A powerful, but heavy weapon. This weapon was made for devastation, but makes the warrior's severely slower than others. They cost $360 to buy in shops.</li>
					<br>
					<li><em><strong>Gauntlets</strong>: </em>The gauntlets are modified gloves with armored plating, allowing Warriors, especially of the Berserker Attribute, to go ham in close combat. They cost $320 to buy in shops.</li>
					<br>
					<li><em><strong>Warhammer</strong>: </em>The warhammer is by far the most heavy, and devastating weapon built by mankind. A two-handed weapon that, with a single swing, can take out multiple enemies at once! They cost $500 to buy in shops.</li>
					<br>
					<li><em><strong>Shield</strong>: </em>The shield is a must-have on a Warrior's arsenal, allowing Warriors to block, defend, protect, or bash their way through foes. They cost $400 to buy in shops.</li>
					<br>
					<li><em><strong>Wand</strong>: </em>The wand is essential to a magic-type warrior, as it helps them focus their Magic into one spot, allowing for deadly spells to blow away foes. They cost $320 to buy in shops.</li>
					<br>
					<li><em><strong>Staff</strong>: </em>The staff is a powerful weapon, as it is just a wand, but exceptionally more powerful. In exchange for less mobility, warriors can become living cannons of magic with this weapon. They cost $360 to buy in shops.</li>
					<br>
					<li><em><strong>Gun</strong>: </em>A weapon from the modern era. It was invented to control other humans, not monsters, and is said to be so powerful, it can usually kill anything in one or two shots. However, nobody is sure how to even use them. They cost $1000 to buy in shops.</li>
					<br>
					<li><em><strong>Excalibur</strong>: </em>A mythical weapon from legend, said to only exist in fiction, specifically the stories of King Arthur. This weapon is the most powerful weapon of all, capable of slaying down any monster left and right. However, rumors say that this weapon actually does exist, no one just doesn't know where it is.</li>
					<br>
				</ul>
				<p>Armor-type: </p>
				<ul>
					<li><em><strong>Armor</strong>: </em>Armor, the default armor-type equipment, meant to simply help warriors who wear them resist more attacks, allowing them to last longer in battle to slay more enemies. They cost $300 to buy in shops.</li>
					<br>
					<li><em><strong>Cloak</strong>: </em>The Cloak is a unique type of armor, though weak, it allows warriors to be more agile and hidden in battle, like a ninja. They cost $280 to buy in shops.</li>
					<br>
					<li><em><strong>Robe</strong>: </em>The Robe is a special armor-type equipment built for magic-type warriors. Enchanted with magic, it increases a warrior's magical capacity and power. They cost $320 to buy in shops.</li>
					<br>
				</ul>
				<p>Accessory-type: </p>
				<ul>
					<li><em><strong>Scarf</strong>: </em>The scarf may seem like a simple cosmetic to you, but it actually has a special enchantment to help warriors be more agile in battle. They cost $300 to buy in shops.</li>
					<br>
					<li><em><strong>Glasses</strong>: </em>Ah yes, glasses, to help those with visual impairments see better, and to help warriors NEVER MISS ATTACKS. They cost $320 to buy in shops.</li>
					<br>
					<li><em><strong>Ring</strong>: </em>The ring, a famous piece of jewelry used in proposals, weddings, flexing, and for good luck! They cost $500 to buy in shops.</li>
					<br>
					<li><em><strong>Sharpener</strong>: </em>Sharpeners are not what you think. You might think they're for pencils, but these sharpeners are meant to sharpen your weapons and land critical attacks much easier. They cost $360 to buy in shops.</li>
					<br>
					<li><em><strong>Dice</strong>: </em>The... dice? This isn't officially sold by the Guild...? It seems like these are illegally sold by shops who work together or against Casinos, as Dices seem to help you cheat and guarantee a win in EVERY casino game. They apparently cost $1000 to buy in shops.</li>
					<br>
					<li><em><strong>Ammo Box</strong>: </em>A box filled with strange metallic objects. Created in the modern era, these objects are supposed to go into something, but nobody knows what. They cost $500 to buy in shops.</li>
					<br>
					<li><em><strong>Nike Black Air Force</strong>: </em>Sponsored by Nike themselves. These shoes are high-quality, limited edition shoes that are so powerful, it distorts space, time and reality, allowing warriors to move anywhere they want and find what they need. They cost $3000 to buy in shops</li>
				</ul>
			</ul>
		</ul>
		</div>
	  <div id="contentGuide2" class="content scrollable" style="display:none;">
		<h1><strong>Guild Guide Vol. 2</strong></h1>
		<p>Welcome to the Guild! In this sequel to the original, we will teach you even more information, tips and tricks about and to help you in your journey on this world!</p>
		<h4>Tip 1 - Builds</h4>
		<p>In this world, humans have thingies called Physical Attributes, or stats in simple terms.</p>
		<p>Warriors can upgrade their stats through battle, as warriors consumes the EXP that monsters drop. Once a warrior consumes enough, they "level up" in a way, and their Physical Attributes will rise depending on the way they fight, their style, and how they kill the monsters.</p>
		<p>Popular builds that people train for are usually: </p>
		<ul>
			<li><em><strong>Vitality Build</strong></em> - In this training course, warriors would just focus all of their training on their Vitality. This is a very good build for the early parts of your journey, as enemies are usually very weak then and with your base offensive stats alone, you can take them down. Just use this build and grind for items until you reach around he 30th floor, only then would I recommend you start increasing your offensive stats.</li>
			<li><em><strong>Tank Build</strong></em> - With this, warriors would priorotize training their Durability, allowing them to take more attacks as if they were nothing. When it's great enough, warriors could become practically INVINCIBLE.</li>
			<li><em><strong>Potential Build</strong></em> - With this training, warriors would focus all of their training into their Potential. This way, warriors would grow way faster and way more than they need to. In fact, with this build, warriors could "level up" with only a single battle every time once their Potential has reached high enough, then they could start investing in their other stats and get stronger exponentially.</li>
			<li><em><strong>One Punch Build</strong></em> - Berserker-innate warriors usually go for this build, where all of their training is just focused into their Strength. With this, despite the enemies being way stronger than the player, one Attack should be enough for everyone in your way.</li>
			<li><em><strong>One Spell Build</strong></em> - This is basically just the One Punch Build but with the Magic attribute. This is much more recommended as Spells deal exponentially more damage than physical Attacks. The only problem with spellcasting really is that it costs mana.</li>
			<li><em><strong>Ultra Instinct Build</strong></em> - This build is better later on, when your stats are enough to deal with the current monsters that you'll deal with. Once they do, you should just begin investing all of your training into Agility, and soon, you'd dodge ALL of your enemys attacks, no matter what.</li>
			<li><em><strong>Sniper Build</strong></em> - This is just the Ultra Instinct Build but with Perception instead. Once your Perception is enough, you can guarantee Critical Attacks each and every time.</li>
			<li><em><strong>Millionaire Build</strong></em> - If you wanna grind money fast, this is the way. Focus all of your training into Fortune, and you might become a millionaire within the first 50 floors.(Tested) However, this is VERY not recommended early on, as you would get decimated with your "Level 1 Stats".</li>
		</ul>
		<h4>Tip 2 - Monster Growth</h4>
		<p>In this world, as you may know, you grow stronger as you kill, all humans do. However, did you know monsters are growing too?</p>
		<p>Monsters in this world, aren't just braindead monsters that chase after you and crash into walls, no. Monsters are like humans, they're smart, they can grow, and they can evolve.</p>
		<p>But monsters don't grow stronger in the way you might think. Unlike us humans, that grow over time as we train and fight, monsters don't grow that way, instead, they grow in strength as new monsters are born. As ever since around 1000 years ago, when humanity finally came out of hiding and got stronger, the gods also "buffed" the monsters by making them smart, and allowing them to get stronger depending on the person that slayed them.</p>
		<p>When a monster dies, they don't decay, instead, they turn into materials, unbelievable, right? Well, only if you're not a warrior.<br> After that, the monster's soul is then reincarnated into a new body, which is much, much stronger than before, and it's the killer's strength that is added onto them.</p>
		<p>So basically, if the world gets stronger, so will the monsters, and if the monsters are getting stronger, the humans should too. It's a constant power creep that we just can't stop, and we'll have to keep going if we want to pass this "Trial" that the gods have set up for us.</p>
	  </div>
      <div id="contentHistory" class="content scrollable">
		<h1><strong>"The Story of Valrr"</strong></h1>
		<h5>The History of a post-modern, medieval planet of magic, monsters and gods.</h5>
		<br><br>
		<strong>Chapter 1 - Cause</strong>
		<br><br><br>
		This world was once peaceful, known as Earth, and we were once very technologically advanced. 
		<br><br>However, one day, something occurred. A terrible, terrible event, known as "Judgement Day". What we once assumed was one God, turned out to be multiple, as numerous titanic entities appeared out of nowhere in the sky. One was as dark as the voids of space, one shined as brightly as the brighest star, one was wise in appearance, and one stood below them all... a Demon. However, the one that caught everyone's eye, was the one stood high above everything, everyone, everywhere else. <br><br>The one standing in the middle began speaking, saying something like, 
		<br><br>
		"<strong>Humans, thou all hast failed us for the last time. <br>'tis  finally time for thou all to repent for thy sins.</strong>" 
		<br><br>
		Then, the gods vanished, beginning the Judgement era of humanity.
		<br><br><br> 
		<strong>Chapter 2 - Effect</strong> 
		<br><br>
		Humanity panicked, society went into chaos. Scientist quickly began rushing to build spaceships to fly us all out of here, but it only resulted in failure, as the worldwide economy crashed down on itself. Every government in the world also began crashing down, the military began blindly launching missiles in the sky as if it would do something, backfiring horribly as it all launched back down on other countries. The world fell into a huge war, destroying itself, slowly but surely. 
		<br><br>
		5 years into the war, the world realized, 5 years passed after the gods appeared, yet, nothing happened. Were we played? Were we fooled? Is this their form of judgement? 
		<br><br>
		The war stopped abruptly as soon as they all found this out, all governments of the world quickly going to peace to work together, to try and fix this whole mistake. 
		<br><br>
		However, the damage was done, the planet was in ruins, and it would take 1000 years to bring it all back. The modern era was over...
		<br><br><br> 
		<strong>Chapter 3 - Aftershock</strong> 
		<br><br>
		A decade passed since the war, humanity tries to put itself back together, thinking the problem was over, as the gods that appeared all those years ago have not made a single move since then. <br><br>However, just when humanity though they were back in the game. Boom. The gods reappeared, saying, 
		<br><br>
		"<strong>Humans, thou hast passed the first trial, but 'tis isn't over yet. It is finally time for thy second trial. <br>When thou art all complete, thou all shall find us, meet us, and bargain.<br>Maybe then, thy judgement shall finally be over.</strong>" 
		<br><br> 
		The gods say once more, as portals suddenly began appearing all over the world, as powerful monsters began coming out of them. 
		<br><br>
		The military tried to shoot them all down, and it worked. Monsters were falling down one by one with each shot. However, they also began getting back up, as humans also realized they all had multiple of each vital organs, and even got stronger each time they did. 
		<br><br>
		Humanity then also tried bombing them, but more and more monsters kept coming back out of the portal, more than what was even being killed. <br><br>So then, humanity, surrendered...<br><br><strong>Chapter 4 - The Return</strong>
		<br><br>
		We all went into hiding for the next hundred years, before rising back up another hundred years later. Humanity was back to where we were before all the technology, as we tried to redo all of our progress when in hiding, but due to the lack of resources, and how humans have relied too much on our own tech and AI, we fell back down and had to start from scratch. When we returned to the surface, we found that all of the portals around the world have closed, but monsters were now everywhere, and were exponentially stronger than they were before. Humanity knew we were ruined. 
		<br><br>
		However, one day, another thing occurred... the gods have given the humans, a chance to fight back. 
		<br><br>
		Humans all over the world began getting stronger, faster, and better. People could cast magic, and best of all, humans gained powerful abilities what we call, "Innates". These innates varied, from superhuman strength, to powerful unique abilities that only those humans can have. 
		<br><br>
		Humans started fighting back, with those who do being called "<strong>Warriors</strong>" able to even kill monsters with their bare fists. Monsters also dropped strange materials, some were nothing, so humans made them into currency, and another thing, which us humans called EXP(similar to video games in the Modern era), made humans grow stronger when touched, as they seemed to dissolve. Humans began making businesses with the new monster currency, which was stilled named Dollars($) after the most prominent type of currency in the Modern era, to help the warriors who kills the monsters; weapons, armor, equipment, sold all over the world as we all got even stronger and stronger. 
		<br><br>
		Humanity was back, in fact, humans got so strong, and were killing the monsters faster than we could ever imagine, the worldwide monster population fell by 5% in 2 weeks. 
		<br><br><br>
		<strong>Chapter 4 - Monsters</strong>
		<br><br>
		However, the gods didn't just idle around, watching this all go down. We passed our second trial, as the gods quickly began the third. The gods made the monsters evolve exactly as animals do. The monsters grew reproductive organs, they gained sentience, and they evolved, at a matching rate as the humans did. 
		<br><br>
		With that, Legends were born. Powerful, gigantic monsters that lived in a certain part of the world called a domain. These Legends lived in their domains and guarded them, protecting the monsters that lived with them. Monsters all around the world also began living in certain domains, to gain the protection of their own legend. And so, the monsters started the monster society, and humanity was basically at war with them. 
		<br><br>
		And all that, leads to where we are now. The planet was named Valrr by the new governments, who were once kids that loved playing the video games that we managed to salvage from the Modern era, and thought that it sounded like a fantasy game, and it was named after the word, valor, to encourage, motivate and inspire the warriors who fight for us against the monsters.
		<br><br><br><br>
		Legends state that someday, an entity from a world beyond our own will appear and save us from all the monsters, become stronger than anything our world has ever seen, fight back against the gods that have damned us all, and finally free us from this eternal torture that they call "Trials".
		<br><br><br><br>
		<h2><strong>-END-</strong></h2>
	  </div>
      <div id="contentPlayer" class="content scrollable" style="display:none;">
		<h1><strong>The Human Physical Attributes</strong></h1>
        <p>The human being, otherwise known as the Homo sapien, were once nothing but slightly more advanced animals. However, ever since 1000 years ago, humans gained many new attributes and abilities, which allowed every human to get stronger and fight back the monsters that rampage this world.<p>
		<p>Humans have 9 main physical attributes that can grow if they absorb enough EXP from monsters:</p>
		<ul>
        <li><em><strong>Vitality</strong>:</em> Vitality seems to increase a human's will, stamina, and basically, how long they can last in battle.</li>
        <br>
		<li><em><strong>Strength</strong>:</em> Strength increases the human's power, allowing a single human to carry hundreds of kilograms, and possibly launch a monster dozens of feet away with a single blow.</li>
        <br>
		<li><em><strong>Durability</strong>:</em> Durability allows the human's toughness to increase greatly. This also increases a warrior's ARMOR, allowing them to take more hits with more ease.</li>
        <br>
		<li><em><strong>Magic</strong>:</em> Magic allows a human to conjure up spells, and even use their Innate. However, there's also a thing called <strong>mana</strong>, which limits the amount of magic a human can use. The more magic a human has, the stronger they get, and the more spells they can cast, and the more mana they have.</li>
        <br>
		<li><em><strong>Agility</strong>:</em> Agility allows the human being to move around more easily, increasing their senses to, at some point, see in slow motion.</li>
		<br>
		<li><em><strong>Perception</strong>:</em> Perception allows the human being to also increase their senses, thinking speed, etc. Basically allowing one to "see through" others with their mind, find the <strong>weak points</strong> of things, and find ways to deal with problems quicker.</li>
        <br>
		<li><em><strong>Potential</strong>:</em> Potential seems to decide how humans grow. Some people have greater potential, therefore allows them to get much stronger, smarter, etc., much faster.</li>
        <br>
		<li><em><strong>Luck</strong>:</em> Luck is a unique attribute that humans once thought was only a concept, but has now been found to be real. The more luck a human has, well, the luckier they are. Finding "good" things much more easily, and take advantage of coincidence.</li>
        <br>
		<li><em><strong>Fortune</strong>:</em> Fortune is pretty much just Luck, but affects money, or something.</li>
      </ul>
      </div>
      <div id="contentInnates" class="content scrollable" style="display:none;">
		<h1><strong>Innate Attributes and Skills</strong></h1>
        <p>The human being, otherwise known as the Homo sapien, were once nothing but sentient animals with slightly more intelligence than others. However, ever since 1000 years ago, humans gained something called "Innates", which allowed humans to use powerful unique Skills, and have unique physical Attributes to help fight against the monsters that ruined everything. However, 40% of humans around the world still don't seem to have Innates, so they're just meant to live life in their homes, while others still choose to be warriors that fight for us all.</p>
		<p>Humans currently have 12 known unique attributes that have been scientifically proven that people have, with some, most people have, and some, only 1 in a billion have: <p>
		<ul>
			<li><em><strong>Tough</strong>: </em>People with this attribute are usually more tougher to deal with and take down, with them only taking half as much damage as normal people do.</li>
			<br>
			<li><em><strong>Quick</strong>: </em>People with this attribute are usually a lot faster than others, think a lot faster, move a lot faster, and do everything a lot faster. So they're usually the most arrogant in battle, as they are basically uncatchable.</li>
			<br>
			<li><em><strong>Reckless</strong>: </em>People with this attribute are usually a lot more wild than others, as people with this attribute rush straight into battle. Although they are known to be extremely powerful, they're also known to be killed in battle the most.</li>
			<br>
			<li><em><strong>Berserker</strong>: </em>People with this attribute are known to be extremely powerful, with unimaginable strength, incomparable to others. They're known to take down waves of monsters by themselves, with their bare hands.</li>
			<br>
			<li><em><strong>Arcane</strong>: </em>People with this attribute are known to be extremely prominent in magic, with them even having a nigh-endless amount of mana, being able to cast more and more spells than any others.</li>
			<br>
			<li><em><strong>Hunter</strong>: </em>People with this attribute are known to be more silent, observant, and more critical in battle. With the natural instinct to strike from behind, these guys are known to finish battles off quickly, and silently.</li>
			<br>
			<li><em><strong>Golden</strong>: </em>People with this attribute are known to... well, shine like gold. Golden people usually gain more of the currency material in battle, for some reason, and are also known to finish battles with a bang. These guys are also literally made of gold, so they are stronger, and tougher than normal people.</li>
			<br>
			<li><em><strong>Big</strong>: </em>People with this attribute are usually known to be... well, big. They're stronger, tougher, and more powerful than normal people, however, with their size, also comes mass, forcing all Big people to be slower.</li>
			<br>
			<li><em><strong>Fighting Spirit</strong>: </em>People with this attribute are known to fight until the very end. With a unique ability to get stronger as they keep fighting, people with the Fighting Spirit always make one hell of a last stand whenever they know they can't take it anymore, giving every Fighting Spirit warriors titles as Legends in this world.</li>
			<br>
			<li><em><strong>Adaptable</strong>: </em>People with this attribute are known to be literally invincible. With each battle, despite being completely outmatched, always find a way around and win. Hell, they grow much faster than others too.</li>
			<br>
			<li><em><strong>Invincible</strong>: </em>People with this attribute can never be killed. They're the type to run into battle and come out completely unscathed. People with this attribute are known to become exceptional warriors who will never fall in battle. All known Invincible-attributed people only died of old age and disease.</li>
			<br>
			<li><em><strong>Relentless</strong>: </em>People with this attribute are similar to those with the Reckless ability, however, their schtick is that... they're unstoppable. Once they rush into battle, there is no stopping them, even themselves. The only way for them to stop is if they manage to mess up their own attacks, like missing.</li>
			<br>
			<li><em><strong>Ambidextrous</strong>: </em>People with this attribute are usually very good at everything, especially strength and magic, using both with perfect synergy.</li>
			<br>
			<li><em><strong>Reflective</strong>: </em>People with this attribute are known to be very reflective of everything; physical changes, emotional changes, and more. In battle specifically, they're known to reflect damage back to opponents, perfect for tank-type warriors.</li>
			<br>
			<li><em><strong>Burning</strong>: </em>People with this attribute are hot, literally. Their skin is always on fire, and will want to spread fire to anything they touch. So usually, people with this attribute are very, very lonely, but are the most destructive ones.</li>
			<br>
			<li><em><strong>Aura Farmer</strong>: </em>People with this attribute are known to be very, very cool. They grow exponentially faster than everyone else, and are known to finish battles sending chills down everyone and everything's spines.</li>
			<br>
			<li><em><strong>Vessel</strong>: </em>It is said that one day, the King of Curses himself, Ryomen Sukuna, will return in the form of reincarnation into a worthy vessel. That day will be known as the end of the world.</li>
			<br>
			<li><em><strong>Six Eyes</strong>: </em>It is said that only a few people of this world from a specific clan can inherit this attribute. Those who do have this attribute are known to be the strongest in existence, allowing them to use any ability they want, and basically do anything with absolutely zero effort. The last known person of that clan was known as, "The Strongest", but he died a long, long time ago during the Modern era in a great battle, but legends say his spirit rose from the dead, got corrupted, and haunts the same place where he died, still with the same power that he once had.</li>
			<br>
			<li><em><strong>Immortal</strong>: </em>This attribute, as you can tell, allows people to live forever, and never die. It is a mythical attribute that only legends can have, in fact, it was theoretical until one person with it appeared, and changed everything forever. He is known popularly for this attribute, and that person is the head of the Guild himself, Gavin Andersonn. Gavin has lived for centuries, born around 600 years ago, he founded the guild when he was in his 30s, and he began the expedition to flag and identify every single domain that we know of today, identifying monsters, their physical capabilities and attributes, what they did, etc. He was also the first known warrior to fight a Legend and survive. He's also the one who created rooms in EVERY domain, ensuring that us humans could still find places to rest or live in peace even in such dangerous areas. Gavin is still alive and well today, of course, and is currently still out there, making more and more rooms for more warriors to explore.</li>
			<br>
			<li><em><strong>Heavenly Restricted</strong>: </em>This is an unconfirmed attribute, in fact, it isn't considered an attribute at all. Only one person in history was known to have this attribute. All that people know about this attribute, is that you'll get unimaginable strength, even greater than that of Berserkers, but absolutely zero Innate, magical, and growth potential whatsoever.</li>
		</ul>
		<p>Then, the one you've been waiting for... Innates! Innates are special abilities that were given to us by the gods 1000 years ago to help us fend off the monsters that they also sent to us as one of their "trials". Innates can do various different things, from boosting a human's physical abilities, to activating powerful attacks to decimate any foe in your way, but all Innates share one thing in common; they use up Mana, and a LOT of stamina. So you're gonna want to train up your Magic if you wanna use your Innates a lot, and be careful of when you want to use an Innate, since you can only use it once in battle.</p>
		<p>Many humans also seem to share an Innate ability, with some being more common in humans than others, and some being a lot rarer, with some only even being owned by one person, ever. Note that 40% of humanity also doesn't have Innates, but most still go to battle anyway, as most non-Innate users usually have very good Strength. But here, we will only explain the ones that have been proven to be owned by many people, along with SOME special Innates.<p>
		<ul>
			<li><em><strong>Rage</strong>: </em>This is known as "The Most Common Innate", as over 10% of all innate users basically own this Innate Skill. This Innate basically just increases the human's overall power, allowing them to rampage all around the battlefield, in exchange for their mentality.</li>
			<br>
			<li><em><strong>Strike</strong>: </em>This is another pretty common Innate, mostly used by physical-type warriors, allowing the human being to land one powerful strike.</li>
			<br>
			<li><em><strong>Blast</strong>: </em>This Innate is also pretty common. It's basically the magic counterpart to Strike, allowing the human to charge up their magic into one powerful spell to blast away foes.</li>
			<br>
			<li><em><strong>Dash</strong>: </em>This Innate is considered a very good Innate, as it drastically boosts a human's Agility, allowing them to move around much quicker when casted.</li>
			<br>
			<li><em><strong>Heal</strong>: </em>This Innate is very useful, and usually are meant for supporters in warrior teams, or by one-man-armies, as humans can use it as a quick way to recover when in battle.</li>
			<br>
			<li><em><strong>Fireball</strong>: </em>This Innate is a simple one, yet very powerful, in fact it's more like a spell than an actual Innate. Warriors cast a powerful fireball that will incinerate anything in its path.</li>
			<br>
			<li><em><strong>Freeze</strong>: </em>This Innate is yet another simple one, similar to the Fireball Innate. Warriors conjure up extremely cold, powerful winds that can freeze anything to its core.</li>
			<br>
			<li><em><strong>Thunderbolt</strong>: </em>This Innate is also another one like the Freeze, and Fireball Innate, completing the elemental trio, allowing Warriors to summon straight up lightning bolts from the sky to strike down foes and shock survivors.</li>
			<br>
			<li><em><strong>Acid Spit</strong>: </em>This Innate is, yet again, very simple. It allows warriors to, well, have highly acidic and poisonous spit, allowing them to melt through anything.</li>
			<br>
			<li><em><strong>Mesmerizing Voice</strong>: </em>This Innate is more like an Attribute, allowing people to have amazing voices, with main users of this Innate actually being entertainers instead of warriors, but is classified as an Innate due to it's special ability to manipulate its hearers to do what the user wants.</li>
			<br>
			<li><em><strong>Hunt</strong>: </em>This Innate is usually used by Hunter-type people, hence why it's called Hunt, as with a single Hunt, you can deal massive, critical damage to an enemy, and weaken them.</li>
			<br>
			<li><em><strong>Sacrifice</strong>: </em>This Innate is officially considered by the Guild and the government as a contraband innate. Anyone with this Innate is usually known to either be thrown in prison, or get told to never, in any circumstance, use their Innates. This Innate is rumored to allow warriors to gain extreme strength, in exchange for blood.</li>
			<br>
			<li><em><strong>Counter</strong>: </em>This Innate is a very powerful innate for how common it is, and allows warriors to counter damage back to the opponent with twice its power.</li>
			<br>
			<li><em><strong>Resurrection</strong>: </em>This Innate is known to be very rare, and users of this Innate are usually the greatest healers known to mankind, as they could heal anyone, even from the dead. However, if warriors use this on themselves, they're known to lose their Innate forever, as warriors can only resurrect themselves once.</li>
			<br>
			<li><em><strong>Maxima</strong>: </em>This Innate is considered one of the rarer Innates, and is considered one of the most powerful, as only the most powerful Magic-users can use this. Costing you an extra amount of Mana, using this charges up 200% of a user's Magical energy, and obliterating anything in your way once you launch the attack.</li>
			<br>
			<li><em><strong>Super Slash</strong>: </em>This Innate is also basically the physical-counter part of Maxima, used by physical-type warriors and blade users. When chanted, the human's striking arm's strength is boosted to it's limit, allowing a single strike, even by a hand, to tear through anything in its path.</li>
			<br>
			<li><em><strong>Blade of Gold</strong>: </em>This Innate was used by a Legendary Warrior around 300 years ago, who, with this Innate, striked down thousands of monsters with a single blow with a golden sword, created by this spell by fusing all of the user's gold and Dollars into a single weapon.</li>
			<br>
			<li><em><strong>Reversal</strong>: </em>This Innate allows warriors to deal devastating damage by transferring all damage dealt to the warrior back to the opponent.</li>
			<br>
			<li><em><strong>Shining Armor</strong>: </em>This Innate was used by another Legendary Warrior around 200 years ago, who, with this Innate, was known to be completely invincible, infusing all of their gold and Dollars into their armor.</li>
			<br>
			<li><em><strong>Switch</strong>: </em>This Innate is a very rare, ancient technique that has only appeared 4 times in the entirety of the Judgement era. This Innate allows warriors to unlock their "true self". However, only 1 of those 4 times was the warrior able to control their true self, as all other users would turn into a completely different person and go berserk.</li>
			<br>
			<li><em><strong>Infinity</strong>: </em>This Innate is from the same clan that can inherit the Six Eyes physical attribute, in fact, this ability is so powerful, only those with Six Eyes can fully master it. It is said that at its full potential, this ability can completely manipulate space to its will.</li>
			<br>
			<li><em><strong>Necromancy</strong>: </em>This Innate is currently theoretical, as there is currently no known user. However, it's still possible to be obtained by someone in the future, and it's been theorized by people that; whoever does manage to find an Innate like this, will be the one to save the world, and return Valrr to the glorious Earth that we once were, or further! This Innate would basically allow the user to resurrect any slain monster, and make it their own soldier to fight with them.</li>
		</ul>
	  </div>
	  <div id="contentMonsters" class="content scrollable" style="display:none;">
		<h1><strong>Monster Encyclopedia</strong></h1>
		<p>In this book, every known monster that exists in Valrr will be explained. Their names, calculated stats, categories, domains, resistances, etc.</p>
		<p><strong>Name:</strong> Goblin
		<br>
		<strong>Domain/s</strong>: Deep Forests, Deathly, Cliffs, Silkwoven Caverns, Archaic Caverns, Never-ending Tunnels, Molten Treasure Trove
		<br>
		<strong>Durability</strong>: ☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆
		<br>
		<strong>Resistance/s</strong>: None
		<br>
		<br>
		<strong>Name</strong>: Wolf
		<br>
		<strong>Domain/s</strong>: Deep Forests, Deathly Cliffs, Shi Mountains, Ancient Kingdom
		<br>
		<strong>Durability</strong>: ☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: None
		<br>
		<br>
		<strong>Name</strong>: Bear
		<br>
		<strong>Domain/s</strong>: Deep Forests, Deathly Cliffs, Shi Mountains, Ancient Kingdom
		<br>
		<strong>Durability</strong>: ☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: None
		<br>
		<br>
		<strong>Name</strong>: Monster Crow
		<br>
		<strong>Domain/s</strong>: Deep Forests, Abandoned Graveyard, Deathly Cliffs, Bone Castle, Arcane Swamps, Sky Dimension, Molten Treasure Trove
		<br>
		<strong>Durability</strong>: ☆
		<br>
		<strong>Threat Level</strong>: ☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Demon Bat
		<br>
		<strong>Domain/s</strong>: Abandoned Graveyard, Bone Castle, Silkwoven Caverns, Arcane Swamps, Shi Mountains, Archaic Cavern, Sky Dimension, Molten Treasure Trove
		<br>
		<strong>Durability</strong>: ☆
		<br>
		<strong>Threat Level</strong>: ☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Zombie
		<br>
		<strong>Domain/s</strong>: Abandoned Graveyard, Bone Castle, Arcane Swamps, Scorching Desert, Never-ending Tunnels, Molten Treasure Trove
		<br>
		<strong>Durability</strong>: ☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆
		<br>
		<strong>Resistance/s</strong>: Magic
		<br>
		<br>
		<strong>Name</strong>: Skeleton
		<br>
		<strong>Domain/s</strong>: Abandoned Graveyard, Deathly Cliffs, Bone Castle, Arcane Swamps, Shi Mountains, Archaic Cavern, Scorching Desert, Never-ending Tunnels, Freezing Tundra
		<br>
		<strong>Durability</strong>: ☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Ghoul
		<br>
		<strong>Domain/s</strong>: Abandoned Graveyard, Bone Castle, Silkwoven Caverns, Arcane Swamps, Archaic Cavern, Sky Dimension, Molten Treasure Trove
		<br>
		<strong>Durability</strong>: ☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: All
		<br>
		<br>
		<strong>Name</strong>: Werewolf
		<br>
		<strong>Domain/s</strong>: Abandoned Graveyard, Bone Castle
		<br>
		<strong>Durability</strong>: ☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: None
		<br>
		<br>
		<strong>Name</strong>: Giant Spider
		<br>
		<strong>Domain/s</strong>: Abandoned Graveyard, Silkwoven Caverns, Arcane Swamps, Shi Mountains, Archaic Cavern, Never-ending Tunnels, Molten Treasure Trove
		<br>
		<strong>Durability</strong>: ☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: None
		<br>
		<br>
		<strong>Name</strong>: Giant Scorpion
		<br>
		<strong>Domain/s</strong>: Silkwoven Caverns, Scorching Desert
		<br>
		<strong>Durability</strong>: ☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: All
		<br>
		<br>
		<strong>Name</strong>: Possessed Armor
		<br>
		<strong>Domain/s</strong>: Bone Castle, Archaic Cavern, Freezing Tundra, Ancient Kingdom, 
		<br>
		<strong>Durability</strong>: ☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: All
		<br>
		<br>
		<strong>Name</strong>: Golem
		<br>
		<strong>Domain/s</strong>: Silkwoven Caverns, Shi Mountains, Archaic Cavern, Never-ending Tunnels, Freezing Tundra, Ancient Kingdom, Molten Treasure Trove
		<br>
		<strong>Durability</strong>: ☆☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Sandworm
		<br>
		<strong>Domain/s</strong>: Scorching Desert, Never-ending Tunnels
		<br>
		<strong>Durability</strong>: ☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: None
		<br>
		<br>
		<strong>Name</strong>: Vulture
		<br>
		<strong>Domain/s</strong>: Scorching Desert, Sky Dimension
		<br>
		<strong>Durability</strong>: ☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Ice Golem
		<br>
		<strong>Domain/s</strong>: Freezing Tundra
		<br>
		<strong>Durability</strong>: ☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Magic
		<br>
		<br>
		<strong>Name</strong>: Ice Spirit
		<br>
		<strong>Domain/s</strong>: Freezing Tundra
		<br>
		<strong>Durability</strong>: ☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: All
		<br>
		<br>
		<strong>Name</strong>: Snowman
		<br>
		<strong>Domain/s</strong>: Freezing Tundra
		<br>
		<strong>Durability</strong>: ☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: All
		<br>
		<br>
		<strong>Name</strong>: Frost Knight
		<br>
		<strong>Domain/s</strong>: Freezing Tundra
		<br>
		<strong>Durability</strong>: ☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: All
		<br>
		<br>
		<strong>Name</strong>: Piranha
		<br>
		<strong>Domain/s</strong>: The Black Sea, Vast Ocean
		<br>
		<strong>Durability</strong>: ☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Shark
		<br>
		<strong>Domain/s</strong>: The Black Sea, Vast Ocean
		<br>
		<strong>Durability</strong>: ☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Giant Albatross
		<br>
		<strong>Domain/s</strong>: Vast Ocean, Sky Dimension
		<br>
		<strong>Durability</strong>: ☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Cyborg Guard
		<br>
		<strong>Domain/s</strong>: Future Megalopolis
		<br>
		<strong>Durability</strong>: ☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: None
		<br>
		<br>
		<strong>Name</strong>: Drone
		<br>
		<strong>Domain/s</strong>: Future Megalopolis
		<br>
		<strong>Durability</strong>: ☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: None
		<br>
		<br>
		<strong>Name</strong>: Giant Robot
		<br>
		<strong>Domain/s</strong>: Future Megalopolis
		<br>
		<strong>Durability</strong>: ☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Cursed Spirit
		<br>
		<strong>Domain/s</strong>: Shinjuku, Shibuya
		<br>
		<strong>Durability</strong>: ☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Sorcerer
		<br>
		<strong>Domain/s</strong>: Shinjuku, Shibuya
		<br>
		<strong>Durability</strong>: ☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Shikigami
		<br>
		<strong>Domain/s</strong>: Shinjuku, Shibuya
		<br>
		<strong>Durability</strong>: ☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Imp
		<br>
		<strong>Domain/s</strong>: The Underworld, Hell
		<br>
		<strong>Durability</strong>: ☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Demon
		<br>
		<strong>Domain/s</strong>: The Underworld, Hell
		<br>
		<strong>Durability</strong>: ☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Magic
		<br>
		<br>
		<strong>Name</strong>: Archdemon
		<br>
		<strong>Domain/s</strong>: The Underworld, Hell
		<br>
		<strong>Durability</strong>: ☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: Magic
		</p>
	  </div>
	  <div id="contentLegends" class="content scrollable" style="display:none;">
		<h1><strong>Legends</strong></h1>
		<h5>The Kings and Queens of the Monster Society</h5>
		<br>
		<br>
		<p><strong>Name</strong>: Goblin King
		<br>
		<strong>Domain</strong>: Deep Forests
		<br>
		<strong>Durability</strong>: ☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: None
		<br>
		<br>
		<strong>Name</strong>: Mutant Zombie
		<br>
		<strong>Domain</strong>: Abandoned Graveyard
		<br>
		<strong>Durability</strong>: ☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Magic
		<br>
		<br>
		<strong>Name</strong>: Giant Lord
		<br>
		<strong>Domain</strong>: Deathly Cliffs
		<br>
		<strong>Durability</strong>: ☆☆☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Skeleton King
		<br>
		<strong>Domain</strong>: Bone Castle
		<br>
		<strong>Durability</strong>: ☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Spider Queen
		<br>
		<strong>Domain</strong>: Silkwoven Caverns
		<br>
		<strong>Durability</strong>: ☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: None
		<br>
		<br>
		<strong>Name</strong>: The Witch
		<br>
		<strong>Domain</strong>: Arcane Swamps
		<br>
		<strong>Durability</strong>: ☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Magic
		<br>
		<br>
		<strong>Name</strong>: Titan Golem
		<br>
		<strong>Domain</strong>: Shi Mountains
		<br>
		<strong>Durability</strong>: ☆☆☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: All
		<br>
		<br>
		<strong>Name</strong>: Wyvern
		<br>
		<strong>Domain</strong>: Archaic Cavern
		<br>
		<strong>Durability</strong>: ☆☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Giant Sandworm
		<br>
		<strong>Domain</strong>: Scorching Desert
		<br>
		<strong>Durability</strong>: ☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: None
		<br>
		<br>
		<strong>Name</strong>: Titanoboa Lord
		<br>
		<strong>Domain</strong>: Never-ending Tunnels
		<br>
		<strong>Durability</strong>: ☆☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: None
		<br>
		<br>
		<strong>Name</strong>: Abominable Snowman
		<br>
		<strong>Domain</strong>: Freezing Tundra
		<br>
		<strong>Durability</strong>: ☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆
		<br>
		<strong>Resistance/s</strong>: None
		<br>
		<br>
		<strong>Name</strong>: Omegalodon
		<br>
		<strong>Domain</strong>: The Black Sea
		<br>
		<strong>Durability</strong>: ☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Leviathan
		<br>
		<strong>Domain</strong>: Vast Ocean
		<br>
		<strong>Durability</strong>: ☆☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Angel
		<br>
		<strong>Domain</strong>: Sky Dimension
		<br>
		<strong>Durability</strong>: ☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Magic
		<br>
		<br>
		<strong>Name</strong>: Mega Meta Mecha Annihilator - Model: Ultima
		<br>
		<strong>Domain</strong>: Future Megalopolis
		<br>
		<strong>Durability</strong>: ☆☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Grand Knight
		<br>
		<strong>Domain</strong>: Ancient Kingdom
		<br>
		<strong>Durability</strong>: ☆☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: All
		<br>
		<br>
		<strong>Name</strong>: Six-Eyed Calamity
		<br>
		<strong>Domain</strong>: Shinjuku
		<br>
		<strong>Durability</strong>: ☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: All
		<br>
		<br>
		<strong>Name</strong>: The King of Curses
		<br>
		<strong>Domain</strong>: Shibuya
		<br>
		<strong>Durability</strong>: ☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: All
		<br>
		<br>
		<strong>Name</strong>: Hydra
		<br>
		<strong>Domain</strong>: Molten Treasure Trove
		<br>
		<strong>Durability</strong>: ☆☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Attack
		<br>
		<br>
		<strong>Name</strong>: Guardian of Hell, Cerberus
		<br>
		<strong>Domain</strong>: The Underworld
		<br>
		<strong>Durability</strong>: ☆☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Magic
		<br>
		<br>
		<strong>Name</strong>: Demon King
		<br>
		<strong>Domain</strong>: Hell
		<br>
		<strong>Durability</strong>: ☆☆☆☆☆☆
		<br>
		<strong>Threat Level</strong>: ☆☆☆☆☆
		<br>
		<strong>Resistance/s</strong>: Magic
		<br>
		<br>
		That is all as of now...
		<br>
		<br>
		</p>
	  </div>
	  <div id="contentCrime" class="content scrollable" style="display:none;">
		<h5>Case 001&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;November 28, 2301<br>Reporting Officer: Tony Flour&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Prepared by: Johnny Bread<br>Location of incident: Countrywide</h5>
		<br>
		<p>Name: Kyojiro Allista
		<br>
		Sex: Male
		<br>
		Age: 32
		<br>
		Height: 6'05"
		<br>
		Weight: 101kg
		<br>
		Innate: Unknown
		<br>
		<br>
		<p>This man has been charged with mass murder, mutilation, torture.<br>With an estimated kill count of over 378 warriors and warriors only, all in the span of 3 months, this man has only been slaughtering warriors who were adventuring. In the middle of battles, Allista would come out of nowhere and brutally murder them, and play with their corpses as if they're some toys.<br>Over 200 bodies of his victims were seen only near the forests, which is usually the first spot adventurers would go to. Some bodies were even found near the Shi Mountains, which is a very deadly place to be, indicating that this man is either a very strong warrior, or just en extremely powerful man with a special Innate.<br>However, when we captured him, we found out... he doesn't even have an Innate? When we left him alone and returned only a few minutes later to sounds of explosions and rumblings, only broken shackles and a hole in the wall was found.<br>Not a single trace of blood was found, and the way he broke through the walls and escaped the shackles was extremely clean, and there was no sign of struggle. There was no sign of Magic anywhere either, which only further indicates that this man was exceptionally strong.<br>Not a few minutes later, some of my partners called from one of our stations a few cities away, and they reported sighting Allista walking through the streets.<br>This man is a serious threat to society and mankind and has to be dealt with immediately.<br><br> Sentence: <strong>Death</strong></p>
	  </div>
      <button id="exitLibrary">Exit</button>
    </div>
	
	<div id="wishMenu" style="display:none;">
  <div class="modal-content">
    <h2>Congratulations. You have found all 7 Dragon Balls. I will now grant you One Wish.</h2>
    <button id="wishPowerBtn">Power</button>
	&nbsp;
    <button id="wishRichesBtn">Riches</button>
	&nbsp;
    <button id="wishFameBtn">Fame</button>
  </div>
</div>
	
    <script>
      // Simple title screen functionality
      document.getElementById("playButton").addEventListener("click", function () {
  document.getElementById("titleScreen").style.display = "none";
  document.getElementById("difficultyMenu").style.display = "block";
  document.getElementById("abilityMenu").style.display   = "none";
  battleTint.style.display = "block";
});

	 function toggleCredits() {
      var guide = document.getElementById("creditsCredits");
      if (guide.style.display === "none" || guide.style.display === "") {
        guide.style.display = "block";
      } else {
        guide.style.display = "none";
      }
    }
	
	/*******************
       * GAME VARIABLES
       *******************/
      const roomSize = 110;
      const mapDiv = document.getElementById("map");
      const battleMenu = document.getElementById("battleMenu");
      const battleLog = document.getElementById("battleLog");
      const enemyInfo = document.getElementById("enemyInfo");
      const levelUpMenu = document.getElementById("levelUpMenu");
      const deathMenu = document.getElementById("deathMenu")
      const battleTint = document.getElementById("battleTint");
      const inventoryMenu = document.getElementById("inventoryMenu");
      const shopMenu = document.getElementById("shopMenu");
      const shopItemsDiv = document.getElementById("shopItems");
      const casinoMenu = document.getElementById("casinoMenu");
      const betInput = document.getElementById("betInput");
      const placeBetBtn = document.getElementById("placeBetBtn");
      const casinoGameArea = document.getElementById("casinoGameArea");
      const casinoEnemyTotalEl = document.getElementById("casinoEnemyTotal");
      const casinoPlayerTotalEl = document.getElementById("casinoPlayerTotal");
      const standBtn = document.getElementById("standBtn");
      const hitButtons = document.querySelectorAll(".hitBtn");
	  
	  let timerStart = 0;
	  let timerInterval = null;
	  let timerRunning = false;
	  let elapsedTime = 0;
	  
const tooltip = document.getElementById("tooltip") || (() => {
  const t = document.createElement("div");
  t.id = "tooltip";
  document.body.appendChild(t);
  return t;
})();

function showTooltip(html, e) {
  tooltip.innerHTML = html;
  tooltip.style.left    = `${e.pageX + 12}px`;
  tooltip.style.top     = `${e.pageY + 12}px`;
  tooltip.style.display = "block";
}
function hideTooltip() {
  tooltip.style.display = "none";
}
function attachTooltip(selector) {
  document.querySelectorAll(selector).forEach(el => {
    el.addEventListener("mouseenter", ev => {
      const html = el.dataset.tooltip;
      if (html) showTooltip(html, ev);
    });
    el.addEventListener("mousemove", ev => {
      tooltip.style.left = `${ev.pageX + 12}px`;
      tooltip.style.top  = `${ev.pageY + 12}px`;
    });
    el.addEventListener("mouseleave", hideTooltip);
  });
}

window.addEventListener("DOMContentLoaded", () => {
  const diffTips = {
    normal:    "The 'easiest' difficuly in the game for loser ahh beginners.",
    hard:      "The base game.",
    extreme:   "More difficulty, more fun!",
    insane:    "Think you're so badass? Go for it.",
    calamity:  "Terraria reference?",
    bossRush:  "Slay Legend after Legend, Titan after Titan, God after God in this legendary game mode for the strong.",
    ultimate:  "Peak.",
    doom:      "Rule 666: If it exists, it can run DOOM.",
  };

  Object.entries(diffTips).forEach(([key, tip]) => {
    const btn = document.getElementById(key + "Btn");
    if (btn) {
      btn.dataset.tooltip = tip;
    }
  });

  // finally, attach them
  attachTooltip(
    "#difficultyMenu button[data-tooltip], #doomTitleScreen #beginJourneyBtn",
    el => el.dataset.tooltip
  );
});
	  
	  function startTimer() {
		timerStart = Date.now();
		timerInterval = setInterval(updateTimer, 31);  // ~32fps is enough
		timerRunning = true;
	  }

	  function updateTimer() {
		elapsedTime = Date.now() - timerStart;
		const msTotal   = elapsedTime % 1000;
		const ms        = Math.floor(msTotal / 10);
		const totalSec  = Math.floor(elapsedTime / 1000);
		const sec       = totalSec % 60;
		const min       = Math.floor(totalSec / 60) % 60;
		const hr        = Math.floor(totalSec / 3600);

		const pad2 = n => n.toString().padStart(2, '0');
		const str  = `${pad2(hr)}:${pad2(min)}:${pad2(sec)}.${pad2(ms)}`;

		document.getElementById('timerDisplay').textContent = str;
	  }

	  function stopTimer() {
		clearInterval(timerInterval);
		timerRunning = false;
	  }
	  
	  const doomCoverImage = [
		"doomcover.jpg"
	  ];
	  
	  const doomTitleImage = [
		"doomtitle.png"
	  ];
	  
	  const sellBtn      = document.getElementById("sellBtn");
	  const sellMenu     = document.getElementById("sellMenu");
	  const sellItemsDiv = document.getElementById("sellItems");
	  const closeSellBtn = document.getElementById("closeSellBtn");
	  
	  const equipmentBtn       = document.getElementById("equipmentBtn");
	  const equipmentMenu      = document.getElementById("equipmentMenu");
	  const closeEquipmentBtn  = document.getElementById("closeEquipmentBtn");
	  
	  let preBattleStats = {};
	  
	  let gameDifficulty = "normal";
	  
	  const creditsToggle = document.getElementById("creditsToggle");
	  const creditsCredits = document.getElementById("creditsCredits");
	  const contentCredits = document.getElementById("contentCredits");
	  const exitCredits = document.getElementById("exitCredits");
	  
	  const BOSS_RUSH_INTERVAL = 3;
	  
	  exitCredits.addEventListener("click", () => {
		creditsCredits.style.display = "none";
	  });
	  
	  const libraryButton = document.getElementById("libraryButton");
	  const libraryMenu = document.getElementById("libraryMenu");
	  const exitLibrary = document.getElementById("exitLibrary");
	  const tabGuide  = document.getElementById("tabGuide");
	  const tabGuide2 = document.getElementById("tabGuide2");
	  const tabHistory = document.getElementById("tabHistory");
	  const tabPlayer = document.getElementById("tabPlayer");
	  const tabInnates = document.getElementById("tabInnates");
	  const tabMonsters = document.getElementById("tabMonsters");
	  const tabLegends = document.getElementById("tabLegends");
	  const tabCrime = document.getElementById("tabCrime");
	  const contentGuide = document.getElementById("contentGuide");
	  const contentGuide2 = document.getElementById("contentGuide2");
	  const contentHistory = document.getElementById("contentHistory");
	  const contentPlayer = document.getElementById("contentPlayer");
	  const contentInnates = document.getElementById("contentInnates");
	  const contentMonsters = document.getElementById("contentMonsters");
	  const contentLegends = document.getElementById("contentLegends");
	  const contentCrime = document.getElementById("contentCrime");
	  
	  let hasHistoryUnlocked = false;
	  let hasCrimeUnlocked = false;
	  let hasAmmoUnlocked = false;
	  let hasGunUnlocked = false;
	  let hasDragonBallUnlocked = false;
	  let hasExcaliburUnlocked = false;
	  let hasGrandUnlocked = false;
	  let hasPreviousUnlocked = false;
	  let hasStaffUnlocked = false;
	  let hasDragonUnlocked = false;
	  let hasNikeUnlocked = false;
	  let hasCrucibleUnlocked = false;
	  let hasPraetorUnlocked = false;
	  let hasBFG10000Unlocked = false;
	  let hasBFG9000Unlocked = false;
	  let hasArgentUnlocked = false;
	  let hasInfinityUnlocked = false;
	  let hasTitanUnlocked = false;
	  let hasJumpBootsUnlocked = false;
	  let hasMantleUnlocked = false;
	  let hasMechArmsUnlocked = false;
	  let hasMechArmorUnlocked = false;
	  let hasReactorUnlocked = false;
	  
libraryButton.addEventListener("click", () => {
  tabHistory.style.display = hasHistoryUnlocked ? "inline-block" : "none";
  tabCrime.style.display = hasCrimeUnlocked ? "inline-block" : "none";
  
  libraryMenu.style.display = "block";
  battleTint.style.display = "block";
});

exitLibrary.addEventListener("click", () => {
  libraryMenu.style.display = "none";
  battleTint.style.display = "none";
});

tabGuide.addEventListener("click", () => {
  contentGuide.style.display = "block";
  contentGuide2.style.display = "none";
  contentHistory.style.display = "none";
  contentPlayer.style.display = "none";
  contentInnates.style.display = "none";
  contentMonsters.style.display = "none";
  contentLegends.style.display = "none";
  contentCrime.style.display = "none";
});
tabGuide2.addEventListener("click", () => {
  contentGuide.style.display = "none";
  contentGuide2.style.display = "block";
  contentHistory.style.display = "none";
  contentPlayer.style.display = "none";
  contentInnates.style.display = "none";
  contentMonsters.style.display = "none";
  contentLegends.style.display = "none";
  contentCrime.style.display = "none";
});
tabHistory.addEventListener("click", () => {
  contentGuide.style.display = "none";
  contentGuide2.style.display = "none";
  contentHistory.style.display = "block";
  contentPlayer.style.display = "none";
  contentInnates.style.display = "none";
  contentMonsters.style.display = "none";
  contentLegends.style.display = "none";
  contentCrime.style.display = "none";
});
tabPlayer.addEventListener("click", () => {
  contentGuide.style.display = "none";
  contentGuide2.style.display = "none";
  contentHistory.style.display = "none";
  contentPlayer.style.display = "block";
  contentInnates.style.display = "none";
  contentMonsters.style.display = "none";
  contentLegends.style.display = "none";
  contentCrime.style.display = "none";
});
tabInnates.addEventListener("click", () => {
  contentGuide.style.display = "none";
  contentGuide2.style.display = "none";
  contentHistory.style.display = "none";
  contentPlayer.style.display = "none";
  contentInnates.style.display = "block";
  contentMonsters.style.display = "none";
  contentLegends.style.display = "none";
  contentCrime.style.display = "none";
});
tabMonsters.addEventListener("click", () => {
  contentGuide.style.display = "none";
  contentGuide2.style.display = "none";
  contentHistory.style.display = "none";
  contentPlayer.style.display = "none";
  contentInnates.style.display = "none";
  contentMonsters.style.display = "block";
  contentLegends.style.display = "none";
  contentCrime.style.display = "none";
});
tabLegends.addEventListener("click", () => {
  contentGuide.style.display = "none";
  contentGuide2.style.display = "none";
  contentHistory.style.display = "none";
  contentPlayer.style.display = "none";
  contentInnates.style.display = "none";
  contentMonsters.style.display = "none";
  contentLegends.style.display = "block";
  contentCrime.style.display = "none";
});
tabCrime.addEventListener("click", () => {
  contentGuide.style.display = "none";
  contentGuide2.style.display = "none";
  contentHistory.style.display = "none";
  contentPlayer.style.display = "none";
  contentInnates.style.display = "none";
  contentMonsters.style.display = "none";
  contentLegends.style.display = "none";
  contentCrime.style.display = "block";
});

let lastClickTime = 0;

document.addEventListener(
  "click",
  (event) => {
	if (event.target.closest("#guildMenu")) {
      return;
    }
    const currentTime = Date.now();

    // Check if 1 second (1000 ms) has passed since the last accepted click.
    if (currentTime - lastClickTime < 350) {
      // Prevent further processing of this click event.
      event.stopImmediatePropagation();
      event.preventDefault();
      return;
    }

    // If the cooldown period has passed, update the timestamp.
    lastClickTime = currentTime;
  },
  true // Use capture phase so that this check occurs before other click event listeners.
);

	  
	  const TITLE_MUSIC_BPM = 120;
	  const BEAT_INTERVAL_MS = (60 / TITLE_MUSIC_BPM) * 1000;
	  const doomMusicOptions = [
		"hell.mp3",
		"lengthen.mp3",
		"unchained.mp3",
		"ripandtear.mp3",
		"bfg.mp3",
		"meathook.mp3",
		"cultist.mp3",
	  ];
	  let lastDoomMusic = null;
	  
	  const bgmTracks = {
  "Deep Forests": { audio: new Audio("forest.mp3"), savedTime: 0 },
  "Forest Empire": { audio: new Audio("forest.mp3"), savedTime: 0 },
  "Abandoned Graveyard": { audio: new Audio("graveyard.mp3"), savedTime: 0 },
  "Deathly Cliffs": { audio: new Audio("cliffs.mp3"), savedTime: 0 },
  "Bone Castle": { audio: new Audio("castle.mp3"), savedTime: 0 },
  "Silkwoven Caverns": { audio: new Audio("spider.mp3"), savedTime: 0 },
  "Arcane Swamps": { audio: new Audio("swamp.mp3"), savedTime: 0 },
  "Arcane Temple": { audio: new Audio("swamp.mp3"), savedTime: 0 },
  "Shi Mountains": { audio: new Audio("mountains.mp3"), savedTime: 0 },
  "The Depths": { audio: new Audio("mountains.mp3"), savedTime: 0 },
  "Archaic Caverns": { audio: new Audio("archaic.mp3"), savedTime: 0 },
  "Scorching Desert": { audio: new Audio("desert.mp3"), savedTime: 0 },
  "Never-Ending Tunnels": { audio: new Audio("Wind.mp3"), savedTime: 0 },
  "Eternity": { audio: new Audio("Wind.mp3"), savedTime: 0 },
  "Freezing Tundra": { audio: new Audio("Tundra.mp3"), savedTime: 0 },
  "The Black Sea": { audio: new Audio("sea.mp3"), savedTime: 0 },
  "Vast Ocean": { audio: new Audio("ocean.mp3"), savedTime: 0 },
  "Valrr Trench": { audio: new Audio("trench.mp3"), savedTime: 0 },
  "Sky Dimension": { audio: new Audio("sky.mp3"), savedTime: 0 },
  "Future Megalopolis": { audio: new Audio("tech.mp3"), savedTime: 0 },
  "Ancient Kingdom": { audio: new Audio("kingdom.mp3"), savedTime: 0 },
  "Shinjuku": { audio: new Audio("HeavenAndEarth.mp3"), savedTime: 0 },
  "Shibuya": { audio: new Audio("cool.mp3"), savedTime: 0 },
  "Molten Treasure Trove": { audio: new Audio("dragonsden.mp3"), savedTime: 0 },
  "Open Fields": { audio: new Audio("fields.mp3"), savedTime: 0 },
  "The Underworld": { audio: new Audio("HeavenAndEarth.mp3"), savedTime: 0 },
  "Hell": { audio: new Audio("hell.mp3"), savedTime: 0 },
  "Shadow Realm": { audio: new Audio("shadow.mp3"), savedTime: 0 },
  "The Beyond": { audio: new Audio("beyond.mp3"), savedTime: 0 },
  "Even Further Beyond": { audio: new Audio("roadtotheend.mp3"), savedTime: 0 },
  "Realm Of The Gods": { audio: new Audio("bossmusic.mp3"), savedTime: 0 },
};
const titleMusicOptions = ["fire.mp3", "tokyo.mp3", "hero.mp3", "special.mp3", "bang.mp3", "level.mp3", "titan.mp3", "rumbling.mp3"];
const titleIndex = Math.floor(Math.random() * titleMusicOptions.length);
const titleMusic = new Audio(titleMusicOptions[titleIndex]);
titleMusic.loop = true;
const ambushTrack = new Audio("battlemusic.mp3");
const bossTrack = new Audio("bossmusic.mp3");
const secTrack = new Audio("Judas.mp3");
const kocTrack = new Audio("MalevolentShrine.mp3");
const omniTrack = new Audio("Omni.mp3");
const bkTrack = new Audio("Black.mp3");
const dkTrack = new Audio("demon.mp3");
const semiTrack = new Audio("semifinale.mp3");
const troTrack = new Audio("Him.mp3");
const godTrack = new Audio("ultimate.mp3");
const casinoMusicOptions = ["gambling1.mp3", "gambling2.mp3", "gambling3.mp3"];
const casinoIndex = Math.floor(Math.random() * casinoMusicOptions.length);
const casinoMusic = new Audio(casinoMusicOptions[casinoIndex]);
const shopSound = new Audio("shop.mp3");
shopSound.loop = true;
shopSound.currentTime = 0;
const warriorTrack = new Audio("warrior.mp3");
warriorTrack.loop = true;
warriorTrack.currentTime = 0;
ambushTrack.loop = true;
ambushTrack.currentTime = 0;
bossTrack.loop = true;
bossTrack.currentTime = 0;
secTrack.loop = true;
secTrack.currentTime = 0;
omniTrack.loop = true;
omniTrack.currentTime = 0;
kocTrack.loop = true;
kocTrack.currentTime = 0;
bkTrack.loop = true;
bkTrack.currentTime = 0;
dkTrack.loop = true;
dkTrack.currentTime = 0;
troTrack.loop = true;
troTrack.currentTime = 0;
godTrack.loop = true;
godTrack.currentTime = 0;
semiTrack.loop = true;
semiTrack.currentTime = 0;
casinoMusic.loop = true;

      let ambushEnemiesQueue = null;
	  let beatTimer = null;
      let shopCooldown = 0;
      let allowedMoves = [];
      let floorCount = 1;
      let roomMoves = 0;
      let roomsThisFloor = 0;
	  let trapCount = 0;
      let lastAltarFloor = 0;
	  let secretAmbush = false;
	  let turnNumber = 1;
	  let killCount = 0;
	  let actionsLocked = false;
	  let currentWorld = "";
	  let currentBGM = null;
	  let battleAudio = null;
	  let ambushCompleteCallback = null;
	  let guildEncounteredBefore = false;
	  let guildFound = false;
	  let skillUsedThisBattle = false;
	  let ignoreEnemyResistances = false;

      let bossRoomGenerated = false;
      let player = {
  // Current stats (will be derived from baseStats + equipment)
  attack:    5,
  defense:   5,
  magic:     3,
  maxHp:    100,
  hp:       100,
  maxArmor: 20,
  armor: 20,
  maxMana:  10,
  mana:     10,
  agility:   1,
  perception:1,
  potential: 1,
  luck: 1,
  fortune: 1,
  dodgeChance: 0.2,
  neverMiss: false,
  critMultiplier: 1,
  money: 1000,
  exp: 0,
  level: 1,
  expToLevel: 5,
  inventory: new Array(10).fill(null),
  rage: false,
  iron: false,
  reflective: false,
  guildUnlocked: false,
  guildMissionStage: 0,
  guildMissionKills: 0,
  mercenaries: [],
  canRowMovement: false,
  
  // "True" base stats (permanent upgrades are stored here)
  baseStats: {
    attack:    5,
    defense:   5,
    magic:     3,
    maxHp:    100,
	maxArmor: 20,
    maxMana:  10,
    agility:   1,
    perception:1,
	potential: 1,
	luck: 1,
	fortune: 1,
    dodgeChance: 0.2,
    neverMiss:   false,
	canRowMovement: false,
  },

  // Equipped gear slots
  equipment: {
    weapon:    null,
    armor:     null,
    accessory: null
  },
  
  weaponSkill: {
	name: "None",
	usedThisBattle: false
  },
};  
	  
	  const equipmentEffects = {
  // Weapons
  "Sword":      p => {
	p.attack = Math.ceil(p.attack * 1.5);
  },
  "Gauntlets":      p => {
	p.attack = Math.ceil(p.attack * 1.3);
  },
  "Greatsword": p => {
    p.attack = p.attack * 2;
    p.defense = Math.ceil(p.defense * 1.5);
	p.maxArmor += 10;
    p.agility = p.agility - 10;
  },
  "Warhammer": p => {
    p.attack = p.attack * 3;
    p.defense = Math.ceil(p.defense * 1.67);
	p.maxArmor += 15;
    p.agility = p.agility - 15;
  },
  "Dagger":     p => {
    p.attack = Math.ceil(p.attack * 1.33);
    p.agility = Math.ceil(p.agility * 1.5);
    p.perception = Math.ceil(p.perception * 1.5);
  },
  "Spear":      p => {
    p.attack = p.attack * 2;
    p.perception = Math.ceil(p.perception * 1.5);
    p.agility = p.agility - 10;
  },
  "Wand":       p => {
	p.attack = Math.ceil(p.attack * 1.1);
    p.magic = Math.ceil(p.magic * 1.5);
    p.maxMana += 10;
  },
  "Staff":      p => {
	p.attack = Math.ceil(p.attack * 1.2);
    p.magic = p.magic * 2;
    p.maxMana += 20;
    p.agility = p.agility - 10;
  },
  "Shield":     p => {
    p.attack = Math.ceil(p.attack * 1.25);
    p.defense = Math.ceil(p.defense * 1.5);
	p.maxArmor += 30;
  },
  "Gun": p => {
    if (p.equipment.accessory
        && p.equipment.accessory.name === "Ammo Box") {
      p.attack *= 10;
    }
  },
  "Mech Arms": p => {
    if (p.equipment.accessory && p.equipment.accessory.name === "Nuclear Reactor" && p.equipment.armor && p.equipment.armor.name === "Mech Armor") {
      p.attack *= 5;
	  p.defense *= 2;
    }
  },
  "Mech Armor": p => {
    if (p.equipment.accessory && p.equipment.accessory.name === "Nuclear Reactor" && p.equipment.weapon && p.equipment.weapon.name === "Mech Arms") {
	  p.maxArmor *= 3;
      p.defense *= 2;
    }
  },
  "Nuclear Reactor": p => {
    if (p.equipment.weapon && p.equipment.weapon.name === "Mech Arms" && p.equipment.armor && p.equipment.armor.name === "Mech Armor") {
      p.maxMana *= 3;
	  p.defense *= 2;
    }
  },
  
  "Excalibur": p => {
    // triple attack
    p.attack *= 3;
    // double agility & perception
    p.agility  = Math.ceil(p.agility * 2);
    p.perception = Math.ceil(p.perception * 2);
    // increase defense by 1.5×, rounded up
    p.defense = Math.ceil(p.defense * 1.5);
    // +25 max mana
    p.maxMana += 25;
  },
  "Dragon's Fang": p => {
    p.attack *= 2;
    p.agility *= 3;
    p.perception = Math.ceil(p.perception * 2.5);
  },
  "Sorceress' Staff":      p => {
	p.attack = Math.ceil(p.attack * 1.25);
    p.magic   = p.magic * 3;
    p.maxMana = Math.ceil(p.maxMana * 2.5);
  },
  "Chainsaw":      p => {
	p.attack = Math.ceil(p.attack * 1.5);
  },
  "Sentinel Hammer": p => {
    p.attack = p.attack * 2;
    p.defense = Math.ceil(p.defense * 1.5);
	p.maxArmor += 10;
    p.agility = p.agility - 10;
  },
  "Doomblade Arm Upgrade":     p => {
    p.attack = Math.ceil(p.attack * 1.33);
    p.agility = Math.ceil(p.agility * 1.5);
    p.perception = Math.ceil(p.perception * 1.5);
  },
  "Energy Spear":      p => {
    p.attack = p.attack * 2;
    p.perception = Math.ceil(p.perception * 1.5);
    p.agility = p.agility - 10;
  },
  "Combat Shotgun":       p => {
	p.attack = Math.ceil(p.attack * 1.2);
    p.magic = Math.ceil(p.magic * 1.5);
    p.maxMana += 10;
  },
  "Unmayker":      p => {
	p.attack = Math.ceil(p.attack * 1.1);
    p.magic = p.magic * 2;
    p.maxMana += 20;
    p.agility = p.agility - 10;
  },
  "Chainshield":     p => {
    p.attack = Math.ceil(p.attack * 1.25);
    p.defense = Math.ceil(p.defense * 1.5);
	p.maxArmor += 30;
  },
  "BFG9000": p => {
    if (p.equipment.accessory && p.equipment.accessory.name === "Argent Energy Storage") {
		if (player.magic > player.attack) {
			p.magic *= 5;
			p.maxMana = Math.max(player.maxMana, 30);
		} else {
			p.attack *= 5;
		}
    }
  },
  "Crucible": p => {
    p.attack = p.attack * 3;
    p.agility  = Math.ceil(p.agility  * 2);
    p.perception = Math.ceil(p.perception * 2);
    p.defense = Math.ceil(p.defense * 1.5);
    // +25 max mana
    p.maxMana += 25;
  },
  "Titan's Fang": p => {
    p.attack = p.attack * 2;
    p.agility = p.agility * 3;
    p.perception = Math.ceil(p.perception * 2.5);
  },
  "BFG10000":      p => {
	p.attack = Math.ceil(p.attack * 1.25);
    p.magic   = p.magic * 10;
    p.maxMana = Math.max(player.maxMana, 30);
  },

  // Armors
  "Armor":      p => {
	p.defense = Math.ceil(p.defense * 1.5); 
	p.maxArmor += 25;
  },
  "Cloak":      p => {
    p.defense = Math.ceil(p.defense * 1.3);
    p.agility = Math.ceil(p.agility * 2);
	p.maxArmor += 10;
  },
  "Robe":       p => {
    p.defense = Math.ceil(p.defense * 1.25);
    p.magic   = Math.ceil(p.magic * 1.5);
    p.maxMana += 20;
	p.maxArmor += 10;
  },
  "Grand Knight's Armor":      p => {
    p.defense *= 2;
	p.attack *= 2;
	p.agility *= 2;
	p.maxArmor += 30;
  },
  "Armor":      p => {
	p.defense = Math.ceil(p.defense * 1.5); 
	p.maxArmor += 25;
  },
  "Cloak":      p => {
    p.defense = Math.ceil(p.defense * 1.3);
    p.agility = Math.ceil(p.agility * 2);
	p.maxArmor += 10;
  },
  "Mantle":       p => {
    p.defense = Math.ceil(p.defense * 1.25);
    p.magic   = Math.ceil(p.magic * 1.5);
    p.maxMana += 20;
	p.maxArmor += 10;
  },
  "Praetor Suit":      p => {
    p.defense *= 2;
	p.attack *= 2;
	p.agility *= 2;
	p.maxArmor += 30;
  },

  // Accessories
  "Scarf":      p => {
	p.dodgeChance = 0.1;
  },
  "Ring":      p => {
	p.potential *= 2;
	p.luck *= 2;
	p.fortune *= 2;
  },
  "Glasses":    p => {
	p.neverMiss = true;
  },
  "Dice":       p => {
	p.autoWinCasino = true;
  },
  "Sharpener":  p => {
	p.critMultiplier = 2;
  },
  "Ammo Box":   p => {
  },
  "Nike Black Air Force": p => {
	p.canRowMovement = true;
	p.agility = Math.ceil(p.agility * 3);
  },
  "Previous Hero's Cape": p => {
	p.attack = Math.ceil(p.attack * 1.5);
	p.magic = Math.ceil(p.magic * 1.5);
	p.defense = Math.ceil(p.defense * 1.5);
	p.agility = Math.ceil(p.agility * 1.5);
	p.perception = Math.ceil(p.perception * 1.5);
	p.potential = Math.ceil(p.potential * 1.5);
	p.luck = Math.ceil(p.luck * 1.5);
	p.fortune = Math.ceil(p.fortune * 1.5);
  },
  "Mobility Rune":      p => {
	p.dodgeChance = 0.1;
  },
  "Brutality Rune":    p => {
	p.neverMiss = true;
  },
  "Savagery Rune":  p => {
	p.critMultiplier = 2;
  },
  "Violence Rune": p => {
	p.attack = p.attack * 2;
  },
  "Armor Rune": p => {
	p.defense = p.defense * 2;
  },
  "Arsenal Rune": p => {
	p.magic = Math.ceil(p.magic * 1.5);
  },
  "Infinity Rune": p => {
	p.mana = player.maxMana;
  },
  "Argent Energy Storage":   p => {
	  
  },
  "Delta V-Jump Boots": p => {
	p.canRowMovement = true;
	p.agility = Math.ceil(p.agility * 3);
  },
  "Dark Ages Mantle": p => {
	p.attack = Math.ceil(p.attack *= 1.5);
	p.magic = Math.ceil(p.magic * 1.5);
	p.defense = Math.ceil(p.defense * 1.5);
	p.agility = Math.ceil(p.agility * 1.5);
	p.perception = Math.ceil(p.perception * 1.5);
  },
};

const weaponSkillMap = {
  "Dagger": "Assassinate",
  "Shield": "Bash",
  "Greatsword": "Heavy Slash",
  "Warhammer": "Smash",
  "Staff": "Blast Minima",
  "Excalibur": "Execution",
  "Sorceress' Staff": "Rewind",
  "Dragon's Fang": "Outrage",
  "Gauntlets": "Pummel",
  
  "Doomblade Arm Upgrade": "Glory Slash",
  "Chainshield": "Launch",
  "Sentinel Hammer": "Sentinel Slam",
  "Unmaykr": "Demon Evisceration",
  "Crucible": "Divine Execution",
  "BFG10000": "Planet Break",
  "Titan's Fang": "Outrage",
};
	  
	  const passiveAbilities = [
  { name: "None", chance: 30 },
  { name: "Tough", chance: 10 },
  { name: "Quick", chance: 10 },
  { name: "Reckless", chance: 8 },
  { name: "Hunter", chance: 8 },
  { name: "Berserker", chance: 7.5 },
  { name: "Arcane", chance: 7.5 },
  { name: "Golden", chance: 5 },
  { name: "Big", chance: 5 },
  { name: "Burning", chance: 5 },
  { name: "Fighting Spirit", chance: 5 },
  { name: "Ambidextrous", chance: 1 },
  { name: "Reflective", chance: 1 },
  { name: "Adaptable", chance: 0.5 },
  { name: "Invincible", chance: 0.5 },
  { name: "Relentless", chance: 0.5 },
  { name: "Aura Farmer", chance: 0.5 },
  { name: "Immortal", chance: 0.1 },
  { name: "Six Eyes", chance: 0.1 },
  { name: "Vessel", chance: 0.1 },
  { name: "Heavenly Restricted", chance: 0.1 },
  { name: "Immortal", chance: 0.1 },
];

const activeAbilities = [
  { name: "None", chance: 30 },
  { name: "Rage", chance: 10 },
  { name: "Dash", chance: 10 },
  { name: "Hunt", chance: 10 },
  { name: "Strike", chance: 8 },
  { name: "Blast", chance: 8 },
  { name: "Heal", chance: 7.5 },
  { name: "Mesmerizing Voice", chance: 7.5 },
  { name: "Fireball", chance: 5 },
  { name: "Freeze", chance: 5 },
  { name: "Acid Spit", chance: 5 },
  { name: "Thunderbolt", chance: 5 },
  { name: "Sacrifice", chance: 3 },
  { name: "Counter", chance: 2.5 },
  { name: "Maxima", chance: 1.5 },
  { name: "Super Strike", chance: 1.5 },
  { name: "Resurrection", chance: 1 },
  { name: "Reversal", chance: 0.7 },
  { name: "Blade of Gold", chance: 0.5 },
  { name: "Shining Armor", chance: 0.5 },
  { name: "Switch", chance: 0.1 },
  { name: "Infinity", chance: 0.1 },
  { name: "Necromancy", chance: 0.1 },
];

function getAbilityCategory(chance) {
  if (chance >= 30) {
    return "(None)";
  } if (chance >= 10) {
    return "(Common)";
  } else if (chance >= 5) {
    return "(Rare)";
  } else if (chance >= 1) {
    return "(Epic)";
  } else if (chance >= 0.5) {
    return "(Legendary)";
  } else {
	return "(???)";
  }
}

function populateAbilityLists() {
  const passiveListEl = document.getElementById("passiveAbilitiesList");
  const activeListEl = document.getElementById("activeAbilitiesList");
  
  passiveListEl.innerHTML = "";
  activeListEl.innerHTML = "";

  passiveAbilities.forEach(ability => {
    const li = document.createElement("li");
    li.textContent = `${ability.name} ${getAbilityCategory(ability.chance)}`;
    passiveListEl.appendChild(li);
  });

  activeAbilities.forEach(ability => {
    const li = document.createElement("li");
    li.textContent = `${ability.name} ${getAbilityCategory(ability.chance)}`;
    activeListEl.appendChild(li);
  });
}

document.addEventListener("DOMContentLoaded", populateAbilityLists);

document.getElementById("spinAbilityButton").addEventListener("click", function () {
  spinAbilities();
  this.style.display = "none";
});
	  
	  const badTrapChance = Math.max(0, 0.05  - player.luck * 0.001);
	  const badAmbushChance  = Math.max(0, 0.10  - player.luck * 0.001);
	  
      let map = {};
      const ROOM_TYPES = {
        BATTLE: "battle",
        HEALING: "healing",
        SHOP: "shop",
        EMPTY: "empty",
        BOSS: "boss",
        ALTAR: "altar",
        CASINO: "casino",
        AMBUSH: "ambush",
        LOOT: "loot",
		TRAP: "trap",
		GUILD: "guild",
		WARRIOR:  "warrior",
      };
      const roomIcons = {
        battle: "battle.png",
        healing: "heal.png",
        shop: "shop.png",
        boss: "skull.png",
        altar: "altar.png",
        casino: "casino.png",
        ambush: "ambush.png",
        loot: "loot.png",
		trap: "trap.png",
		guild: "guild.png",
      };
      const enemies = [{
        name: "Monster Crow",
        hp: 20,
        damageRange: [2, 4],
        expReward: [1, 4],
        moneyReward: [2, 4],
		reductionAttack: 0.33,
      }, {
        name: "Goblin",
        hp: 25,
        damageRange: [3, 5],
        expReward: [2, 4],
        moneyReward: [5, 6]
      }, {
        name: "Ogre",
        hp: 40,
        damageRange: [10, 12],
        expReward: [2, 4],
        moneyReward: [5, 6]
      }, {
        name: "Ogre Mage",
        hp: 35,
        damageRange: [12, 15],
        expReward: [2, 4],
        moneyReward: [5, 6], 
		reductionMagic: 0.33,
      }, {
        name: "Orc",
        hp: 30,
        damageRange: [8, 10],
        expReward: [2, 4],
        moneyReward: [5, 6]
      }, {
        name: "Orc Berserker",
        hp: 40,
        damageRange: [10, 12],
        expReward: [2, 4],
        moneyReward: [5, 6]
      }, {
        name: "High Orc",
        hp: 50,
        damageRange: [12, 16],
        expReward: [2, 4],
        moneyReward: [5, 6], 
		reductionMagic: 0.33,
      }, {
        name: "Wolf",
        hp: 30,
        damageRange: [5, 8],
        expReward: [3, 5],
        moneyReward: [3, 5]
      }, {
        name: "Bear",
        hp: 40,
        damageRange: [6, 9],
        expReward: [4, 6],
        moneyReward: [4, 6]
      }, {
        name: "Bull",
        hp: 50,
        damageRange: [5, 9],
        expReward: [5, 6],
        moneyReward: [3, 5]
      }, {
        name: "Snake",
        hp: 30,
        damageRange: [4, 5],
        expReward: [3, 6],
        moneyReward: [3, 5]
      }, {
        name: "Hobgoblin",
        hp: 50,
        damageRange: [7, 10],
        expReward: [5, 7],
        moneyReward: [7, 10],
		reductionMagic: 0.33,
      }, {
        name: "Dire Wolf",
        hp: 60,
        damageRange: [8, 12],
        expReward: [5, 8],
        moneyReward: [5, 8],
      }, {
        name: "Werewolf",
        hp: 70,
        damageRange: [5, 9],
        expReward: [5, 8],
        moneyReward: [5, 8],
      }, {
        name: "Dire Bear",
        hp: 80,
        damageRange: [10, 15],
        expReward: [10, 15],
        moneyReward: [4, 6],
		reductionAttack: 0.33,
      }, {
        name: "Gorgon",
        hp: 60,
        damageRange: [9, 12],
        expReward: [6, 7],
        moneyReward: [6, 6],
		reductionAttack: 0.5,
      }, {
        name: "Zombie",
        hp: 35,
        damageRange: [3, 5],
        expReward: [3, 4],
        moneyReward: [3, 5],
        reductionMagic: 0.5,
      }, {
        name: "Skeleton",
        hp: 25,
        damageRange: [4, 7],
        expReward: [3, 4],
        moneyReward: [3, 6],
		reductionAttack: 0.5,
      }, {
        name: "Ghoul",
        hp: 20,
        damageRange: [5, 8],
        expReward: [1, 3],
        moneyReward: [2, 4],
        reductionAll: 0.33
      }, {
        name: "Giant Spider",
        hp: 25,
        damageRange: [5, 7],
        expReward: [3, 5],
        moneyReward: [3, 5]
      }, {
        name: "Ant Swarm",
        hp: 1,
        damageRange: [50, 100],
        expReward: [3, 6],
        moneyReward: [4, 6]
      }, {
        name: "Giant Worker Ant",
        hp: 35,
        damageRange: [8, 9],
        expReward: [4, 6],
        moneyReward: [5, 7]
      }, {
        name: "Giant Warrior Ant",
        hp: 50,
        damageRange: [10, 12],
        expReward: [5, 7],
        moneyReward: [6, 7]
      }, {
        name: "Giant Drone Ant",
        hp: 70,
        damageRange: [6, 8],
        expReward: [5, 6],
        moneyReward: [5, 10], 
		reductionAll: 0.25,
      }, {
        name: "Giant Black Ant",
        hp: 80,
        damageRange: [10, 15],
        expReward: [6, 9],
        moneyReward: [6, 9],
		reductionAll: 0.33,
      }, {
        name: "Demon Bat",
        hp: 15,
        damageRange: [3, 5],
        expReward: [2, 4],
        moneyReward: [2, 4],
		reductionAttack: 0.5,
      }, {
        name: "Shark",
        hp: 40,
        damageRange: [4, 6],
        expReward: [4, 6],
        moneyReward: [3, 6],
		reductionAttack: 0.33,
      }, {
        name: "Crab",
        hp: 20,
        damageRange: [3, 5],
        expReward: [3, 5],
        moneyReward: [3, 5]
      }, {
        name: "Iron Crab",
        hp: 40,
        damageRange: [4, 5],
        expReward: [3, 5],
        moneyReward: [4, 5],
		reductionAll: 0.33,
      }, {
        name: "Giant Crab",
        hp: 60,
        damageRange: [3, 5],
        expReward: [3, 5],
        moneyReward: [3, 5]
      }, {
        name: "King Crab",
        hp: 50,
        damageRange: [4, 6],
        expReward: [3, 5],
        moneyReward: [4, 6]
      }, {
        name: "Spider Crab",
        hp: 15,
        damageRange: [4, 8],
        expReward: [3, 5],
        moneyReward: [3, 5]
      }, {
        name: "Piranha",
        hp: 15,
        damageRange: [3, 5],
        expReward: [3, 4],
        moneyReward: [3, 5],
		reductionAttack: 0.33,
      }, {
        name: "Giant Albatross",
        hp: 35,
        damageRange: [4, 7],
        expReward: [3, 5],
        moneyReward: [3, 5],
        reductionAttack: 0.33
      }, {
        name: "Golem",
        hp: 100,
        damageRange: [6, 10],
        expReward: [6, 10],
        moneyReward: [5, 10],
        reductionAttack: 0.5
      }, {
        name: "Ice Golem",
        hp: 80,
        damageRange: [8, 13],
        expReward: [6, 11],
        moneyReward: [6, 10],
        reductionMagic: 0.5
      }, {
        name: "Ice Spirit",
        hp: 40,
        damageRange: [7, 12],
        expReward: [4, 6],
        moneyReward: [2, 4],
        reductionAll: 0.33
      }, {
        name: "Snowman",
        hp: 30,
        damageRange: [5, 8],
        expReward: [2, 4],
        moneyReward: [2, 4],
        reductionAll: 0.8
      }, {
        name: "Giant Scorpion",
        hp: 35,
        damageRange: [4, 8],
        expReward: [3, 5],
        moneyReward: [3, 5],
        reductionAll: 0.33
      }, {
        name: "Sandworm",
        hp: 40,
        damageRange: [5, 9],
        expReward: [3, 6],
        moneyReward: [2, 5]
      }, {
        name: "Vulture",
        hp: 35,
        damageRange: [3, 6],
        expReward: [3, 5],
        moneyReward: [3, 5],
        reductionAttack: 0.33
      }, {
        name: "Possessed Armor",
        hp: 80,
        damageRange: [7, 10],
        expReward: [5, 7],
        moneyReward: [5, 6],
        reductionAttack: 0.5
      }, {
        name: "Cursed Spirit",
        hp: 60,
        damageRange: [6, 9],
        expReward: [6, 8],
        moneyReward: [4, 5],
        reductionAll: 0.33,
      }, {
        name: "Cyborg Guard",
        hp: 70,
        damageRange: [4, 8],
        expReward: [6, 8],
        moneyReward: [5, 6],
      }, {
		name: "Giant Robot",
        hp: 80,
        damageRange: [6, 10],
        expReward: [9, 10],
        moneyReward: [8, 9],
		reductionAttack: 0.33,
      }, {
		name: "Jeager",
        hp: 250,
        damageRange: [10, 15],
        expReward: [12, 15],
        moneyReward: [10, 12],
		reductionAttack: 0.5,
		reductionMagic: 0.33,
      }, {
		name: "Drone",
        hp: 50,
        damageRange: [8, 12],
        expReward: [8, 10],
        moneyReward: [8, 9]
      }, {
		name: "Sorcerer",
        hp: 70,
        damageRange: [9, 13],
        expReward: [9, 10],
        moneyReward: [9, 10],
		reductionAttack: 0.33,
      }, {
		name: "Shikigami",
        hp: 90,
        damageRange: [10, 15],
        expReward: [8, 9],
        moneyReward: [6, 8],
		reductionAttack: 0.33,
      }, {
		name: "Demon",
        hp: 90,
        damageRange: [13, 17],
        expReward: [8, 9],
        moneyReward: [6, 8],
		reductionMagic: 0.5,
      }, {
		name: "Imp",
        hp: 50,
        damageRange: [10, 15],
        expReward: [7, 8],
        moneyReward: [6, 9],
		reductionAttack: 0.5,
      }, {
		name: "Sinner",
        hp: 70,
        damageRange: [9, 12],
        expReward: [5, 7],
        moneyReward: [6, 9],
		reductionAll: 0.33,
      }, {
		name: "Archdemon",
        hp: 120,
        damageRange: [12, 16],
        expReward: [9, 10],
        moneyReward: [8, 10],
		reductionMagic: 0.33,
      }, {
		name: "Hell Knight",
        hp: 150,
        damageRange: [13, 18],
        expReward: [9, 10],
        moneyReward: [8, 10],
		reductionMagic: 0.33,
      }, {
        name: "Mancubus",
        hp: 200,
        damageRange: [10, 15],
        expReward: [10, 12],
        moneyReward: [8, 10],
        reductionAttack: 0.5
      }, {
        name: "Cacodemon",
        hp: 180,
        damageRange: [12, 14],
        expReward: [9, 11],
        moneyReward: [8, 10]
      }, {
        name: "Gargoyle",
        hp: 60,
        damageRange: [13, 17],
        expReward: [6, 10],
        moneyReward: [5, 10],
        reductionMagic: 0.5
      }, {
        name: "Cyberdemon",
        hp: 250,
        damageRange: [12, 15],
        expReward: [10, 12],
        moneyReward: [5, 10],
      },  {
        name: "Baron",
        hp: 225,
        damageRange: [9, 17],
        expReward: [10, 12],
        moneyReward: [5, 10]
      }, {
    name: "Goblin King",
    hp: 100,
    damageRange: [10, 15],
    expReward: [30, 30],
    moneyReward: [30, 30]
  },
  {
    name: "Zombie Mutant",
    hp: 120,
    damageRange: [12, 20],
    expReward: [60, 60],
    moneyReward: [60, 60],
	reductionMagic: 0.5,
  },
  {
    name: "Giant Lord",
    hp: 250,
    damageRange: [15, 32],
    expReward: [80, 80],
    moneyReward: [80, 80],
    reductionAttack: 0.5,
  },
  {
    name: "Skeleton King",
    hp: 110,
    damageRange: [15, 30],
    expReward: [50, 50],
    moneyReward: [50, 50],
	reductionAttack: 0.5,
  },
  {
    name: "Spider Queen",
    hp: 140,
    damageRange: [12, 25],
    expReward: [40, 40],
    moneyReward: [40, 40]
  },
  {
    name: "The Witch",
    hp: 120,
    damageRange: [20, 35],
    expReward: [50, 50],
    moneyReward: [50, 50],
    reductionMagic: 0.5,
  },
  {
    name: "Titan Golem",
    hp: 350,
    damageRange: [20, 35],
    expReward: [80, 80],
    moneyReward: [80, 80],
    reductionAll: 0.33,
  },
  {
    name: "Wyvern",
    hp: 200,
    damageRange: [25, 40],
    expReward: [70, 70],
    moneyReward: [90, 90],
    reductionAttack: 0.5,
  },
  {
    name: "Giant Sandworm",
    hp: 150,
    damageRange: [20, 30],
    expReward: [50, 50],
    moneyReward: [50, 50]
  },
  {
    name: "Titanoboa Lord",
    hp: 170,
    damageRange: [25, 35],
    expReward: [60, 60],
    moneyReward: [60, 60]
  },
  {
    name: "Abominable Snowman",
    hp: 190,
    damageRange: [25, 40],
    expReward: [60, 60],
    moneyReward: [60, 60]
  },
  {
    name: "Omegalodon",
    hp: 200,
    damageRange: [20, 35],
    expReward: [50, 50],
    moneyReward: [50, 50],
    reductionAttack: 0.5,
  },
  {
    name: "Leviathan",
    hp: 300,
    damageRange: [30, 40],
    expReward: [80, 80],
    moneyReward: [80, 80],
    reductionAttack: 0.33,
  },
  {
    name: "Angel",
    hp: 320,
    damageRange: [30, 45],
    expReward: [80, 80],
    moneyReward: [80, 80],
    reductionMagic: 0.5,
  },
  {
    name: "Mega Meta Mecha Annihilator - Model: Ultima",
    hp: 600,
    damageRange: [25, 36],
    expReward: [80, 80],
    moneyReward: [80, 80],
    reductionAttack: 0.5,
  },
  {
    name: "Grand Knight",
    hp: 800,
    damageRange: [30, 40],
    expReward: [70, 70],
    moneyReward: [70, 70],
    reductionAll: 0.33
  },
  {
    name: "Frost Knight",
    hp: 200,
    damageRange: [6, 10],
    expReward: [70, 70],
    moneyReward: [70, 70],
    reductionAll: 0.33
  },
  {
    name: "Six-Eyed Calamity",
    hp: 500,
    damageRange: [35, 50],
    expReward: [80, 80],
    moneyReward: [80, 80],
    reductionAll: 0.33,
  },
  {
  name: "Goblin Emperor",
  hp: 200,
  damageRange: [30, 40],
  expReward: [60, 60],
  moneyReward: [80, 80]
  },
{
  name: "Giant Cyclops, Eater of Men",
  hp: 300,
  damageRange: [25, 40],
  expReward: [60, 60],
  moneyReward: [60, 60]
},
{
  name: "Orc Lord",
  hp: 350,
  damageRange: [35, 40],
  expReward: [65, 65],
  moneyReward: [65, 65],
  reductionAttack: 0.33,
},
{
  name: "Medusa, Lady of Stone",
  hp: 250,
  damageRange: [30, 40],
  expReward: [70, 70],
  moneyReward: [70, 70],
  reductionAttack: 0.5
},
{
  name: "Ogre King",
  hp: 420,
  damageRange: [40, 45],
  expReward: [70, 70],
  moneyReward: [70, 70],
  reductionMagic: 0.33,
},
{
  name: "The Minotaur",
  hp: 400,
  damageRange: [25, 35],
  expReward: [80, 80],
  moneyReward: [80, 80],
  reductionMagic: 0.5
},
{
  name: "Arachni Empress",
  hp: 300,
  damageRange: [30, 40],
  expReward: [70, 70],
  moneyReward: [70, 70],
  reductionAttack: 0.5
},
{
  name: "Grand Sorceress",
  hp: 250,
  damageRange: [35, 50],
  expReward: [80, 80],
  moneyReward: [80, 80],
  reductionMagic: 1
},
{
  name: "Primordial Automaton",
  hp: 500,
  damageRange: [30, 40],
  expReward: [80, 80],
  moneyReward: [80, 80],
  reductionAll: 0.5
},
{
  name: "Devourer of Worlds",
  hp: 500,
  damageRange: [30, 40],
  expReward: [80, 80],
  moneyReward: [80, 80],
  reductionAll: 0.33
},
{
  name: "The World Serpent, Jörmungandr",
  hp: 800,
  damageRange: [35, 45],
  expReward: [90, 90],
  moneyReward: [90, 90],
  reductionAll: 0.5
},
{
  name: "Frost Queen, Borealis",
  hp: 400,
  damageRange: [30, 45],
  expReward: [80, 80],
  moneyReward: [80, 80],
  reductionMagic: 0.5
},
{
  name: "Charybdis",
  hp: 350,
  damageRange: [25, 45],
  expReward: [70, 70],
  moneyReward: [70, 70],
  reductionAttack: 0.5
},
{
  name: "Queen Ant",
  hp: 500,
  damageRange: [30, 40],
  expReward: [60, 60],
  moneyReward: [60, 60]
},
{
  name: "Ant King, Beru",
  hp: 800,
  damageRange: [40, 50],
  expReward: [60, 60],
  moneyReward: [60, 60],
  reductionAll: 0.33,
},
{
  name: "Seraphim",
  hp: 420,
  damageRange: [40, 45],
  expReward: [80, 80],
  moneyReward: [80, 80],
  reductionMagic: 1
},
{
  name: "Mega Meta Mecha Annihilator - Model: Grande",
  hp: 800,
  damageRange: [30, 45],
  expReward: [90, 90],
  moneyReward: [90, 90],
  reductionAttack: 1
},
{
  name: "Grand Knight II",
  hp: 500,
  damageRange: [30, 50],
  expReward: [80, 80],
  moneyReward: [80, 80],
  reductionAll: 0.4
},
{
  name: "The Brazen Bull, Khalkotauri",
  hp: 450,
  damageRange: [25, 35],
  expReward: [70, 70],
  moneyReward: [70, 70],
  reductionAll: 0.33
},
{
  name: "Kraken",
  hp: 450,
  damageRange: [25, 35],
  expReward: [60, 60],
  moneyReward: [60, 60],
  reductionAttack: 0.33,
},
{
  name: "Crab God, Khaos",
  hp: 400,
  damageRange: [30, 40],
  expReward: [60, 60],
  moneyReward: [60, 60]
},
{
  name: "Ghost Leviathan",
  hp: 600,
  damageRange: [30, 35],
  expReward: [60, 60],
  moneyReward: [60, 60],
  reductionAll: 0.33,
},
{
  name: "Island Turtle",
  hp: 850,
  damageRange: [25, 30],
  expReward: [60, 60],
  moneyReward: [60, 60],
  reductionAll: 0.25,
},
  {
    name: "The King of Curses",
    hp: 600,
    damageRange: [35, 55],
    expReward: [80, 80],
    moneyReward: [80, 80],
    reductionAll: 0.25,
  },
  {
    name: "Dragon King",
    hp: 800,
    damageRange: [35, 50],
    expReward: [90, 90],
    moneyReward: [90, 90],
    reductionAttack: 0.33,
	reductionMagic: 0.67,
  },
  {
    name: "Guardian of Hell, Cerberus",
    hp: 700,
    damageRange: [25, 35],
    expReward: [70, 70],
    moneyReward: [70, 70],
	reductionMagic: 0.33,
  },
  {
    name: "Demon King",
    hp: 850,
    damageRange: [40, 60],
    expReward: [80, 80],
    moneyReward: [85, 85],
    reductionMagic: 0.5,
  },
  {
    name: "The Black King",
    hp: 900,
    damageRange: [50, 60],
    expReward: [95, 95],
    moneyReward: [90, 90],
    reductionMagic: 0.5,
  },
  {
    name: "Omni",
    hp: 1000,
    damageRange: [50, 60],
    expReward: [100, 100],
    moneyReward: [100, 100],
    reductionAttack: 0.5,
    reductionMagic: 0.5,
  }
];

      function getBossForFloor(floor) {
		if (gameDifficulty === "doom") {
   // Every 50 floors you hit a boss; cycle through these seven
   const bosses = [
     { name: "Behemoth",            hp: 10000,  damageRange: [40, 90],  expReward: [100, 100], moneyReward: [100, 100], },
	 { name: "Baron of Hell",            hp: 18000,  damageRange: [60, 100],  expReward: [200, 200], moneyReward: [100, 100], },
     { name: "Fallen Angel",        hp: 20000,  damageRange: [70, 120], expReward: [300, 300], moneyReward: [200, 150], },
     { name: "Hell Guard", hp: 35000, damageRange: [80, 110], expReward: [750, 750], moneyReward: [500, 500], },
     { name: "Tyrant Cyberdemon",          hp: 60000, damageRange: [100, 120], expReward: [1000, 1000], moneyReward: [800, 800], },
	 { name: "Spider Mastermind",          hp: 80000, damageRange: [90, 130], expReward: [1500, 1500], moneyReward: [800, 800], },
	 { name: "Hell Titan",          hp: 100000, damageRange: [80, 110], expReward: [2000, 2000], moneyReward: [800, 800], },
	 { name: "Guardian of Hell, Cerberus.", hp: 100000, damageRange: [120, 140], expReward: [2400, 2400], moneyReward: [1000, 1000], },
     { name: "Demon King.",          hp: 120000, damageRange: [100, 150],expReward: [2700, 2700], moneyReward: [1500, 1500], },
	 { name: "Doom Hunter",          hp: 125000, damageRange: [90, 120],expReward: [2500, 2500], moneyReward: [1000, 1000], },
	 { name: "Death Marauder",          hp: 150000, damageRange: [100, 130],expReward: [2700, 2700], moneyReward: [1000, 1000], },
	 { name: "The Gladiator",          hp: 180000, damageRange: [110, 140],expReward: [2800, 2800], moneyReward: [1200, 1200], },
     { name: "Dreadnought, the Ancient Hell Titan",  hp: 250000, damageRange: [90, 130],expReward: [3000, 3000], moneyReward: [1500, 1500], },
	 { name: "Khan Maykr",          hp: 150000, damageRange: [130, 160],expReward: [3200, 3200], moneyReward: [1500, 1000], },
	 { name: "The Icon of Sin",          hp: 300000, damageRange: [120, 130],expReward: [3500, 3500], moneyReward: [1500, 1500], },
	 { name: "Viscount Hellbreaker",          hp: 250000, damageRange: [100, 150],expReward: [3600, 3600], moneyReward: [1500, 1500], },
	 { name: "Maligog, Protector of the Gods",  hp: 500000, damageRange: [100, 120],expReward: [3800, 3800], moneyReward: [1500, 1500], },
     { name: "The Dark Lord, Davoth",           hp: 350000, damageRange: [120, 160],expReward: [4000, 4000], moneyReward: [2000, 2000], },
   ];
   const idx = Math.min(Math.ceil(floor/50)-1, bosses.length-1);
   return bosses[idx];
 }
 
 if (gameDifficulty === "bossRush") {
	 const bosses = {
          3: {
            name: "Goblin King",
            hp: 500,
            damageRange: [10, 15],
            expReward: [30, 30],
            moneyReward: [30, 30],
          },
          6: {
            name: "Zombie Mutant",
            hp: 1000,
            damageRange: [10, 20],
            expReward: [70, 70],
            moneyReward: [70, 70],
			reductionMagic: 0.5,
          },
          9: {
            name: "Giant Lord",
            hp: 3600,
            damageRange: [10, 15],
            expReward: [100, 100],
            moneyReward: [100, 100],
            reductionAttack: 0.5,
          },
          12: {
            name: "Skeleton King",
            hp: 1500,
            damageRange: [15, 20],
            expReward: [120, 120],
            moneyReward: [120, 120],
			reductionAttack: 0.5,
          },
          15: {
            name: "Spider Queen",
            hp: 2100,
            damageRange: [15, 25],
            expReward: [150, 150],
            moneyReward: [150, 150]
          },
          18: {
            name: "The Witch",
            hp: 2000,
            damageRange: [20, 35],
            expReward: [180, 180],
            moneyReward: [180, 180],
            reductionMagic: 0.5,
          },
          21: {
            name: "Titan Golem",
            hp: 7500,
            damageRange: [20, 30],
            expReward: [210, 210],
            moneyReward: [210, 210],
            reductionAll: 0.33,
          },
          24: {
            name: "Wyvern",
            hp: 9000,
            damageRange: [25, 40],
            expReward: [240, 240],
            moneyReward: [240, 240],
			reductionAttack: 0.5,
          },
          27: {
            name: "Giant Sandworm",
            hp: 6500,
            damageRange: [20, 30],
            expReward: [250, 250],
            moneyReward: [250, 250]
          },
          30: {
            name: "Titanoboa Lord",
            hp: 7000,
            damageRange: [25, 35],
            expReward: [280, 280],
            moneyReward: [280, 280]
          },
          33: {
            name: "Abominable Snowman",
            hp: 7500,
            damageRange: [30, 40],
            expReward: [300, 300],
            moneyReward: [300, 300]
          },
          36: {
            name: "Omegalodon",
            hp: 8500,
            damageRange: [30, 35],
            expReward: [320, 320],
            moneyReward: [320, 320],
            reductionAttack: 0.5,
          },
          39: {
            name: "Leviathan",
            hp: 11000,
            damageRange: [35, 45],
            expReward: [360, 360],
            moneyReward: [360, 360],
            reductionAttack: 0.33,
          },
          42: {
            name: "Angel",
            hp: 8900,
            damageRange: [50, 60],
            expReward: [400, 400],
            moneyReward: [400, 400],
            reductionMagic: 0.5,
          },
          45: {
            name: "Mega Meta Mecha Annihilator - Model: Ultima",
            hp: 12000,
            damageRange: [45, 55],
            expReward: [420, 420],
            moneyReward: [500, 500],
			reductionAttack: 0.5,
          },
          48: {
            name: "Grand Knight",
            hp: 11500,
            damageRange: [50, 65],
            expReward: [480, 480],
            moneyReward: [480, 480],
            reductionAll: 0.33,
          },
          51: {
            name: "Six-Eyed Calamity",
            hp: 10000,
            damageRange: [60, 75],
            expReward: [600, 600],
            moneyReward: [560, 560],
            reductionAll: 0.33,
		  },
          54: {
            name: "Hydra",
            hp: 12000,
            damageRange: [55, 75],
            expReward: [900, 900],
            moneyReward: [800, 800],
			reductionAttack: 0.5,
          },
          57: {
            name: "Guardian of Hell, Cerberus",
            hp: 12500,
            damageRange: [40, 65],
            expReward: [500, 500],
            moneyReward: [800, 800],
			reductionMagic: 0.33,
          },
          60: {
            name: "Demon King",
            hp: 16000,
            damageRange: [60, 80],
            expReward: [800, 800],
            moneyReward: [850, 850],
			reductionMagic: 0.5,
          },
		  63: {
            name: "Omni",
            hp: 20000,
            damageRange: [69, 96],
            expReward: [1000, 1000],
            moneyReward: [1000, 1000],
			reductionAttack: 0.5,
			reductionMagic: 0.5,
          },
		  66: {
            name: "Goblin Emperor",
            hp: 15000,
            damageRange: [45, 60],
            expReward: [100, 100],
            moneyReward: [100, 100]
          },
          69: {
            name: "Giant Cyclops, Eater of Men",
            hp: 16500,
            damageRange: [50, 65],
            expReward: [150, 150],
            moneyReward: [150, 150],
          },
		  72: {
            name: "Orc Lord",
            hp: 20000,
            damageRange: [55, 70],
            expReward: [200, 200],
            moneyReward: [200, 200],
			reductionAttack: 0.33,
          },
          75: {
            name: "Medusa, Lady of Stone",
            hp: 17500,
            damageRange: [70, 90],
            expReward: [250, 250],
            moneyReward: [250, 250],
            reductionAttack: 0.5,
          },
		  78: {
            name: "Ogre King",
            hp: 25000,
            damageRange: [60, 70],
            expReward: [300, 300],
            moneyReward: [300, 300],
			reductioMagic: 0.33,
          },
          81: {
            name: "The Minotaur",
            hp: 26000,
            damageRange: [60, 75],
            expReward: [350, 350],
            moneyReward: [350, 350],
			reductionMagic: 0.5,
          },
          84: {
            name: "Arachni Empress",
            hp: 19500,
            damageRange: [70, 90],
            expReward: [360, 360],
            moneyReward: [360, 360],
			reductionAttack: 0.5,
          },
          87: {
            name: "Grand Sorceress",
            hp: 18000,
            damageRange: [80, 105],
            expReward: [400, 400],
            moneyReward: [400, 400],
            reductionMagic: 1,
          },
          90: {
            name: "Primordial Automaton",
            hp: 32000,
            damageRange: [60, 75],
            expReward: [420, 420],
            moneyReward: [420, 420],
            reductionAll: 0.5,
          },
          93: {
            name: "Dragon King",
            hp: 36000,
            damageRange: [75, 110],
            expReward: [450, 450],
            moneyReward: [420, 420],
			reductionAttack: 0.67,
			reductionMagic: 0.33,
          },
          96: {
            name: "Devourer of Worlds",
            hp: 34000,
            damageRange: [60, 70],
            expReward: [480, 480],
            moneyReward: [450, 450],
			reductionAll: 0.33,
          },
          99: {
            name: "Frost Queen, Borealis",
            hp: 30000,
            damageRange: [80, 120],
            expReward: [600, 600],
            moneyReward: [600, 600],
			reductionMagic: 0.5,
          },
          102: {
            name: "Charybdis",
            hp: 38000,
            damageRange: [60, 75],
            expReward: [640, 640],
            moneyReward: [640, 640],
            reductionAttack: 0.5,
          },
		  105: {
            name: "Queen Ant",
            hp: 40000,
            damageRange: [50, 65],
            expReward: [600, 600],
            moneyReward: [600, 600],
            reductionMagic: 0.5,
          },
		  108: {
            name: "Ant King, Beru",
            hp: 50000,
            damageRange: [90, 120],
            expReward: [640, 640],
            moneyReward: [640, 640],
            reductionAll: 0.33,
          },
          111: {
            name: "Seraphim",
            hp: 38500,
            damageRange: [95, 130],
            expReward: [690, 690],
            moneyReward: [650, 650],
            reductionMagic: 0.67,
			reductionAttack: 0.25,
          },
          114: {
            name: "Mega Meta Mecha Annihilator - Model: Grande",
            hp: 45000,
            damageRange: [70, 95],
            expReward: [700, 700],
            moneyReward: [700, 700],
			reductionAttack: 0.67,
          },
          117: {
            name: "Grand Knight II",
            hp: 52000,
            damageRange: [75, 100],
            expReward: [720, 720],
            moneyReward: [720, 720],
            reductionAll: 0.4,
          },
          120: {
            name: "The King of Curses",
            hp: 50000,
            damageRange: [90, 140],
            expReward: [690, 690],
            moneyReward: [420, 420]
		  },
          123: {
            name: "The Restricted One, Kyojiro Allista",
            hp: 75000,
            damageRange: [75, 150],
            expReward: [1000, 1000],
            moneyReward: [0, 0],
			reductionAll: 0.2,
          },
		  126: {
            name: "The Brazen Bull, Khalkotauri",
            hp: 60000,
            damageRange: [60, 85],
            expReward: [500, 500],
            moneyReward: [500, 500],
			reductionAll: 0.33,
          },
		  129: {
            name: "Kraken",
            hp: 65000,
            damageRange: [65, 100],
            expReward: [500, 500],
            moneyReward: [500, 500],
			reductionAttack: 0.33,
          },
		  132: {
            name: "Crab God, Khaos",
            hp: 65500,
            damageRange: [70, 90],
            expReward: [500, 500],
            moneyReward: [500, 500],
          },
		  135: {
            name: "Ghost Leviathan",
            hp: 75000,
            damageRange: [65, 80],
            expReward: [500, 500],
            moneyReward: [500, 500],
			reductionAll: 0.33,
          },
		  138: {
            name: "Island Turtle",
            hp: 85500,
            damageRange: [60, 90],
            expReward: [500, 500],
            moneyReward: [500, 500],
			reductionAll: 0.25,
          },
		  141: {
            name: "The World Serpent, Jörmungandr",
            hp: 100000,
            damageRange: [60, 80],
            expReward: [500, 500],
            moneyReward: [500, 500],
			reductionAll: 0.33,
          },
          144: {
            name: "The Behemoth",
            hp: 65500,
            damageRange: [70, 95],
            expReward: [500, 500],
            moneyReward: [800, 800],
			reductionMagic: 0.33,
          },
          147: {
            name: "Demon God",
            hp: 90000,
            damageRange: [75, 115],
            expReward: [800, 800],
            moneyReward: [850, 850],
			reductionAttack: 0.33,
			reductionMagic: 0.5,
          },
		  150: {
            name: "The Black King",
            hp: 100000,
            damageRange: [70, 130],
            expReward: [1000, 1000],
            moneyReward: [1000, 1000],
			reductionAttack: 0.25,
			reductionMagic: 1,
          },
		  153: {
            name: "Supreme Witch, Calamitas",
            hp: 95000,
            damageRange: [120, 180],
            expReward: [1000, 1000],
            moneyReward: [1000, 1000],
			reductionMagic: 1,
          },
		  156: {
            name: "Warden Of Judgement, Will, And Balance",
            hp: 125000,
            damageRange: [75, 150],
            expReward: [1000, 1000],
            moneyReward: [1000, 1000],
			reductionAll: 0.5,
          },
		  159: {
            name: "King God General Emperor, Supreme Divine Entity of Ultimacy, Archangel & Creator, Gabriel",
            hp: 200000,
            damageRange: [80, 160],
            expReward: [10000, 10000],
            moneyReward: [10000, 10000],
			reductionAttack: 0.67,
			reductionMagic: 0.67
          },
        };
		
         const bossFloors = Object.keys(bosses).map(Number).sort((a, b) => a - b);
        for (let rush of bossFloors) {
			if (floor <= rush) {
				return bosses[rush];
			}
		}
		// If you exceed the highest defined boss, just give the final one
	return bosses[bossFloors[bossFloors.length - 1]];
	}
 
        const bosses = {
          20: {
            name: "Goblin King",
            hp: 500,
            damageRange: [10, 15],
            expReward: [30, 30],
            moneyReward: [30, 30],
          },
          40: {
            name: "Zombie Mutant",
            hp: 1000,
            damageRange: [15, 25],
            expReward: [70, 70],
            moneyReward: [70, 70],
			reductionMagic: 0.5,
          },
          60: {
            name: "Giant Lord",
            hp: 3600,
            damageRange: [10, 20],
            expReward: [100, 100],
            moneyReward: [100, 100],
            reductionAttack: 0.5,
          },
          80: {
            name: "Skeleton King",
            hp: 1500,
            damageRange: [20, 30],
            expReward: [120, 120],
            moneyReward: [120, 120],
			reductionAttack: 0.5,
          },
          100: {
            name: "Spider Queen",
            hp: 2100,
            damageRange: [20, 35],
            expReward: [150, 150],
            moneyReward: [150, 150]
          },
          120: {
            name: "The Witch",
            hp: 2000,
            damageRange: [40, 60],
            expReward: [180, 180],
            moneyReward: [180, 180],
            reductionMagic: 0.5,
          },
          140: {
            name: "Titan Golem",
            hp: 8000,
            damageRange: [20, 30],
            expReward: [210, 210],
            moneyReward: [210, 210],
            reductionAll: 0.33,
          },
          160: {
            name: "Wyvern",
            hp: 9500,
            damageRange: [35, 70],
            expReward: [240, 240],
            moneyReward: [240, 240],
			reductionAttack: 0.5,
          },
          180: {
            name: "Giant Sandworm",
            hp: 7000,
            damageRange: [35, 60],
            expReward: [250, 250],
            moneyReward: [250, 250]
          },
          200: {
            name: "Titanoboa Lord",
            hp: 8000,
            damageRange: [40, 65],
            expReward: [280, 280],
            moneyReward: [280, 280]
          },
          220: {
            name: "Abominable Snowman",
            hp: 7500,
            damageRange: [50, 75],
            expReward: [300, 300],
            moneyReward: [300, 300]
          },
          240: {
            name: "Omegalodon",
            hp: 9000,
            damageRange: [45, 60],
            expReward: [320, 320],
            moneyReward: [320, 320],
            reductionAttack: 0.5,
          },
          260: {
            name: "Leviathan",
            hp: 12000,
            damageRange: [50, 65],
            expReward: [360, 360],
            moneyReward: [360, 360],
            reductionAttack: 0.33,
          },
          280: {
            name: "Angel",
            hp: 9000,
            damageRange: [60, 90],
            expReward: [400, 400],
            moneyReward: [400, 400],
            reductionMagic: 0.5,
          },
          300: {
            name: "Mega Meta Mecha Annihilator - Model: Ultima",
            hp: 12500,
            damageRange: [50, 75],
            expReward: [420, 420],
            moneyReward: [500, 500],
			reductionAttack: 0.5,
          },
          320: {
            name: "Grand Knight",
            hp: 12000,
            damageRange: [60, 90],
            expReward: [480, 480],
            moneyReward: [480, 480],
            reductionAll: 0.33,
          },
          340: {
            name: "Six-Eyed Calamity",
            hp: 10000,
            damageRange: [90, 125],
            expReward: [600, 600],
            moneyReward: [560, 560],
            reductionAll: 0.33,
		  },
          360: {
            name: "Hydra",
            hp: 12000,
            damageRange: [80, 120],
            expReward: [900, 900],
            moneyReward: [800, 800],
			reductionAttack: 0.5,
          },
          380: {
            name: "Guardian of Hell, Cerberus",
            hp: 12500,
            damageRange: [60, 95],
            expReward: [500, 500],
            moneyReward: [800, 800],
			reductionMagic: 0.33,
          },
          400: {
            name: "Demon King",
            hp: 16000,
            damageRange: [85, 120],
            expReward: [800, 800],
            moneyReward: [850, 850],
			reductionMagic: 0.5,
          },
		  420: {
            name: "Omni",
            hp: 20000,
            damageRange: [90, 130],
            expReward: [1000, 1000],
            moneyReward: [1000, 1000],
			reductionAttack: 0.5,
			reductionMagic: 0.5,
          },
		  440: {
            name: "Goblin Emperor",
            hp: 15000,
            damageRange: [60, 80],
            expReward: [100, 100],
            moneyReward: [100, 100]
          },
          460: {
            name: "Giant Cyclops, Eater of Men",
            hp: 16500,
            damageRange: [65, 90],
            expReward: [150, 150],
            moneyReward: [150, 150],
          },
		  480: {
            name: "Orc Lord",
            hp: 20000,
            damageRange: [60, 85],
            expReward: [200, 200],
            moneyReward: [200, 200],
			reductionAttack: 0.33,
          },
          500: {
            name: "Medusa, Lady of Stone",
            hp: 17500,
            damageRange: [90, 115],
            expReward: [250, 250],
            moneyReward: [250, 250],
            reductionAttack: 0.5,
          },
		  520: {
            name: "Ogre King",
            hp: 25000,
            damageRange: [70, 90],
            expReward: [300, 300],
            moneyReward: [300, 300],
			reductionMagic: 0.33,
          },
          540: {
            name: "The Minotaur",
            hp: 26000,
            damageRange: [70, 100],
            expReward: [350, 350],
            moneyReward: [350, 350],
			reductionMagic: 0.5,
          },
          560: {
            name: "Arachni Empress",
            hp: 19500,
            damageRange: [75, 110],
            expReward: [360, 360],
            moneyReward: [360, 360],
			reductionAttack: 0.5,
          },
          580: {
            name: "Grand Sorceress",
            hp: 18000,
            damageRange: [100, 125],
            expReward: [400, 400],
            moneyReward: [400, 400],
            reductionMagic: 1,
          },
          600: {
            name: "Primordial Automaton",
            hp: 32000,
            damageRange: [90, 110],
            expReward: [420, 420],
            moneyReward: [420, 420],
            reductionAll: 0.5,
          },
          620: {
            name: "Dragon King",
            hp: 36000,
            damageRange: [100, 120],
            expReward: [450, 450],
            moneyReward: [420, 420],
			reductionAttack: 0.67,
			reductionMagic: 0.33,
          },
          640: {
            name: "Devourer of Worlds",
            hp: 34000,
            damageRange: [80, 90],
            expReward: [480, 480],
            moneyReward: [450, 450],
			reductionAll: 0.33,
          },
          660: {
            name: "Frost Queen, Borealis",
            hp: 30000,
            damageRange: [100, 140],
            expReward: [600, 600],
            moneyReward: [600, 600],
			reductionMagic: 0.5,
          },
          680: {
            name: "Charybdis",
            hp: 38000,
            damageRange: [70, 95],
            expReward: [640, 640],
            moneyReward: [640, 640],
            reductionAttack: 0.5,
          },
		  700: {
            name: "Queen Ant",
            hp: 40000,
            damageRange: [60, 90],
            expReward: [600, 600],
            moneyReward: [600, 600],
            reductionMagic: 0.5,
          },
		  720: {
            name: "Ant King, Beru",
            hp: 50000,
            damageRange: [95, 130],
            expReward: [640, 640],
            moneyReward: [640, 640],
            reductionAll: 0.33,
          },
          740: {
            name: "Seraphim",
            hp: 38500,
            damageRange: [100, 150],
            expReward: [690, 690],
            moneyReward: [650, 650],
            reductionMagic: 0.67,
			reductionAttack: 0.25,
          },
          760: {
            name: "Mega Meta Mecha Annihilator - Model: Grande",
            hp: 45000,
            damageRange: [90, 120],
            expReward: [700, 700],
            moneyReward: [700, 700],
			reductionAttack: 0.67,
          },
          780: {
            name: "Grand Knight II",
            hp: 52000,
            damageRange: [90, 125],
            expReward: [720, 720],
            moneyReward: [720, 720],
            reductionAll: 0.4,
          },
          800: {
            name: "The King of Curses",
            hp: 50000,
            damageRange: [120, 160],
            expReward: [690, 690],
            moneyReward: [420, 420]
		  },
          820: {
            name: "The Restricted One, Kyojiro Allista",
            hp: 75000,
            damageRange: [75, 150],
            expReward: [1000, 1000],
            moneyReward: [0, 0],
			reductionAll: 0.2,
          },
		  840: {
            name: "The Brazen Bull, Khalkotauri",
            hp: 60000,
            damageRange: [75, 100],
            expReward: [500, 500],
            moneyReward: [500, 500],
			reductionAll: 0.33,
          },
		  860: {
            name: "Kraken",
            hp: 65000,
            damageRange: [80, 115],
            expReward: [500, 500],
            moneyReward: [500, 500],
			reductionAttack: 0.33,
          },
		  880: {
            name: "Crab God, Khaos",
            hp: 65500,
            damageRange: [75, 100],
            expReward: [500, 500],
            moneyReward: [500, 500],
          },
		  900: {
            name: "Ghost Leviathan",
            hp: 75000,
            damageRange: [80, 110],
            expReward: [500, 500],
            moneyReward: [500, 500],
			reductionAll: 0.33,
          },
		  920: {
            name: "Island Turtle",
            hp: 85500,
            damageRange: [75, 100],
            expReward: [500, 500],
            moneyReward: [500, 500],
			reductionAll: 0.25,
          },
		  940: {
            name: "The World Serpent, Jörmungandr",
            hp: 100000,
            damageRange: [80, 105],
            expReward: [500, 500],
            moneyReward: [500, 500],
			reductionAll: 0.33,
          },
          960: {
            name: "The Behemoth",
            hp: 65500,
            damageRange: [90, 120],
            expReward: [500, 500],
            moneyReward: [800, 800],
			reductionMagic: 0.33,
          },
          980: {
            name: "Demon God",
            hp: 90000,
            damageRange: [120, 150],
            expReward: [800, 800],
            moneyReward: [850, 850],
			reductionAttack: 0.33,
			reductionMagic: 0.5,
          },
		  1000: {
            name: "The Black King",
            hp: 100000,
            damageRange: [100, 180],
            expReward: [1000, 1000],
            moneyReward: [1000, 1000],
			reductionAttack: 0.25,
			reductionMagic: 1,
          },
		  1020: {
            name: "Supreme Witch, Calamitas",
            hp: 95000,
            damageRange: [120, 180],
            expReward: [1000, 1000],
            moneyReward: [1000, 1000],
			reductionMagic: 1,
          },
		  1040: {
            name: "Warden Of Judgement, Will, And Balance",
            hp: 125000,
            damageRange: [75, 150],
            expReward: [1000, 1000],
            moneyReward: [1000, 1000],
			reductionAll: 0.5,
          },
		  1060: {
            name: "King God General Emperor, Supreme Divine Entity of Ultimacy, Archangel & Creator, Gabriel",
            hp: 200000,
            damageRange: [80, 160],
            expReward: [10000, 10000],
            moneyReward: [10000, 10000],
			reductionAttack: 0.67,
			reductionMagic: 0.67
          },
        };
		
         const bossFloors = Object.keys(bosses).map(Number).sort((a, b) => a - b);
        for (let thresh of bossFloors) {
			if (floor <= thresh) {
				return bosses[thresh];
			}
		}
		// If you exceed the highest defined boss, just give the final one
	return bosses[bossFloors[bossFloors.length - 1]];
	}

      function getAllowedEnemies() {
		if (gameDifficulty === "doom") {
			// Only these in Hell:
			const hellOnly = ["Demon", "Imp", "Archdem﻿on", "Sinner", "Ghoul", "Skeleton", "Possessed Armor", "Mancubus", "Cacodemon", "Gargoyle", "Cyberdemon", "Baron", "Hell Knight"];
			return enemies.filter(e => hellOnly.includes(e.name));
		}
        const nextBossFloor = Math.ceil(floorCount / 20) * 20;
        const nextBoss = getBossForFloor(nextBossFloor);
        let allowed = [];
        switch (nextBoss.name) {
          case "Goblin King":
            allowed = ["Monster Crow", "Wolf", "Bear", "Goblin"];
            break;
		  case "Goblin Emperor":
            allowed = ["Monster Crow", "Bull", "Dire Wolf", "Dire Bear", "Goblin", "Hobgoblin"];
            break;
		  case "Orc Lord":
		    allowed = ["Orc", "Hobgoblin", "Dire Wolf", "Dire Bear", "Orc Berserker", "High Orc", "Snake", "Monster Crow"];
			break;
		  case "Ogre King":
		    allowed = ["Ogre", "Ogre Mage", "Skeleton", "Skeleton King", "Golem", "Giant Spider", "Ghoul", "Zombie"];
			break;
          case "Zombie Mutant":
            allowed = ["Zombie", "Skeleton", "Ghoul", "Demon Bat", "Monster Crow", "Giant Spider", "Werewolf"];
            break;
		  case "Giant Cyclops, Eater of Men":
            allowed = ["Zombie", "Skeleton", "Bull", "Ghoul", "Demon Bat", "Monster Crow", "Giant Spider", "Hobgoblin"];
            break;
          case "Giant Lord":
            allowed = ["Skeleton", "Wolf", "Goblin", "Bear", "Monster Crow"];
            break;
		  case "Medusa, Lady of Stone":
            allowed = ["Skeleton", "Dire Wolf", "Snake", "Gorgon", "Hobgoblin", "Dire Bear", "Monster Crow"];
            break;
          case "Skeleton King":
            allowed = ["Zombie", "Skeleton", "Ghoul", "Demon Bat", "Monster Crow", "Giant Spider", "Possessed Armor", "Werewolf"];
            break;
		  case "The Minotaur":
            allowed = ["Zombie", "Bull", "Skeleton", "Ghoul", "Demon Bat", "Monster Crow", "Giant Spider", "Possessed Armor"];
            break;
          case "Spider Queen":
            allowed = ["Giant Spider", "Demon Bat", "Golem", "Ghoul", "Giant Scorpion", "Goblin"];
            break;
		  case "Arachni Empress":
            allowed = ["Giant Spider", "Demon Bat", "Golem", "Ghoul", "Giant Scorpion", "Hobgoblin"];
            break;
          case "The Witch":
            allowed = ["Giant Spider", "Snake", "Demon Bat", "Monster Crow", "Ghoul", "Piranha", "Skeleton", "Zombie"];
            break;
		  case "Grand Sorceress":
            allowed = ["Giant Spider", "Gorgon", "Demon Bat", "Monster Crow", "Ghoul", "Piranha", "Skeleton", "Mutant Zombie"];
            break;
          case "Titan Golem":
            allowed = ["Golem", "Demon Bat", "Giant Crow", "Skeleton", "Wolf", "Bear", "Giant Spider"];
            break;
		  case "Primordial Automaton":
            allowed = ["Golem", "Demon Bat", "Giant Crow", "Skeleton King", "Dire Wolf", "Bull", "Gorgon", "Dire Bear", "Giant Spider"];
            break;
          case "Wyvern":
            allowed = ["Golem", "Demon Bat", "Gorgon", "Goblin", "Skeleton", "Giant Spider", "Ghoul", "Possessed Armor"];
            break;
          case "Giant Sandworm":
            allowed = ["Giant Scorpion", "Sandworm", "Skeleton", "Zombie", "Vulture"];
            break;
		  case "Devourer of Worlds":
            allowed = ["Giant Scorpion", "Golem", "Ghoul", "Giant Sandworm", "Skeleton", "Mutant Zombie", "Vulture"];
            break;
          case "Titanoboa Lord":
            allowed = ["Sandworm", "Snake", "Goblin", "Golem", "Skeleton", "Giant Spider"];
            break;
		  case "The World Serpent, Jörmungandr":
            allowed = ["Giant Sandworm", "Titanoboa Lord", "Hobgoblin", "Titan Golem", "Golem", "Skeleton", "Giant Spider", "Snake", "Piranha", "Shark"];
            break;
          case "Abominable Snowman":
            allowed = ["Ice Golem", "Ice Spirit", "Snowman", "Possessed Armor", "Skeleton"];
            break;
		  case "Frost Queen, Borealis":
            allowed = ["Ice Golem", "Ice Spirit", "Snowman", "Frost Knight", "Skeleton King", "Skeleton"];
            break;
          case "Omegalodon":
            allowed = ["Piranha", "Shark"];
            break;
          case "Leviathan":
            allowed = ["Piranha", "Shark", "Giant Albatross"];
            break;
		  case "Charybdis":
            allowed = ["Piranha", "Shark", "Omegalodon", "Giant Albatross"];
            break;
		  case "Kraken":
		    allowed = ["Piranha", "Shark", "Omegalodon", "Giant Albatross"];
			break;
		  case "Crab God, Khaos":
		    allowed = ["Crab", "Iron Crab", "King Crab", "Giant Crab", "Spider Crab", "Giant Albatross", "Skeleton"];
			break;
		  case "Ghost Leviathan":
		    allowed = ["Piranha", "Shark", "Omegalodon", "Giant Albatross", "Ghoul"];
			break;
		  case "Island Turtle":
		    allowed = ["Crab", "Iron Crab", "King Crab", "Giant Crab", "Spider Crab", "Giant Albatross", "Piranha", "Shark", "Omegalodon", "Snake", "Skeleton", "Giant Spider", "Dire Wolf", "Dire Bear", "Bull"];
			break;
		  case "Queen Ant":
			allowed = ["Skeleton", "Ant Swarm", "Giant Warrior Ant", "Giant Worker Ant", "Giant Drone Ant"];
			break;
		  case "Ant King, Beru":
			allowed = ["Skeleton", "Ant Swarm", "Giant Warrior Ant", "Giant Worker Ant", "Giant Black Ant"];
			break;
          case "Angel":
            allowed = ["Giant Albatross", "Vulture", "Ghoul", "Ice Spirit", "Monster Crow", "Demon Bat"];
            break;
		  case "Seraphim":
            allowed = ["Giant Albatross", "Vulture", "Ghoul", "Ice Spirit", "Monster Crow", "Demon Bat", "Angel"];
            break;
          case "Mega Meta Mecha Annihilator - Model: Ultima":
            allowed = ["Cyborg Guard", "Giant Robot", "Drone"];
            break;
		  case "Mega Meta Mecha Annihilator - Model: Grande":
            allowed = ["Cyborg Guard", "Giant Robot", "Drone", "Jeager"];
            break;
          case "Grand Knight":
            allowed = ["Skeleton", "Wolf", "Bear", "Possessed Armor", "Golem"];
            break;
		  case "Grand Knight II":
            allowed = ["Skeleton", "Dire Wolf", "Dire Bear", "Bull", "Gorgon", "Snake", "Possessed Armor", "Golem"];
            break;
          case "Six-Eyed Calamity":
            allowed = ["Cursed Spirit", "Shikigami", "Sorcerer"];
            break;
		  case "The King of Curses":
            allowed = ["Cursed Spirit", "Shikigami", "Sorcerer"];
            break;
		  case "Guardian of Hell, Cerberus":
            allowed = ["Demon", "Imp", "Archdemon"];
            break;
		  case "The Behemoth":
            allowed = ["Demon", "Imp", "Archdemon", "Sinner"];
            break;
		  case "Demon King":
            allowed = ["Demon", "Imp", "Archdemon", "Sinner"];
            break;
		  case "Demon God":
            allowed = ["Demon", "Imp", "Archdemon", "Sinner", "Mancubus", "Cyberdemon", "Cacodemon", "Gargoyle", "Baron", "Hell Knight"];
            break;
          case "Hydra":
            allowed = ["Goblin", "Gorgon", "Zombie", "Skeleton", "Golem", "Monster Crow", "Wolf", "Ghoul", "Giant Spider", "Demon Bat"];
            break;
		  case "The Restricted One, Kyojiro Allista":
            allowed = ["Goblin", "Gorgon", "Zombie", "Skeleton", "Golem", "Monster Crow", "Wolf", "Ghoul", "Giant Spider", "Demon Bat"];
            break;
		  case "The Brazen Bull, Khalkotauri":
			allowed = ["Bull", "Dire Wolf", "Dire Bear", "Hobgoblin", "Monster Crow", "Demon Bat", "Vulture", "Snake"];
			break;
		  case "Dragon King":
            allowed = ["Hobgoblin", "Gorgon", "Mutant Zombie", "Skeleton", "Titan Golem", "Monster Crow", "Dire Wolf", "Ghoul", "Possessed Armor", "Giant Spider", "Demon Bat"];
            break;
          case "Omni":
            allowed = ["Goblin", "Zombie", "Skeleton", "Golem", "Monster Crow", "Wolf", "Werewolf", "Ghoul", "Giant Spider", "Demon Bat", "Giant Scorpion", "Ice Golem", "Ice Spirit", "Piranha", "Shark", "Giant Albatross", "Vulture", "Sandworm", "Possessed Armor", "Bear", "Drone", "Cyborg Guard", "Giant Robot", "Shikigami", "Sorcerer", "Cursed Spirit", "Demon", "Imp", "Archdemon", "Frost Knight", "Orc", "Orc Berserker", "High Orc", "Ogre", "Ogre Mage", "Ant Swarm", "Giant Worker Ant", "Giant Warrior Ant", "Giant Drone Ant", "Giant Black", "Crab", "Iron Crab", "Giant Crab", "King Crab", "Spider Crab"];
            break;
		  case "The Black King":
            allowed = ["Ghoul"];
            break;
		  case "Supreme Witch, Calamitas":
		    allowed = ["Ghoul"];
            break;
		  case "Warden Of Judgement, Will, And Balance":
            allowed = ["Angel", "Archdemon", "Possessed Armor", "Ghoul", "Seraphim"];
            break;
		  case "King God General Emperor, Supreme Divine Entity of Ultimacy, Archangel & Creator, Gabriel":
            allowed = ["Goblin King", "Medusa, Lady of Stone", "Giant Cyclops, Eater of Men", "The Minotaur", "Seraphim", "Devourer of Worlds", "Goblin Emperor", "Frost Queen, Borealis", "The World Serpent, Jörmungandr", "Charybdis", "Primordial Automaton", "Grand Sorceress", "Arachni Empress", "The Brazen Bull, Khalkotauri", "Seraphim", "Grand Knight II", "Mega Meta Mecha Annihilator - Model: Grande", "Mutant Zombie", "Giant Lord", "Skeleton King", "Spider Queen", "The Witch", "Titan Golem", "Wyvern", "Giant Sandworm", "Titanoboa Lord", "Abominable Snowman", "Omegalodon", "Leviathan", "Angel", "Mega Meta Mecha Annihilator - Model: Ultima", "Grand Knight", "Six-Eyed Calamity", "The King of Curses", "Queen Ant", "Ant King, Beru", "Orc Lord", "Ogre King", "Kraken", "Crab King", "Ghost Leviathan", "Island Turtle", "Dragon King", "Guardian of Hell, Cerberus", "The Behemoth", "Demon King", "The Black King", "Supreme Witch, Calamitas", "Omni"];
            break;
          default:
            allowed = ["Goblin", "Zombie", "Skeleton", "Golem", "Monster Crow", "Wolf", "Werewolf", "Ghoul", "Giant Spider", "Demon Bat", "Giant Scorpion", "Ice Golem", "Ice Spirit", "Piranha", "Shark", "Giant Albatross", "Vulture", "Sandworm", "Possessed Armor", "Bear", "Drone", "Cyborg Guard", "Giant Robot", "Shikigami", "Sorcerer", "Cursed Spirit", "Demon", "Imp", "Archdemon", "Frost Knight"];
        }
        return enemies.filter(e => allowed.includes(e.name));
	  }

      // ─── Shop Items list ───
let shopItemsList = [
  // Consumables
  {
	name: "Healing Potion",
	cost: 50,
	type: "healing",
	category: "consumable",
	usableInBattle: true,
	usableOutOfBattle: true,
	usageScope: "both",
	description: "Restores a portion of a warrior's HP on consumption.",
  },
  {
	name: "Mana Potion",
	cost: 50,
	type: "mana",
	category: "consumable",
	usableInBattle: true,
	usableOutOfBattle: true,
	usageScope: "both",
	description: "Recharges a warrior's magical power on consumption.",
  },
  {
    name: "Rage Potion",
    cost: 150,
    type: "rage",
    category: "consumable",
    usableInBattle: true,
    usableOutOfBattle: false,
    usageScope: "battle",
	description: "Force-activates a warrior's 'fight' instinct and adrenaline receptors on consumption.",
  },
  {
    name: "Poison Potion",
    cost: 150,
    type: "poison",
    category: "consumable",
    usableInBattle: true,
    usableOutOfBattle: false,
    usageScope: "battle",
	description: "Throw at a target to poison them with toxic and acidic chemicals. DO NOT CONSUME.",
  },
  {
  name: "Frost Potion",
  cost: 150,
  type: "freeze",
    category: "consumable",
  usableInBattle: true,
  usableOutOfBattle: false,
  usageScope: "battle",
	description: "Throw on a target to completely freeze them in their tracks. DO NOT CONSUME.",
  },
  {
  name: "Molotov",
  cost: 200,
  type: "burned",
    category: "consumable",
  usableInBattle: true,
  usableOutOfBattle: false,
  usageScope: "battle",
	description: "A simple bottle filled with flammable gas and a flame at the end. Throw at enemies to set them on fire.",
  },
  {
    name: "Weaken Potion",
    cost: 150,
    type: "weaken",
    category: "consumable",
    usableInBattle: true,
    usableOutOfBattle: false,
    usageScope: "battle",
	description: "Throw on a target to make them slower and weaker. DO NOT CONSUME.",
  },
  {
    name: "Lullaby Potion",
    cost: 150,
    type: "asleep",
    category: "consumable",
    usableInBattle: true,
    usableOutOfBattle: false,
    usageScope: "battle",
	description: "Use on a target to put them to sleep. DO NOT CONSUME.",
  },
  {
    name: "Iron Potion",
    cost: 150,
    type: "iron",
    category: "consumable",
    usableInBattle: true,
    usableOutOfBattle: false,
    usageScope: "battle",
	description: "Increases a warrior's defense on consumption.",
  },
  {
    name: "Shock Potion",
    cost: 150,
    type: "paralyzed",
    category: "consumable",
    usableInBattle: true,
    usableOutOfBattle: false,
    usageScope: "battle",
	description: "Use on a target to shock and paralyze them. DO NOT CONSUME.",
  },

  // Equipment (must be equipped to work)
  // ─ Accessories ─
  {
    name: "Scarf",
    cost: 300,
    type: "equipment",
    category: "accessory",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "A piece of cloth with a unique attribute, allowing its wearers to be stealthier, faster, and more perceptive.",
  },
  {
    name: "Ring",
    cost: 500,
    type: "equipment",
    category: "accessory",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "A simple ring.",
  },
  {
    name: "Glasses",
    cost: 320,
    type: "equipment",
    category: "accessory",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Simple glasses, helps visually-impaired warriors see better.",
  },
  {
    name: "Dice",
    cost: 1000,
    type: "equipment",
    category: "accessory",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "More of a charm, but this dice allows warriors to be a lot luckier than normal.",
  },
  {
    name: "Sharpener",
    cost: 360,
    type: "equipment",
    category: "accessory",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Allows warriors to sharpen their melee equipment, allowing for more efficient kills.",
  },

  // ─ Armors ─
  {
    name: "Armor",
    cost: 300,
    type: "equipment",
    category: "armor",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "The generic plated armor for warriors to use in battle.",
  },
  {
    name: "Cloak",
    cost: 280,
    type: "equipment",
    category: "armor",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "This piece of clothing has a unique attribute of allowing warriors to be faster, stealthier, and more perceptive.",
  },
  {
    name: "Robe",
    cost: 320,
    type: "equipment",
    category: "armor",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "A mysterious piece of clothing flowing with a magical aura.",
  },

  // ─ Weapons ─
  {
    name: "Sword",
    cost: 320,
    type: "equipment",
    category: "weapon",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "The starter weapon for a beginner or greater melee-type warrior. Sharp and efficient, it allows you to cut down foes with ease.",
  },
  {
    name: "Gauntlets",
    cost: 320,
    type: "equipment",
    category: "weapon",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Allows warriors to amplify their punching power even more greatly. With the added metal and weights, these allow you to truly wreak havoc.",
  },
  {
    name: "Shield",
    cost: 400,
    type: "equipment",
    category: "dual-wieldable",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "The best offense is a good defense. Defend and attack with the shield's weight and durability.",
  },
  {
    name: "Dagger",
    cost: 320,
    type: "equipment",
    category: "dual-wieldable",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "A lightweight, efficient weapon that can be dual-wielded. Great for fast kills.",
  },
  {
    name: "Greatsword",
    cost: 360,
    type: "equipment",
    category: "weapon",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Heavy, but powerful, allowing you to land devastating strikes from all around.",
  },
  {
    name: "Warhammer",
    cost: 500,
    type: "equipment",
    category: "weapon",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Extremely heavy, but very powerful, allowing you to smash foes to bits.",
  },
  {
    name: "Spear",
    cost: 360,
    type: "equipment",
    category: "weapon",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Heavy, but powerful, allowing you to jab with great force and even throw with great accuracy.",
  },
  {
    name: "Wand",
    cost: 320,
    type: "equipment",
    category: "weapon",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Simple, efficient, light, mobile, and destructive. A perfect weapon for a beginner or greater mage.",
  },
  {
    name: "Staff",
    cost: 360,
    type: "equipment",
    category: "weapon",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "A heavy weapon that allows warriors to focus their magic into a singular point and blast it all towards a target.",
  },
];

      /*******************
       * INITIALIZATION
       *******************/
	  function showDifficultyMenu() {
  document.getElementById("titleScreen").style.display = "none";
  document.getElementById("difficultyMenu").style.display = "block";
  document.getElementById("abilityMenu").style.display   = "none";
  battleTint.style.display = "block";
}

// Called when player clicks Easy/Normal/Hard
function selectDifficulty(difficulty) {
  gameDifficulty = difficulty;
  document.getElementById("difficultyMenu").style.display = "none";
  if (difficulty === "doom") {
   document.getElementById("miscStats").style.display = "none";
   document.getElementById("miscStats2").style.display = "none";

	["hp", "potential", "luck", "fortune"].forEach(stat => {
		const btn     = levelUpMenu.querySelector(`button[data-stat="${stat}"]`);
		const span  = levelUpMenu.querySelector(stat === "hp" ? "#hpText" : `#${stat}Stat`);
		const label   = levelUpMenu.querySelector(`#${stat === "hp" ? "hpText" : stat + "Stat"}`);
		if (btn) {
			btn.style.display = "none";
			if (stat === "hp") {
				// also remove the literal "HP: " text node that lives right after the button
				const txtNode = btn.nextSibling;
				if (txtNode && txtNode.nodeType === Node.TEXT_NODE) {
				txtNode.textContent = "";
				}
			}
		}
		if (span) {
			span.style.display = "none";
		}
		if (label) label.style.display = "none";
	});
   titleMusic.pause();
   document.getElementById("abilityMenu").style.display = "none";
   const doomNames = [
    "The Doom Slayer",
    "Hellwalker",
    "Unchained Predator",
    "Scourge of Hell",
    "Demon Slayer",
	"Heavensent Executioner",
   ];
   // Pick one at random
   const rand = Math.floor(Math.random() * doomNames.length);
   // Overwrite the player's chosen ability name
   player.doomAbilities = doomNames[rand];

   // Update whatever UI shows the ability title:
   // (Use your existing element—here’s a generic example)
   document.getElementById("hudPlayerPassive").textContent = player.doomAbilities;
   document.getElementById("hudPlayerActive" ).innerText = "Rip and Tear";
   initGame();
   document.body.classList.add("doom-mode");
   magicBtn.innerText = "Shoot";
   document.querySelectorAll('[data-stat="magic"]').forEach(el => {
  el.innerText = "Arsenal";
  });

// 2) Replace every “Magic:” and “Mana:” label in your stats panel
const statsEl = document.getElementById("stats");
if (statsEl) {
  statsEl.innerHTML = statsEl.innerHTML
    .replace(/Magic:/g, "Arsenal:")
    .replace(/Mana:/g,  "Ammo:");
}

// 3) Rename the level‑up menu’s “Magic” button and labels
const levelUpEl = document.getElementById("levelUpMenu");
if (levelUpEl) {
  // button text
  levelUpEl.querySelectorAll('button[data-stat="magic"]').forEach(btn => {
    btn.innerText = "Arsenal";
  });
  // any inline labels
  levelUpEl.innerHTML = levelUpEl.innerHTML
    .replace(/Magic:/g, "Arsenal:")
    .replace(/Mana:/g,  "Ammo:");
}

// 4) Make sure your mana‑display now reads “Ammo”
const manaBtns = document.querySelectorAll('[data-stat="mana"]');
manaBtns.forEach(el => el.innerText = "Ammo");

shopItemsList = [
	{
	name: "Medkit",
	cost: 60,
	type: "healing",
	category: "consumable",
	usableInBattle: true,
	usableOutOfBattle: true,
	usageScope: "both",
	description: "Allows the Slayer to regenerate on field without a Heal Station.",
  },
  {
	name: "Magazine",
	cost: 60,
	type: "mana",
	category: "consumable",
	usableInBattle: true,
	usableOutOfBattle: true,
	usageScope: "both",
	description: "Allows the Slayer to reload his weapons' ammo.",
  },
  {
    name: "Adrenaline",
    cost: 200,
    type: "rage",
    category: "consumable",
    usableInBattle: true,
    usableOutOfBattle: false,
    usageScope: "battle",
	description: "Force-activates the Slayer's true violent nature, allowing him to brutalize even more demons.",
  },
  {
    name: "Gas Bomb",
    cost: 200,
    type: "poison",
    category: "consumable",
    usableInBattle: true,
    usableOutOfBattle: false,
    usageScope: "battle",
	description: "Releases toxic gases when thrown, poisoning any enemy nearby.",
  },
  {
  name: "Subzero Bomb",
  cost: 200,
  type: "freeze",
    category: "consumable",
  usableInBattle: true,
  usableOutOfBattle: false,
  usageScope: "battle",
	description: "Releases subzero temperature nitrogen gases when thrown, freezing any enemy that gets in the Slayer's way.",
  },
  {
    name: "Sleeping Gas",
    cost: 200,
    type: "weaken",
    category: "consumable",
    usableInBattle: true,
    usableOutOfBattle: false,
    usageScope: "battle",
	description: "Releases sleeping gas when thrown, weakening and putting enemies affected to sleep.",
  },
  {
    name: "EMP Grenade",
    cost: 200,
    type: "paralyzed",
    category: "consumable",
    usableInBattle: true,
    usableOutOfBattle: false,
    usageScope: "battle",
	description: "Releases powerful, electromagnetic pulses when thrown, shocking and paralyzing anything in the vicinity.",
  },
  {
    name: "Armor+",
    cost: 250,
    type: "iron",
    category: "consumable",
    usableInBattle: true,
    usableOutOfBattle: false,
    usageScope: "battle",
	description: "The Slayer's main source of defense.",
  },

  // Equipment (must be equipped to work)
  // ─ Accessories ─
  {
    name: "Mobility Rune",
    cost: 400,
    type: "equipment",
    category: "accessory",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Boosts the Slayer's speed and agility when active.",
  },
  {
    name: "Brutality Rune",
    cost: 400,
    type: "equipment",
    category: "accessory",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Boosts the Slayer's brutality when active, allowing for sure-kills to any demon that gets in his way.",
  },
  {
    name: "Savagery Rune",
    cost: 400,
    type: "equipment",
    category: "accessory",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Boosts the Slayer's violent creativity when active.",
  },
  {
    name: "Violence Rune",
    cost: 400,
    type: "equipment",
    category: "accessory",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Boosts the Slayer's strength and overall power when active.",
  },
  {
    name: "Armor Rune",
    cost: 400,
    type: "equipment",
    category: "accessory",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Boosts the Slayer's defenses when active.",
  },
  {
    name: "Arsenal Rune",
    cost: 400,
    type: "equipment",
    category: "accessory",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Boosts the Slayer's weapon proficiency when active.",
  },

  // ─ Armors ─
  {
    name: "Armor",
    cost: 420,
    type: "equipment",
    category: "armor",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Armor.",
  },
  {
    name: "Cloak",
    cost: 400,
    type: "equipment",
    category: "armor",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "This piece of clothing has a unique attribute of allowing warriors to be faster, stealthier, and more perceptive.",
  },
  {
    name: "Mantle",
    cost: 500,
    type: "equipment",
    category: "armor",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "An epic looking cape that helps the Slayer's primeval weapon-handling.",
  },

  // ─ Weapons ─
  {
    name: "Chainsaw",
    cost: 450,
    type: "equipment",
    category: "weapon",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "A violent, awesome way to kill demons.",
  },
  {
    name: "Gauntlets",
    cost: 450,
    type: "equipment",
    category: "weapon",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Why just punch when you can punch even harder?",
  },
  {
    name: "Chainshield",
    cost: 500,
    type: "equipment",
    category: "dual-wieldable",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "Takes 'defense is the best offense' to a whole new level.",
  },
  {
    name: "Doomblade Arm Upgrade",
    cost: 420,
    type: "equipment",
    category: "dual-wieldable",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "An attachment to the Slayer's armor and weapons, allowing more versatility in battle.",
  },
  {
    name: "Sentinel Hammer",
    cost: 480,
    type: "equipment",
    category: "weapon",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "A heavy, powerful hammer filled with positive-energy, and is kinetic-energy absorbant, given to the Slayer by the Night Sentinels.",
  },
  {
    name: "Energy Spear",
    cost: 450,
    type: "equipment",
    category: "weapon",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "A positive-energy spear given to the Slayer by the Night Sentinels.",
  },
  {
    name: "Combat Shotgun",
    cost: 420,
    type: "equipment",
    category: "weapon",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "A powerful shotgun used by the Slayer to slay demons for thousands of years.",
  },
  {
    name: "Unmayker",
    cost: 600,
    type: "equipment",
    category: "weapon",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "A powerful weapon charged up with demonic energy to use it against the demons.",
  },
  {
    name: "Flame Belch",
    cost: 550,
    type: "equipment",
    category: "weapon",
    usableInBattle: false,
    usableOutOfBattle: false,
    usageScope: "passive",
	description: "An attachment to the Slayer's armor and weapons, allowing him to incinerate anything in his way.",
  },
];
   
   // ——— Doom starting stats override ———
const effMaxHp = Math.floor(getEffectiveMaxHp());
// Core stats
player.level       = 1;
player.hp          = 200;
player.maxHp       = 133.5;
player.armor       = 150;
player.maxArmor    = 150;
player.attack      = 8;
player.magic       = 8;
player.defense     = 1;
player.agility     = 1;
player.perception  = 1;
player.potential   = 0;
player.luck        = 0;
player.fortune     = 0;
player.mana      = 10;
player.maxMana     = 10;
player.expToLevel = 20;
player.money = 500;

// True “baseStats” (for future level-up scaling)
player.baseStats.maxHp      = 133.5;
player.baseStats.maxArmor   = 150;
player.baseStats.attack     = 8;
player.baseStats.magic      = 8;
player.baseStats.defense    = 1;
player.baseStats.agility    = 1;
player.baseStats.perception = 1;
player.baseStats.potential  = 0;
player.baseStats.luck       = 0;
player.baseStats.fortune    = 0;
player.baseStats.maxMana    = 10;

player.passiveAbility = player.doomAbilities;
player.activeAbility  = "Rip and Tear";
applyPassiveAbilityEffects();

player.guildUnlocked     = true;
player.guildMissionStage = 7;
player.guildMissionKills = 0;
updateGuildRankUI();
updateStats();
updateManaDisplay();
   
   document.getElementById("gameContainer").style.display = "block";
   document.getElementById("battleTint").style.display = "none";
   currentWorld = "Hell";
      worldNum     = 666;
      worldName    = "Hell";
      document.body.style.background = "#b30003";      // Hell-red
      const wc = document.getElementById("worldCounter");
      if (wc) wc.textContent = "Hell 666 - 0";
	  return;
 }
 document.body.classList.remove("doom-mode");
 magicBtn.innerText = "Spell";
player.guildUnlocked     = false;
player.guildMissionStage = 0;
player.guildMissionKills = 0;
 document.getElementById("abilityMenu").style.display   = "block";
}

// Wire up the difficulty buttons
document.getElementById("normalBtn").addEventListener("click", () => selectDifficulty("normal"));
document.getElementById("hardBtn").addEventListener("click", () => selectDifficulty("hard"));
document.getElementById("extremeBtn").addEventListener("click", () => selectDifficulty("extreme"));
document.getElementById("insaneBtn").addEventListener("click", () => selectDifficulty("insane"));
document.getElementById("calamityBtn").addEventListener("click", () => selectDifficulty("calamity"));
document.getElementById("bossRushBtn").addEventListener("click", () => selectDifficulty("bossRush"));
document.getElementById("doomBtn").addEventListener("click", () => {
 titleMusic.pause();
 titleMusic.currentTime = 0;
  // hide the normal menus
  document.getElementById("difficultyMenu").style.display = "none";
  document.getElementById("abilityMenu").style.display   = "none";
});
document.getElementById("ultimateBtn").addEventListener("click", () => selectDifficulty("ultimate"));
	   
      function initGame() {
		player.x = 0;
		player.y = 0;
        createRoom(0, 0, ROOM_TYPES.EMPTY);
        const startRoom = map["0_0"];
        startRoom.element.innerHTML = '<div class="player"></div>';
        centerCamera();
        generateAdjacentRooms(0, 0);
		updateManaDisplay();
		updateStats();
		applyEquipmentEffects();
      }
	  
  var playButton = document.getElementById("playButton");
  function weightedRandomSelection(abilities) {
  // Calculate the cumulative weight.
  let totalWeight = abilities.reduce((sum, ability) => sum + ability.chance, 0);
  let random = Math.random() * totalWeight;
  for (let ability of abilities) {
    if (random < ability.chance) {
      return ability.name;
    }
    random -= ability.chance;
  }
  return abilities[0].name;  // fallback to the first one
}

function spinAbilities() {
  // Randomly select passive and active abilities using the weighted logic.
  const selectedPassive = weightedRandomSelection(passiveAbilities);
  const selectedActive = weightedRandomSelection(activeAbilities);

  // Update the ability selection menu texts.
  document.getElementById("playerPassiveAbility").innerText = selectedPassive;
  document.getElementById("playerActiveAbility").innerText = selectedActive;

  // Also store these abilities in the global player object.
  player.passiveAbility = selectedPassive;
  player.activeAbility = selectedActive;

  // Enable the "Start Game" button now that abilities are set.
  document.getElementById("confirmAbilitiesButton").disabled = false;
}

// -----------------------------
// Rolling‐slot effect for Innates
// -----------------------------
function startAbilityRoll() {
  const confirmBtn = document.getElementById("confirmAbilitiesButton");
  // 🔒 Make sure the confirm button is off while we spin
  confirmBtn.disabled = true;

  const duration      = 5000;  // total roll time in ms
  const startInterval =   10;   // initial flash speed
  const endInterval   =  300;   // final flash speed
  let elapsed = 0;
  let interval = startInterval;

  // grab names once
  const passiveNames = passiveAbilities.map(a => a.name);
  const activeNames  = activeAbilities .map(a => a.name);
  const passiveEl    = document.getElementById("playerPassiveAbility");
  const activeEl     = document.getElementById("playerActiveAbility");

  // one flash
  function flash() {
    passiveEl.innerText = passiveNames[Math.floor(Math.random() * passiveNames.length)];
    activeEl .innerText = activeNames [Math.floor(Math.random() * activeNames .length)];
  }

  // recursive step with easing
  function step() {
    flash();
    elapsed += interval;

    // linear ease from start→end
    const t = Math.min(elapsed / duration, 1);
    interval = startInterval + (endInterval - startInterval) * t;

    if (elapsed < duration) {
      setTimeout(step, interval);
    } else {
      // 🔓 now that the roll finished, pick & lock in
      spinAbilities();
      // spinAbilities() ends by doing:
      // confirmBtn.disabled = false;
    }
  }

  // kick things off
  step();
}

/*********************
 * Ability Menu Handling
 *********************/
document.getElementById("spinAbilityButton").addEventListener("click", function () {
	startAbilityRoll();
	document.getElementById("spinAbilityButton").style.display = "none";
});	

// When the player confirms abilities and starts the game.
document.getElementById("confirmAbilitiesButton").addEventListener("click", function () {
  document.getElementById("abilityMenu").style.display = "none";
  document.getElementById("hudPlayerPassive").innerText = player.passiveAbility || "None";
  document.getElementById("hudPlayerActive").innerText = player.activeAbility || "None";
  applyPassiveAbilityEffects();
  initGame();
  document.getElementById("gameContainer").style.display = "block";
  document.getElementById("battleTint").style.display = "none";
  if (titleMusic) {
    titleMusic.pause();
  }
  titleMusic.currentTime = 0;
});

/*********************
 * Title Screen Handling
 *********************/
// When the title screen is clicked, instead of immediately starting the game,
// hide the title screen and show the ability selection menu.
document.getElementById("playButton").addEventListener("click", () => {
  showDifficultyMenu;
  equipmentBtn.style.display = "flex";
});

document.getElementById("closeShopBtn").addEventListener("click", () => {
  shopMenu.style.display = "none";
  battleTint.style.display = "none";
  shopSound.pause();
  shopSound.currentTime = 0;
  shopMenu.classList.remove("jump-zoom-shop");
  if (currentBGM) currentBGM.play();
});

function handleTitleScreenClick() {
  // 1) play the music under a user gesture
  titleMusic.play().catch((e) => {
	console.log("Title music playback prevented:", e);
  });
  const src = titleMusic.src;  
  if (src.includes("fire.mp3")) titleBox.classList.add("jump-zoom-fire");
  if (src.includes("tokyo.mp3")) titleBox.classList.add("jump-zoom-tokyo");
  if (src.includes("hero.mp3")) titleBox.classList.add("jump-zoom-hero");
  if (src.includes("special.mp3")) titleBox.classList.add("jump-zoom-special");
  if (src.includes("bang.mp3")) titleBox.classList.add("jump-zoom-bang");
  if (src.includes("level.mp3")) titleBox.classList.add("jump-zoom-level");
  if (src.includes("titan.mp3")) titleBox.classList.add("jump-zoom-titan");
  if (src.includes("rumbling.mp3")) titleBox.classList.add("jump-zoom-rumbling");
  playButton.style.display = "block";
  titleScreen.removeEventListener("click", handleTitleScreenClick);
}

// listen for the very first screen-click
titleScreen.addEventListener("click", handleTitleScreenClick);

document.getElementById("playButton").addEventListener("click", function () {
  document.getElementById("titleScreen").style.display = "none";
  document.getElementById("gameContainer").style.display = "block";
});

function createFadeOverlay() {
  const ov = document.createElement("div");
  ov.id = "doomFadeOverlay";
  ov.style.position = "fixed";
  ov.style.top = "0";
  ov.style.left = "0";
  ov.style.width = "100vw";
  ov.style.height = "100vh";
  ov.style.background = "black";
  ov.style.opacity = "0";
  ov.style.transition = "opacity 1s ease";
  ov.style.zIndex = "3000";
  document.body.appendChild(ov);
  return ov;
}

// at top of file, alongside other globals:
let gateAudio;

// Doom-button handler: immediate fade to black → load title behind the curtain → reveal title + play gate music
document.getElementById("doomBtn").addEventListener("click", () => {
  // stop the OG title music
  titleMusic.pause();
  titleMusic.currentTime = 0;

  // hide difficulty/ability menus
  document.getElementById("difficultyMenu").style.display = "none";
  document.getElementById("abilityMenu").style.display   = "none";

  // 1) Create full-screen black overlay and fade it in
  const overlay = createFadeOverlay();
  setTimeout(() => {
	  overlay.style.opacity = "1";
  }, 10);

  // 2) Once it’s fully opaque (1s), show title screen behind it & start gate audio
  setTimeout(() => {
	document.getElementById("doomTitleScreen").style.display = "flex";
	
	gateAudio = new Audio("atdoomsgate.mp3");
	gateAudio.loop = true;
	gateAudio.volume = 0;
	gateAudio.play();
	const fadeInterval = setInterval(() => {
		gateAudio.volume = Math.min(1, gateAudio.volume + 0.025);
		if (gateAudio.volume >= 1) clearInterval(fadeInterval);
	}, 250);
    setTimeout(() => {
		overlay.style.opacity = "";
		setTimeout(() => {
		overlay.remove();
	  }, 1000);
    }, 1000);
  }, 1000);
});

function playNextDoomTrack() {
  const pool = doomMusicOptions.filter(f => f !== lastDoomMusic);
  const pick = pool[Math.floor(Math.random() * pool.length)];
  lastDoomMusic = pick;

  if (currentBGM) {
    currentBGM.pause();
    currentBGM.removeEventListener("ended", onDoomTrackEnded);
  }
  currentBGM = new Audio(pick);
  currentBGM.loop = false;
  currentBGM.addEventListener("ended", onDoomTrackEnded);
  currentBGM.play();
}

function onDoomTrackEnded() {
  playNextDoomTrack();
}

document.getElementById("beginJourneyBtn").addEventListener("click", () => {
  // 1) Fade the gate audio out over 1s
  if (gateAudio) {
    const fadeInterval = setInterval(() => {
      gateAudio.volume = Math.max(0, gateAudio.volume - 0.05);
      if (gateAudio.volume <= 0) {
        gateAudio.pause();
        clearInterval(fadeInterval);
      }
    }, 50);
  }

  // 2) Create a fresh black overlay and fade in to block the title
  const overlay = createFadeOverlay();
  setTimeout(() => {
		overlay.style.opacity = "1", 20;
		selectDifficulty("doom");
		initGame();
		document.body.classList.add("doom-mode");
		
		if (currentBGM) {
			currentBGM.pause();
			currentBGM.removeEventListener("ended", onDoomTrackEnded);
		}
		playNextDoomTrack();

		magicBtn.innerText = "Shoot";

	setTimeout(() => {
		overlay.style.opacity = "0";
		document.getElementById("doomTitleScreen").style.display = "none";
	}, 2000);
  
	setTimeout(() => {
		overlay.remove();
	}, 3000);
  });
});


// Play the world background music.
function playWorldMusic(worldName) {
	if (gameDifficulty === "doom") {
		return;
	}
  // If the same world's music is already playing, do nothing.
  if (currentBGM && currentWorld === worldName) return;
  if (titleMusic) {
			titleMusic.pause();
		}
  // Pause and save the current background music if one is already playing.
  if (currentBGM) {
    currentBGM.pause();
    if (bgmTracks[currentWorld]) {
      bgmTracks[currentWorld].savedTime = currentBGM.currentTime;
    }
  }

  // Set the current world.
  currentWorld = worldName;
  let trackObj = bgmTracks[worldName];

  // Check if the track exists.
  if (!trackObj) {
    console.error("No track defined for world:", worldName);
    return;
  }

  // Retrieve and configure the audio object.
  currentBGM = trackObj.audio;
  currentBGM.currentTime = trackObj.savedTime || 0;
  currentBGM.loop = true;
  currentBGM.play();
}

// Stop the current world music and save its time.
function stopWorldMusic() {
	if (gameDifficulty === "doom") return;
  if (currentBGM) {
    currentBGM.pause();
    if (bgmTracks[currentWorld]) {
      bgmTracks[currentWorld].savedTime = currentBGM.currentTime;
    }
    currentBGM = null;
  }
}

// Resume the world music after a battle.
function resumeWorldMusicAfterBattle() {
  if (currentWorld) {
    let trackObj = bgmTracks[currentWorld];
    if (!trackObj) {
      console.error("No track defined for current world:", currentWorld);
      return;
    }
	if (gameDifficulty === "doom") {
		hellTrack.audio.currentTime = hellTrack.savedTime || 0;
	}
    currentBGM = trackObj.audio;
    currentBGM.currentTime = trackObj.savedTime || 0;
    currentBGM.loop = true;
    currentBGM.play();
  }
}

      /*******************
       * ROOM FUNCTIONS
       *******************/
      function createRoom(x, y, type, options = {}) {
    const { disguised = false } = options;
    const key = x + "_" + y;

    // don’t overwrite locked rooms
    if (map[key] && map[key].locked) return;

    // build the room div
    const roomDiv = document.createElement("div");
    roomDiv.classList.add("room");
    roomDiv.style.left = x * roomSize + "px";
    roomDiv.style.top  = y * roomSize + "px";
    roomDiv.dataset.x  = x;
    roomDiv.dataset.y  = y;
    roomDiv.dataset.type      = type;
    roomDiv.dataset.disguised = disguised;

    // === Guild room chance ===
    // 1% before first discovery, then 5% thereafter
    const guildChance = guildEncounteredBefore ? 0.05 : 0.01;
	if (gameDifficulty !== "doom") {
		if (Math.random() < guildChance) {
			guildEncounteredBefore = true;
			type = ROOM_TYPES.GUILD;
			roomDiv.dataset.type = type;
		}
	}

	// if it’s a special room, slap the icon on it
	if ((type === ROOM_TYPES.TRAP && !disguised) || [ ROOM_TYPES.BATTLE, ROOM_TYPES.HEALING, ROOM_TYPES.SHOP, ROOM_TYPES.BOSS, ROOM_TYPES.ALTAR, ROOM_TYPES.CASINO, ROOM_TYPES.LOOT, ROOM_TYPES.GUILD ].includes(type)) {
		const img = document.createElement("img");
		img.src    = roomIcons[type];
		img.alt    = type;
		img.style.width = "80%";
		roomDiv.appendChild(img);
	}

    // make it clickable
    roomDiv.addEventListener("click", () => moveToRoom(x, y));
    mapDiv.appendChild(roomDiv);

    // register in the map
    map[key] = {
        x,
        y,
        type,
        element: roomDiv,
        disguisedTrap: disguised,
        secretAmbush
    };
}
	  
	  // === Constants & Configurations ===
	  const TRAP_SPAWN_RATE_BASE = 0.05;
	  const AMBUSH_SPAWN_RATE_BASE = 0.10;
	  const ALTAR_COOLDOWN_FLOORS = 5;
	  const FULL_EQUALIZE_LUCK = 100;

	  // Pull non-battle room weights into a constant
  	  const BASE_NON_BATTLE_WEIGHTS = {
		[ROOM_TYPES.CASINO]: 14,
		[ROOM_TYPES.SHOP]:   25,
		[ROOM_TYPES.LOOT]:   15,
		[ROOM_TYPES.HEALING]:25,
		[ROOM_TYPES.EMPTY]:  35
	  };

      // === Dynamic Chance Calculators ===
function getBadTrapChance() {
  return Math.max(0, TRAP_SPAWN_RATE_BASE - player.luck * 0.001);
}
function getBadAmbushChance() {
  return Math.max(0, AMBUSH_SPAWN_RATE_BASE - player.luck * 0.001);
}

// === Updated Room Generation ===
function generateAdjacentRooms(cx, cy) {
  allowedMoves = [];
  const positions = [
    { x: cx - 1, y: cy - 1 },
    { x: cx,     y: cy - 1 },
    { x: cx + 1, y: cy - 1 }
  ];
  
  // === Boss Rush mode: only Altars, Shops, Loots & Bosses ===
  if (gameDifficulty === "bossRush") {
    const bossInterval = 3;
    if (floorCount % bossInterval === 0 && !bossRoomGenerated) {
      // spawn the boss room straight ahead
      const bossPos = { x: cx, y: cy - 1 };
      createRoom(bossPos.x, bossPos.y, ROOM_TYPES.BOSS);
      allowedMoves.push(`${bossPos.x}_${bossPos.y}`);
      bossRoomGenerated = true;
      return;
    }
    // else generate only altar/shop/loot
    positions.forEach(pos => {
      const r = Math.random();
      let type;
      if (r < 0.6)      type = ROOM_TYPES.ALTAR;  // 60% altar
      else if (r < 0.8) type = ROOM_TYPES.SHOP;   // 20% shop
      else              type = ROOM_TYPES.LOOT;   // 20% loot
      createRoom(pos.x, pos.y, type);
      allowedMoves.push(`${pos.x}_${pos.y}`);
    });
    return; // skip the default generator
  }

  // Boss every N floors (20 normally, 50 in Doom)
  const bossInterval = (gameDifficulty === "doom" ? 50 : gameDifficulty === "bossrush" ? BOSS_RUSH_INTERVAL : 20);
  if (floorCount % bossInterval === 0 && !bossRoomGenerated) {
    const bossPos = { x: cx, y: cy - 1 };
    createRoom(bossPos.x, bossPos.y, ROOM_TYPES.BOSS);
    allowedMoves.push(`${bossPos.x}_${bossPos.y}`);
    bossRoomGenerated = true;
    return;
  }

  // Track how many battles/traps we've added
  let battleCount = 0;
  let localTrapCount = 0;
  const usedNonBattle = {};
  const luckFactor = Math.min(1, player.luck / FULL_EQUALIZE_LUCK);

  // Build the non-battle pool and weights (we still need
  // them for Healing, Altar, Ambush etc — we’ll just
  // force the forbidden ones into NORMAL at the end)
  const baseTypes = Object.keys(BASE_NON_BATTLE_WEIGHTS);
  const avgWeight = baseTypes.reduce((sum, t) =>
    sum + BASE_NON_BATTLE_WEIGHTS[t], 0) / baseTypes.length;
  const adjusted = {};
  baseTypes.forEach(t => {
    adjusted[t] = BASE_NON_BATTLE_WEIGHTS[t] * (1 - luckFactor)
                + avgWeight * luckFactor;
  });
  const totalWeight = baseTypes.reduce((sum, t) => sum + adjusted[t], 0);

  positions.forEach(pos => {
    let type, disguised = false;

    // Warrior—only if NOT Doom
    if (gameDifficulty !== "doom" && Math.random() < 0.15) {
      type = ROOM_TYPES.WARRIOR;
      disguised = true;
    }
    // Trap (max 2)
    else if (localTrapCount < 2 && Math.random() < getBadTrapChance()) {
      type = ROOM_TYPES.TRAP;
      localTrapCount++;
      if (Math.random() < 0.5) disguised = true;
    }
    // Battle (max 2)
    else if (battleCount < 2 && Math.random() < 0.5) {
      type = ROOM_TYPES.BATTLE;
      battleCount++;
    }
    // Healing on even floors
    else if (floorCount % 2 === 0) {
      type = ROOM_TYPES.HEALING;
    }
    // Altar every ALTAR_COOLDOWN_FLOORS floors
    else if ((floorCount - lastAltarFloor) >= ALTAR_COOLDOWN_FLOORS
             && Math.random() < 0.2) {
      type = ROOM_TYPES.ALTAR;
      lastAltarFloor = floorCount;
    }
    // Otherwise pick from non-battle pool (including CASINO & GUILD,
    // we'll override them out next)
    else {
      let rand = Math.random() * totalWeight;
      for (let t of baseTypes) {
        if (rand < adjusted[t]) {
          type = t;
          break;
        }
        rand -= adjusted[t];
      }
    }

    // Ambush chance on otherwise “safe” rooms
    if ([ROOM_TYPES.BATTLE, ROOM_TYPES.HEALING, ROOM_TYPES.EMPTY]
        .includes(type)
        && Math.random() < getBadAmbushChance()) {
      type = ROOM_TYPES.AMBUSH;
    }

    // Ensure one-of-each non-battle type per floor
    if (type !== ROOM_TYPES.BATTLE) {
      if (usedNonBattle[type]) {
        const avail = baseTypes.filter(t => !usedNonBattle[t]);
        if (avail.length) {
          type = avail[Math.floor(Math.random() * avail.length)];
        }
      }
      usedNonBattle[type] = true;
    }

    // ——— Doom override: force-forbid Casino, Guild, Warrior ———
    if (gameDifficulty === "doom"
        && [ROOM_TYPES.CASINO, ROOM_TYPES.GUILD, ROOM_TYPES.WARRIOR]
            .includes(type)) {
      type = ROOM_TYPES.EMPTY;
	  disguised = false;
    }

    // Finally, create it
    createRoom(pos.x, pos.y, type, { disguised });
    allowedMoves.push(`${pos.x}_${pos.y}`);
  });
}

      function shuffle(array) {
        let currentIndex = array.length,
          temporaryValue, randomIndex;
        while (currentIndex !== 0) {
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex -= 1;
          temporaryValue = array[currentIndex];
          array[currentIndex] = array[randomIndex];
          array[randomIndex] = temporaryValue;
        }
        return array;
      }
	  
	  function lockActions() {
		actionsLocked = true;
	  }

	  function unlockActions() {
		actionsLocked = false;
	  }

	  function newTurn() {
		turnNumber++;
		logBattle("----------Turn " + turnNumber + "----------");
		setTimeout(() => {
			unlockActions();
		}, 125);
	  }
	  
	  const baseItemChance = 0.5;
	  const itemChance = Math.min(0.9, baseItemChance + player.luck * 0.001);

      function handleLootRoom() {
  const mythicalChance = Math.min(0.5, 0.000001 + (player.luck * 0.000001));
  const legendaryChance = Math.min(0.5, 0.001 + (player.luck * 0.001));
  const epicChanceOne = Math.min(0.5, 0.01 + (player.luck * 0.005));
  const epicChanceTwo = Math.min(0.5, 0.02 + (player.luck * 0.005));
  const rareChance = Math.min(0.5, 0.05 + (player.luck * 0.005));
  
if (gameDifficulty !== "doom") {
  if (!hasHistoryUnlocked && Math.random() < rareChance) {
    hasHistoryUnlocked = true;
    alert("You found the **World History** book! It now has been added to the Guild library.");
    return;
  }
  
  if (!hasCrimeUnlocked && Math.random() < epicChanceOne) {
    hasCrimeUnlocked = true;
    alert("You found a mysterious file... **Case 001: The Restricted One (UNSOLVED)**, it says. You decide to hand it over to the Guild.");
    return;
  }
  
  if (!hasDragonBallUnlocked && Math.random() < mythicalChance) {
	hasDragonBallUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "DragonBall",
        type:     "misc",
        category: "dragonball",
		description: "Legends say collecting 7 Dragon Balls grants the owner 1 wish.",
      };
      updateStats();
      updateManaDisplay();
      alert("You found a... mysterious orb? (???)");
    } else {
      alert("Inventory full...");
    }
	checkDragonBalls();
	updateInventoryDisplay();
    return;
  }
  
  if (!hasMechArmsUnlocked && Math.random() < mythicalChance) {
	hasMechArmsUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Mech Arms",
        type:     "equipment",
        category: "weapon",
		description: "Ancient technology from the post-modern era built as titans to fight against the gods. These are the limbs of the titans of war.",
      };
      updateStats();
      updateManaDisplay();
	  updateInventoryDisplay();
      alert("You found an enormous pair of heavy, metallic limbs... (???)");
    } else {
      alert("Inventory full...");
    }
    return;
  }
  
  if (!hasMechArmorUnlocked && Math.random() < mythicalChance) {
	hasMechArmorUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Mech Armor",
        type:     "equipment",
        category: "armor",
		description: "Ancient technology from the post-modern era built as titans to fight against the gods. These are the plates that protect the titans of war.",
      };
      updateStats();
      updateManaDisplay();
	  updateInventoryDisplay();
      alert("You found  huge, metallic plating... armor maybe? (???)");
    } else {
      alert("Inventory full...");
    }
    return;
  }
  
  if (!hasReactorUnlocked && Math.random() < mythicalChance) {
	hasReactorUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Nuclear Reactor",
        type:     "equipment",
        category: "accessory",
		description: "Ancient technology from the post-modern era built as titans to fight against the gods. This is the energy source to power up the titans of war.",
      };
      updateStats();
      updateManaDisplay();
	  updateInventoryDisplay();
      alert("You found a generator of a powerful source of energy... (???)");
    } else {
      alert("Inventory full...");
    }
    return;
  }
  
  if (!hasExcaliburUnlocked && Math.random() < legendaryChance) {
	hasExcaliburUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Excalibur",
        type:     "equipment",
        category: "weapon",
		description: "The Legendary Sword from myth! True to its name, it truly is a powerful, magical sword.",
      };
      updateStats();
      updateManaDisplay();
	  updateInventoryDisplay();
      alert("You found the Excalibur! (LEGENDARY)");
    } else {
      alert("Inventory full...");
    }
    return;
  }
  
  if (!hasDragonUnlocked && Math.random() < legendaryChance) {
	hasDragonUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Dragon's Fang",
        type:     "equipment",
        category: "dual-wieldable",
		description: "A dragon's old tooth reforged into a deadly weapon.",
      };
      updateStats();
      updateManaDisplay();
	  updateInventoryDisplay();
      alert("You found the Dragon's Fang! (LEGENDARY)");
    } else {
      alert("Inventory full...");
    }
    return;
  }
  
  if (!hasStaffUnlocked && Math.random() < legendaryChance) {
	hasStaffUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Sorceress' Staff",
        type:     "equipment",
        category: "weapon",
		description: "One of the Grand Sorceress' old staves, still filled to the brim with arcane magic.",
      };
      updateStats();
	  updateManaDisplay();
	  updateInventoryDisplay();
      alert("You found the Sorceress' Staff! (LEGENDARY)");
    } else {
      alert("Inventory full...");
    }
    return;
  }
  
  if (!hasGunUnlocked && Math.random() < epicChanceOne) {
	hasGunUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Gun",
        type:     "equipment",
        category: "weapon",
		description: "A .44 magnum.",
      };
      alert("You found a firearm! (Epic)");
    } else {
      alert("Inventory full...");
    }
    updateStats();
	updateInventoryDisplay();
    return;
  }
  
  if (!hasAmmoUnlocked && Math.random() < epicChanceTwo) {
	hasAmmoUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Ammo Box",
        type:     "equipment",
        category: "accessory",
		description: "Allows you to reload the Gun.",
      };
      alert("You found a mysterious box with strange metallic objects inside...! (Epic)");
    } else {
      alert("Inventory full...");
    }
    updateStats();
	updateInventoryDisplay();
    return;
  }
  
  if (!hasNikeUnlocked && Math.random() < legendaryChance) {
	hasNikeUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Nike Black Air Force",
        type:     "equipment",
        category: "accessory",
		description: "They say that this unlocks a warrior's true strength.",
      };
      alert("You found a pair of Nike Black Air Force shoes! (LEGENDARY)");
    } else {
      alert("Inventory full...");
    }
    updateStats();
	updateInventoryDisplay();
    return;
  }
  
  if (!hasGrandUnlocked && Math.random() < legendaryChance) {
	hasGrandUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Grand Knight's Armor",
        type:     "equipment",
        category: "armor",
		description: "The Grand Knight's actual armor. Indestructible, impenetrable, built to defend even from the attacks of GOD.",
      };
      alert("You found the Grand Knight's Armor! (LEGENDARY)");
    } else {
      alert("Inventory full...");
    }
    updateStats();
	updateManaDisplay();
	updateInventoryDisplay();
    return;
  }
  
  if (!hasPreviousUnlocked && Math.random() < legendaryChance) {
	hasPreviousUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Previous Hero's Cape",
        type:     "equipment",
        category: "accessory",
		description: "An old ragged cape... with aura.",
      };
      alert("You found a mysterious cape...! (LEGENDARY)");
    } else {
      alert("Inventory full...");
    }
    updateStats();
	updateManaDisplay();
	updateInventoryDisplay();
    return;
  }
} else {
	if (!hasDragonBallUnlocked && Math.random() < mythicalChance) {
	hasDragonBallUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "DragonBall",
        type:     "misc",
        category: "dragonball",
		description: "Legends say collecting 7 Dragon Balls grants the owner 1 wish.",
      };
      updateStats();
      updateManaDisplay();
      alert("You found a... mysterious orb? (???)");
    } else {
      alert("Inventory full...");
    }
	checkDragonBalls();
	updateInventoryDisplay();
    return;
  }
  
  if (!hasCrucibleUnlocked && Math.random() < legendaryChance) {
	hasCrucibleUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Crucible",
        type:     "equipment",
        category: "weapon",
		description: "A godlike weapon forged in the depths of hell, powered with Argent energy, enough of it to power an entire planet for nearly a year.",
      };
      updateStats();
      updateManaDisplay();
	  updateInventoryDisplay();
      alert("You found the Crucible! (LEGENDARY)");
    } else {
      alert("Inventory full...");
    }
    return;
  }
  
  if (!hasTitanUnlocked && Math.random() < legendaryChance) {
	hasTitanUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Titan's Fang",
        type:     "equipment",
        category: "dual-wieldable",
		description: "A Hell Titan's old tooth, reforged into a powerful weapon.",
      };
      updateStats();
      updateManaDisplay();
	  updateInventoryDisplay();
      alert("You found the Titan's Fang! (LEGENDARY)");
    } else {
      alert("Inventory full...");
    }
    return;
  }
  
  if (!hasBFG10000Unlocked && Math.random() < legendaryChance) {
	hasBFG10000Unlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "BFG10000",
        type:     "equipment",
        category: "weapon",
		description: "An amplifier for the BFG9000, but now reinvented as its own weapon.",
      };
      updateStats();
	  updateManaDisplay();
	  updateInventoryDisplay();
      alert("You found a really big fucking gun! (LEGENDARY)");
    } else {
      alert("Inventory full...");
    }
    return;
  }
  
  if (!hasBFG9000Unlocked && Math.random() < epicChanceOne) {
	hasBFG9000Unlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "BFG9000",
        type:     "equipment",
        category: "weapon",
		description: "The Big Fucking Gun. Requires at least one form of Argent Energy to activate.",
      };
      alert("You found a big fucking gun! (Epic)");
    } else {
      alert("Inventory full...");
    }
    updateStats();
	updateInventoryDisplay();
    return;
  }
  
  if (!hasJumpBootsUnlocked && Math.random() < legendaryChance) {
	hasJumpBootsUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Delta V-Jump Boots",
        type:     "equipment",
        category: "accessory",
		description: "Powerful boots left for the slayer to allow easy movement, agility, and even flight.",
      };
      alert("You found a pair of Delta V-Jump Boots! (LEGENDARY)");
    } else {
      alert("Inventory full...");
    }
    updateStats();
	updateInventoryDisplay();
    return;
  }
  
  if (!hasPraetorUnlocked && Math.random() < legendaryChance) {
	hasPraetorUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Praetor Suit",
        type:     "equipment",
        category: "armor",
		description: "An ancient suit of armor, yet is the most technologically-advanced one in all of existence. Built to adapt to any condition, it is indestructible, even to its creator.",
      };
      alert("You found the Praetor Suit! (LEGENDARY)");
    } else {
      alert("Inventory full...");
    }
    updateStats();
	updateManaDisplay();
	updateInventoryDisplay();
    return;
  }
  
  if (!hasMantleUnlocked && Math.random() < legendaryChance) {
	hasMantleUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Dark Ages Mantle",
        type:     "equipment",
        category: "accessory",
		description: "An ancient, furry cape filled with demonic aura that allows the Slayer to handle weapons more efficiently.",
      };
      alert("You found an epic looking cape...! (LEGENDARY)");
    } else {
      alert("Inventory full...");
    }
    updateStats();
	updateManaDisplay();
	updateInventoryDisplay();
    return;
  }
  
  if (!hasInfinityUnlocked && Math.random() < epicChanceOne) {
	hasInfinityUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Infinity Rune",
        type:     "equipment",
        category: "accessory",
		description: "Allows the Slayer to have unlimited ammo when active.",
      };
      alert("You found a powerful stone-looking object...! (Epic)");
    } else {
      alert("Inventory full...");
    }
    updateStats();
	updateInventoryDisplay();
    return;
  }

  if (!hasArgentUnlocked && Math.random() < epicChanceTwo) {
	hasArgentUnlocked = true;
    const freeIdx = player.inventory.findIndex(slot => slot === null);
    if (freeIdx !== -1) {
      player.inventory[freeIdx] = {
        name:     "Argent Energy Storage",
        type:     "equipment",
        category: "accessory",
		description: "Allows use of the BFG9000.",
      };
      alert("You found a mysterious case with powerful energy surging inside...! (Epic)");
    } else {
      alert("Inventory full...");
    }
    updateStats();
	updateInventoryDisplay();
    return;
  }
}

  // Otherwise 50/50 item vs. money
  if (Math.random() < itemChance) {
    let droppedItem = getLootItem();
    if (droppedItem) {
      const freeIndex = player.inventory.findIndex(slot => slot === null);
      if (freeIndex !== -1) {
        player.inventory[freeIndex] = { ...droppedItem };
        if (droppedItem.type === "equipment") {
          if (droppedItem.name === "Gun" || droppedItem.name === "Ammo Box") {
            alert(`You found a ${droppedItem.name}! (Epic!)`);
			updateStats();
			updateInventoryDisplay();
          } else {
            alert(`You found a ${droppedItem.name}! (Rare)`);
			updateStats();
			updateInventoryDisplay();
          }
        } else {
          alert(`You found a ${droppedItem.name}! (Common)`);
		  updateStats();
		  updateInventoryDisplay();
        }
      } else {
        alert("Inventory full!");
      }
    } else {
      let moneyGained = Math.floor(Math.random() * 51) + 50;
      player.money += moneyGained * Math.round(1 + player.fortune * 0.08);
      alert(`You found some treasure! Earned $${moneyGained * Math.round(1 + player.fortune * 0.08)}!`);
    }
  } else {
    let moneyGained = Math.floor(Math.random() * 51) + 50;
    player.money = Math.round(player.money + moneyGained * Math.round(1 + player.fortune * 0.08));
    alert(`You found some treasure! Earned $${moneyGained * Math.round(1 + player.fortune * 0.08)}!`);
  }
  
  updateStats();
  updateInventoryDisplay();
}

      // Returns a valid loot item. If the drop is an equipment and player already has it, re-run the drop.
      function getLootItem(attempts = 0) {
        // Prevent infinite loops – try up to 5 times.
        if (attempts > 5) return null;
        const randomIndex = Math.floor(Math.random() * shopItemsList.length);
        const item = shopItemsList[randomIndex];
        // If the item is equipment (unique) and the player already has it, try again.
        if (item.type === "equipment" && hasItem(item.name)) {
          return getLootItem(attempts + 1);
        }
        return item;
      }
      /*******************
       * MOVEMENT & CAMERA
       *******************/
      function moveToRoom(x, y) {
  const key = x + "_" + y;
  if (!allowedMoves.includes(key) && !player.canRowMovement && y !== player.y - 1 && map[key]) {
    console.log("Invalid move. Please choose one of the newly generated rooms.");
    return;
  }
  
  if (!timerRunning) {
	startTimer();
  }
  // Remove player from old room.
  const oldKey = player.x + "_" + player.y;
  if (map[oldKey]) {
    map[oldKey].element.innerHTML = "";
    if (["battle", "healing", "shop", "boss", "ambush", "loot", "trap", "guild"].includes(map[oldKey].type)) {
      const img = document.createElement("img");
      img.src = roomIcons[map[oldKey].type];
      img.alt = map[oldKey].type;
      img.style.width = "80%";
      map[oldKey].element.appendChild(img);
	  map[oldKey].type = ROOM_TYPES.EMPTY;
    }
  }
  // Update player's position.
  player.x = x;
  player.y = y;
  map[key].element.innerHTML = '<div class="player"></div>';
  centerCamera();
  
  if ((gameDifficulty === "normal" || gameDifficulty === "hard") && ![ ROOM_TYPES.BATTLE, ROOM_TYPES.AMBUSH, ROOM_TYPES.BOSS, ROOM_TYPES.WARRIOR, ROOM_TYPES.SHOP, ROOM_TYPES.CASINO, ROOM_TYPES.ALTAR,  ].includes(map[key].type)) {
	player.exp += 1;
	if (player.exp >= player.expToLevel) {
		levelUp();
    }
  }
  updateStats();
  updateManaDisplay();
  updateInventoryDisplay();

  // Trigger the room event.
  if (map[key].secretAmbush) {
    map[key].secretAmbush = false;
    const img = document.createElement("img");
    img.src = roomIcons[ROOM_TYPES.AMBUSH];
    img.alt = ROOM_TYPES.AMBUSH;
    img.style.width = "80%";
    map[key].element.appendChild(img);
    generateAdjacentRooms(player.x, player.y);
    return;
  }
  
  if (map[key].type === ROOM_TYPES.BATTLE) {
    startBattle();
  } else if (map[key].type === ROOM_TYPES.WARRIOR) {
	  if (gameDifficulty !== "doom") {
		generateAdjacentRooms(player.x, player.y);
		handleWarriorRoom(key);
		return;
	  }
  } else if (map[key].type === ROOM_TYPES.GUILD) {
    if (!player.guildUnlocked) {
      showGuildApplicationPrompt();
    } else {
      showGuildMainMenu();
    }
  } else if (map[key].type === ROOM_TYPES.HEALING) {
    healPlayer();
  } else if (map[key].type === ROOM_TYPES.SHOP) {
    shopCooldown = 6;
    shopSound.currentTime = 0;
	if (gameDifficulty !== "doom") {
		shopSound.play();
		if (currentBGM) currentBGM.pause();
	}
	openShopMenu();
  } else if (map[key].type === ROOM_TYPES.BOSS) {
	stopWorldMusic();
    startBossBattle(() => finalizeRoom(key));
	generateAdjacentRooms(player.x, player.y);
	return;
  } else if (map[key].type === ROOM_TYPES.ALTAR) {
    initiateLevelUp(3);
  } else if (map[key].type === ROOM_TYPES.CASINO) {
    openCasino(() => finalizeRoom(key));
    return;
  } else if (map[key].type === ROOM_TYPES.AMBUSH) {
		generateAdjacentRooms(player.x, player.y);
		startAmbushBattle(() => finalizeRoom(key));
		return;
  } else if (map[key].type === ROOM_TYPES.LOOT) {
    handleLootRoom();
  } else if (map[key].type === ROOM_TYPES.TRAP) {
    handleTrapRoom();
  }
  
  // Finalize the room if none of the above events delay room completion.
  finalizeRoom(key);
}

function finalizeRoom(key) {
  map[key].type = ROOM_TYPES.EMPTY;
  map[key].type = ROOM_TYPES.AMBUSH;
  map[key].type = ROOM_TYPES.WARRIOR;
  map[key].element.innerHTML = "";

  player.x = parseInt(key.split("_")[0], 10);
  player.y = parseInt(key.split("_")[1], 10);
  map[key].element.innerHTML = '<div class="player"></div>';
  centerCamera();
  if (allowedMoves.includes(key)) {
    roomMoves++;
    roomsThisFloor++;
    if (roomsThisFloor >= 3) {
      floorCount++;
      roomsThisFloor = 0;
      bossRoomGenerated = false;
    }
  }
  generateAdjacentRooms(player.x, player.y);
  updateBackgroundColor();
}

      function centerCamera() {
        const centerX = window.innerWidth / 2;
        const centerY = window.innerHeight / 2;
        const offsetX = centerX - player.x * roomSize - roomSize / 2;
        const offsetY = centerY - player.y * roomSize - roomSize / 2;
        mapDiv.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
      }
      /*******************
       * ROOM EFFECTS
       *******************/
      function healPlayer() {
        const effMaxHp = Math.floor(getEffectiveMaxHp());
		if (gameDifficulty === "normal" || gameDifficulty === "hard" || gameDifficulty === "ultimate") {
			player.hp = player.hp + Math.floor(effMaxHp * 0.5);
			if (player.hp > effMaxHp) {
				player.hp = effMaxHp;
			}
		} else if (gameDifficulty === "extreme" || gameDifficulty === "insane" || gameDifficulty === "calamity" || gameDifficulty === "doom") {
			player.hp = player.hp + Math.floor(effMaxHp * 0.25);
			if (player.hp > effMaxHp) {
				player.hp = effMaxHp;
			}
		} else {
			player.hp = effMaxHp;
		}
		player.mana = player.maxMana
        updateStats();
		updateManaDisplay();
      }
	  
	  /*******************
       * GUILD SHIT
       *******************/
	  
function showGuildApplicationPrompt() {
  if (player.money < 500) {
	alert("You do not have the requirement to apply, please return when you do.");
    return;
  }
  
  let input = prompt("Welcome to the Guild! Please pay $500 if you wish to apply!");
  // If the player cancels or inputs nothing, assume they’re choosing to leave.
  if (input === null) {
    alert("We hope you reconsider applying!");
    return;
  }
  let amount = Number(input);
  if (isNaN(amount) || amount < 500) {
     alert("Please input the right amount of money.");
	 return;
  }
  
  if (amount >= 500) {
	player.money -= 500;
	alert("Thank you for applying. Welcome to the Guild!");
	player.guildUnlocked = true;
	showGuildMainMenu();
  }
}

function getGuildRank() {
  let ranks = ["Newbie", "Rookie", "Amateur", "Journeyman", "Pro", "Veteran", "Master", "Grandmaster"];
  return ranks[player.guildMissionStage] || "Grandmaster";
}

function updateGuildRankUI() {
  // update every occurrence of the guild‑rank text (HUD + guild modal)
  const els = document.querySelectorAll('#guildRankText');
  els.forEach(el => {
    if (!player.guildUnlocked) {
      el.innerText = "Guild Rank: None";
    } else {
      el.innerText = "Guild Rank: " + getGuildRank();
    }
  });
}

function getGuildBonuses() {
  const guildBonus = [
    { damage: 0.00, hp: 0.00 },
    { damage: 0.05, hp: 0.05 },
    { damage: 0.07, hp: 0.10 },
    { damage: 0.10, hp: 0.15 },
    { damage: 0.12, hp: 0.20 },
    { damage: 0.15, hp: 0.25 },
    { damage: 0.20, hp: 0.35 },
    { damage: 0.25, hp: 0.50 }
  ];
  // Ensure that player.guildMissionStage falls within the array bounds.
  let index = player.guildMissionStage;
  if (index < 0) index = 0;
  if (index >= guildBonus.length) index = guildBonus.length - 1;
  return guildBonus[index];
}

function showGuildMainMenu() {
  // Make sure the guild menu (defined in your HTML) is visible, and update its rank text
  const guildMenu = document.getElementById("guildMenu");
  updateGuildRankUI();

  const hireMercenaryBtn = document.getElementById("hireMercenaryButton");
  const closeBtn = document.getElementById("closeGuildMenu");

  // Remove any existing event listeners by reassigning the onclick properties
  document.getElementById("missionButton").onclick = handleMission;
  hireMercenaryBtn.onclick = handleHireMercenary;
  closeBtn.onclick = function() {
    guildMenu.style.display = "none";
	document.getElementById("battleTint").style.display = "none";
  };

  // Display the guild menu.
  guildMenu.style.display = "block";
  document.getElementById("battleTint").style.display = "block";
}

function getCurrentMissionRequirement() {
  let requirements = [5, 10, 20, 30, 50, 100, 200];
  return requirements[player.guildMissionStage - 1] || 200;
}

function setMissionUI() {
  // Assume you use the #missionDisplay element (already present in your HTML)
  let missionDisplay = document.getElementById("missionDisplay");
  let req = getCurrentMissionRequirement();
  missionDisplay.innerHTML = `<p>Mission: Hunt ${req} enemies</p><p id="missionCounter">0/${req}</p>`;
  missionDisplay.style.display = "block";
}

function handleMission() {
  // If a mission is in progress but incomplete, do not allow a new one to start.
  if (player.guildMissionStage > 0 && player.guildMissionKills < getCurrentMissionRequirement()) {
    alert("Complete your current task!");
    return;
  }
  
  // If a mission was just completed...
  if (player.guildMissionStage > 0 && player.guildMissionKills >= getCurrentMissionRequirement()) {
    if (player.guildMissionStage === 7) {
      alert("You have completed all missions!");
      return;
    }
    let req = getCurrentMissionRequirement();
    let expReward = req * 2 * (Math.round(1 + player.potential * 0.08));
    let moneyReward = req * 5 * Math.round(1 + player.fortune * 0.08);
    alert(`Mission Completed! You gained ${expReward} EXP and $${moneyReward}.`);
    player.exp = Math.round(player.exp + expReward);
    player.money = Math.round(player.money + moneyReward);
    player.guildMissionStage++;
    player.guildMissionKills = 0;
	setMissionUI();
    updateGuildRankUI();
    document.getElementById("guildRankText").innerText = "Guild Rank: " + getGuildRank();
    return;
  }
  
  // If no mission has been started yet:
  if (player.guildMissionStage === 0 && player.guildMissionKills === 0) {
    player.guildMissionStage = 1;  // start first mission
    setMissionUI();
  }
}

function updateGuildMissionProgress() {
  if (!player.guildUnlocked || player.guildMissionStage === 0) return;
  player.guildMissionKills++;
  let req = getCurrentMissionRequirement();
  let counterEl = document.getElementById("missionCounter");
  if (player.guildMissionKills >= req) {
    counterEl.innerText = "Mission Completed!";
    updateGuildRankUI();
  } else {
    counterEl.innerText = `${player.guildMissionKills}/${req}`;
  }
}

function handleHireMercenary() {
  // Prompt the player for hiring a mercenary.
  let choice = confirm("Hire Mercenary for $200? Press OK to pay, Cancel for Nevermind.");
  if (!choice) {
    return;
  }
  if (player.money < 200) {
    alert("You do not have enough money.");
    return;
  }
  player.money -= 200;
  player.mercenaries.push(createMercenary());
  alert("Mercenary hired!");
}

function createMercenary() {
  return {
    // Base damage is half the player's current attack.
    baseDamage: player.attack / 2,
    critChance: 0.10,
    dodgeChance: 0.5,
  };
}

      /*******************
       * BATTLE MECHANICS
       *******************/
      const enemyDodgeChance = 0.05;
	  
      function startBattle() {
		preBattleStats = {
			attack:        player.attack,
			magic:        player.magic,
			defense:      player.defense,
			agility:       player.agility,
			perception:   player.perception,
			critMultiplier: player.critMultiplier,
			critChance:    player.critChance || 0,
		};
		player.weaponSkill.usedThisBattle = false;
		skillUsedThisBattle = true;
        battleLog.innerHTML = "";
        battleLog.style.display = "block";
        battleTint.style.display = "block";
		turnNumber = 1;
		logBattle("----------Turn " + turnNumber + "----------");
		unlockActions();
        let allowedEnemies = getAllowedEnemies();
        currentEnemy = JSON.parse(JSON.stringify(allowedEnemies[Math.floor(Math.random() * allowedEnemies.length)]));
		let floorBoost = 1 + floorCount * 0.1;
	    let floorBonus = Math.max( Math.floor((floorCount / 10) * floorBoost), 1 );

if (gameDifficulty === "normal") {
    currentEnemy.hp = Math.ceil(currentEnemy.hp * floorBonus) + Math.ceil(15 * floorBonus * (player.level / floorCount));
    currentEnemy.damageRange = [
        Math.ceil(currentEnemy.damageRange[0] + 3 * floorBonus * (player.level / floorCount)),
        Math.ceil(currentEnemy.damageRange[1] + 3 * floorBonus * (player.level / floorCount))
    ];
} else if (gameDifficulty === "hard") {
    currentEnemy.hp = Math.ceil(currentEnemy.hp * floorBonus) + Math.ceil(20 * floorBonus * (player.level / floorCount));
    currentEnemy.damageRange = [
        Math.ceil(currentEnemy.damageRange[0] + 3 * floorBonus * (player.level / floorCount)),
        Math.ceil(currentEnemy.damageRange[1] + 3 * floorBonus * (player.level / floorCount))
    ];
} else if (gameDifficulty === "extreme") {
    currentEnemy.hp = Math.ceil(currentEnemy.hp * floorBonus) + Math.round(20 * floorBonus * (player.level / floorCount));
    currentEnemy.damageRange = [
        currentEnemy.damageRange[0] + Math.round(4 * floorBonus * (player.level / floorCount)),
        currentEnemy.damageRange[1] + Math.round(4 * floorBonus * (player.level / floorCount))
    ];
} else if (gameDifficulty === "insane" && gameDifficulty === "doom") {
	currentEnemy.hp = Math.ceil(currentEnemy.hp * floorBonus) + Math.round(25 * floorBonus * (player.level / floorCount));
    currentEnemy.damageRange = [
        currentEnemy.damageRange[0] + Math.round(4 * floorBonus * (player.level / floorCount)),
        currentEnemy.damageRange[1] + Math.round(4 * floorBonus * (player.level / floorCount))
    ];
} else if (gameDifficulty === "ultimate") {
	currentEnemy.hp = Math.ceil(currentEnemy.hp * floorBonus) + Math.round(50 * floorBonus * (player.level / floorCount));
    currentEnemy.damageRange = [
        currentEnemy.damageRange[0] + Math.round(10 * floorBonus * (player.level / floorCount)),
        currentEnemy.damageRange[1] + Math.round(10 * floorBonus * (player.level / floorCount))
    ];
} else {
	currentEnemy.hp = Math.ceil(currentEnemy.hp * floorBonus) + Math.round(30 * floorBonus * (player.level / floorCount));
    currentEnemy.damageRange = [
        currentEnemy.damageRange[0] + Math.round(5 * floorBonus * (player.level / floorCount)),
        currentEnemy.damageRange[1] + Math.round(5 * floorBonus * (player.level / floorCount))
    ];
}
        let rewardMultiplier = Math.pow(1.5, floorBonus);
        currentEnemy.expReward = [currentEnemy.expReward[0] * rewardMultiplier, currentEnemy.expReward[1] * rewardMultiplier];
        currentEnemy.moneyReward = [currentEnemy.moneyReward[0] * rewardMultiplier, currentEnemy.moneyReward[1] * rewardMultiplier];
        currentEnemy.poison = false;
		currentEnemy.frozen = 0;
		currentEnemy.burned = false;
        currentEnemy.weaken = false;
		currentEnemy.paralyzed = false;
		currentEnemy.asleep = 0;
        player.rage = false;
        player.iron = false;
        const minLv = Math.max(player.level - 3, 1);
        const maxLv = player.level + 5;
        const enemyLevel = Math.floor(Math.random() * (maxLv - minLv + 1)) + minLv;
        currentEnemy.level = enemyLevel;
        if (currentEnemy.baseMaxHp === undefined) {
          currentEnemy.baseMaxHp = currentEnemy.hp;
        }
        const levelDiff = enemyLevel - player.level;
        const scale = 1 + 0.05 * levelDiff;
        const newHp = Math.max(1, Math.round(currentEnemy.baseMaxHp * scale));
        currentEnemy.hp = currentEnemy.maxHp = newHp;
        updateEnemyInfo();
        battleMenu.style.display = "block";
      }
	  
	  function handleWarriorRoom(key) {
  // 1. Prompt the player
  let fight = confirm(
    "You encountered another Warrior! What do you do?\n\n" +
    "Press OK to Fight, or Cancel to Pass by."
  );

  // helper to kick off the battle
  function startWarriorBattle() {
	skillUsedThisBattle = true;
	// stop any world music
	stopWorldMusic();
	// play warrior theme
	warriorTrack.play();
    // show battle log + tint
    battleLog.innerHTML     = "";
    battleLog.style.display = "block";
    battleTint.style.display= "block";

    // build the mimic Warrior
    const warrior = {
      name:        "Warrior",
      hp:          player.maxHp,
      maxHp:       player.maxHp,
      damageRange: [ player.attack, player.magic ],
      expReward:   player.level,
      moneyReward: player.level,
      poison:      false,
	  frozen:      0,
	  burned:      false,
      weaken:      false,
	  paralyzed:   false,
	  asleep:      0,
      boss:        true,
    };

    // when they’re beaten…
    ambushCompleteCallback = () => {
      let spare = confirm("You have defeated the Warrior, spare them?");
      if (spare) {
        if (Math.random() < 0.33) {
          alert("They join you as a mercenary!");
          player.mercenaries.push(createMercenary());
finalizeRoom(key);
        } else {
          alert("They thank you and leave.");
finalizeRoom(key);
        }
	finalizeRoom(key);
      }
      finalizeRoom(key);
    };

    // launch via ambush flow
    ambushEnemiesQueue = [ warrior ];
    currentEnemy        = ambushEnemiesQueue.shift();
    const minLv = Math.max(player.level - 3, 1);
        const maxLv = player.level + 5;
        const enemyLevel = Math.floor(Math.random() * (maxLv - minLv + 1)) + minLv;
        currentEnemy.level = enemyLevel;
        if (currentEnemy.baseMaxHp === undefined) {
          currentEnemy.baseMaxHp = currentEnemy.hp;
        }
        const levelDiff = enemyLevel - player.level;
        const scale = 1 + 0.05 * levelDiff;
        const newHp = Math.max(1, Math.round(currentEnemy.baseMaxHp * scale));
        currentEnemy.hp = currentEnemy.maxHp = newHp;
        // ───────────────────────────────────────────────────────────────
    updateEnemyInfo();
    battleMenu.style.display = "block";
    unlockActions();
  }

  if (fight) {
    // player chose to fight
    startWarriorBattle();
  } else {
    // passing by: 10% chance they still attack
    if (Math.random() < 0.10) {
      alert("The Warrior attacked you anyway!");
      startWarriorBattle();
    } else {
      // safe passage
      finalizeRoom(key);
    }
  }
}


      function startBossBattle(onComplete) {
  let bossTemplate = getBossForFloor(floorCount);
  let bossData = JSON.parse(JSON.stringify(bossTemplate));
  currentEnemy = JSON.parse(JSON.stringify(bossData));;
  if (currentEnemy === "The Restricted One, Kyojiro Allista") {
	  alert("You have entered a Boss Room... but wait, a Mysterious Man stands in your way.");
  } else if (currentEnemy === "Omni") {
	  alert("You sense a powerful presence, be careful.");
	  alert("''Greetings human, we finally meet. Shall we begin the test?''");
  } else if (currentEnemy === "Six-Eyed Calamity") {
	  alert("Between the Heavens and the Earth, you can sense the Honoured One.");
  } else if (currentEnemy === "The King of Curses") {
	  alert("The Strongest of the Heian era himself, Ryomen Sukuna, sits on a throne in front of you.");
  } else if (currentEnemy === "Island Turtle") {
	  alert("You reach the top of the island as you gaze at the magnificent view of the ocean around you, taking a breath of achievement.");
	  alert("You take the moment to think that despite the chaotic state the world is in right now, beautiful things such as this still exist to make up for it.");
	  alert("Suddenly, the ground below you shakes as you fall and tumble down the hill, right back to shore where you fortunately land back on your boat.");
	  alert("You get back up and look up, as an enraged, gigantic turtle stares down at you.");
  } else if (currentEnemy === "The World Serpent, Jörmungandr") {
	  alert("You stop your boat to gaze at one hell of a sight. An enormous serpent, probably long enough to encircle the planet, resting right beside the river.");
	  alert("You then freeze in place as you realize the serpent's head is right behind you, breathing on you. You turn to see it staring right down at you as it begins to move.");
	  alert("It raises its head and roars, as it initiates a battle.");
  } else if (currentEnemy === "Demon God") {
	  alert("You finally find the Gates of Hell, the exit to this hellhole... literally. However, a huge, powerful entity stands in your way once more.");
	  alert("The monster's presence is almost familiar, similar to that god you faced before, but you stand your ground as you prepare to battle once more.");
  } else if (currentEnemy === "The Black King") {
	  alert("You get the feeling you are about to die... but you go anyway.");
	  alert("You have entered a Boss Room. Be careful.");
  } else if (currentEnemy === "King God General Emperor, Supreme Divine Entity of Ultimacy, Archangel & Creator, Gabriel") {
	  alert("After everything you've been through, it's finally time. All of your effort, your struggles, and your victories, has come to this one moment. Good luck, warrior.");
  } else {
	  alert("You have entered a Boss Room. Be careful.");
  }
  player.weaponSkill.usedThisBattle = false;
  skillUsedThisBattle = true;
  if (gameDifficulty !== "doom") {
	stopWorldMusic();
	if (currentEnemy === "Omni") {
	  stopWorldMusic();
	  omniTrack.play();
	} else if (currentEnemy === "Six-Eyed Calamity") {
	  stopWorldMusic();
	  secTrack.play();
	} else if (currentEnemy === "The King of Curses") {
	  stopWorldMusic();
	  kocTrack.play();
	} else if (currentEnemy === "The Black King") {
	  stopWorldMusic();
	  bkTrack.play();
	} else if (currentEnemy === "The Restricted One, Kyojiro Allista") {
	  stopWorldMusic();
	  troTrack.play();
	} else if (currentEnemy === "Demon God") {
	  stopWorldMusic();
	  dkTrack.play();
	} else if (currentEnemy === "Warden of Judgement, Will, And Balance") {
	  stopWorldMusic();
	  semiTrack.play();
	} else if (currentEnemy === "King God General Emperor, Supreme Divine Entity of Ultimacy, Archangel & Creator, Gabriel") {
	  stopWorldMusic();
	  godTrack.play();
	} else {
	  stopWorldMusic();
	  bossTrack.play();
	}
  }
  ambushCompleteCallback = onComplete || null;
  bossTemplate = getBossForFloor(floorCount);
  
  if (gameDifficulty === "doom") {
    // lock BGM to Hell
    stopWorldMusic();
    if (bossTemplate.name === "The Dark Lord, Davoth") {
      dkTrack.currentTime = 0;
      dkTrack.play();
    } else if (bgmTracks["Hell"]) {
      bgmTracks["Hell"].audio.loop = true;
      bgmTracks["Hell"].audio.play();
    }
    // Clone it so we don’t mangle the template
    bossData = JSON.parse(JSON.stringify(bossTemplate));

    // Apply your usual floor‐scaling (same as normal)
    const floorBoost = 1 + floorCount * 0.1;
    const floorBonus = Math.max(Math.floor((floorCount / 10) * floorBoost), 1);

    bossData.hp += Math.round(25 * floorBonus * (player.level / floorCount));
    bossData.damageRange = [
      bossData.damageRange[0] + Math.round(4 * floorBonus * (player.level / floorCount)),
      bossData.damageRange[1] + Math.round(4 * floorBonus * (player.level / floorCount))
    ];

    const rewardMultiplier = Math.pow(1.5, floorBonus);
    bossData.expReward = [bossData.expReward[0] * rewardMultiplier, bossData.expReward[1] * rewardMultiplier];
    bossData.moneyReward = [bossData.moneyReward[0] * rewardMultiplier, bossData.moneyReward[1] * rewardMultiplier];

    // Finalize currentEnemy
    currentEnemy.boss  = true;
    currentEnemy.poison = false;
    currentEnemy.burned = false;
    currentEnemy.frozen = 0;
    currentEnemy.weaken = false;
	currentEnemy.paralyzed = false;
	currentEnemy.asleep = 0;
    currentEnemy.maxHp  = currentEnemy.hp;

    // Show battle UI
    let bossLevel = player.level + 10;
	currentEnemy.level = bossLevel;
	if (currentEnemy.baseMaxHp === undefined) {
		currentEnemy.baseMaxHp = currentEnemy.hp;
	}
	let levelDiff = bossLevel - player.level;
	let scale = 1 + (0.05 * levelDiff);
	let newHp = Math.max(1, Math.round(currentEnemy.baseMaxHp * scale));
	currentEnemy.hp    = newHp;
	currentEnemy.maxHp = newHp;
    updateEnemyInfo();
    battleLog.innerHTML      = "";
    battleLog.style.display  = "block";
    battleTint.style.display = "block";
    battleMenu.style.display = "block";

    // Kick off first enemy turn
    setTimeout(enemyTurnWrapper, 250);
    return;
  } else {
  let floorBoost = 1 + floorCount * 0.1;
  let floorBonus = Math.max( Math.floor((floorCount / 10) * floorBoost), 1 );
  let bossData = getBossForFloor(floorCount);
  
  if (gameDifficulty === "normal") {
    bossData.hp = bossData.hp + Math.ceil(25 * floorBonus * (player.level / floorCount));
    bossData.damageRange = [
        Math.ceil(bossData.damageRange[0] + 3 * floorBonus * (player.level / floorCount)),
        Math.ceil(bossData.damageRange[1] + 3 * floorBonus * (player.level / floorCount))
    ];
} else if (gameDifficulty === "hard") {
    bossData.hp = bossData.hp + Math.ceil(30 * floorBonus * (player.level / floorCount));
    bossData.damageRange = [
        Math.ceil(bossData.damageRange[0] + 3 * floorBonus * (player.level / floorCount)),
        Math.ceil(bossData.damageRange[1] + 3 * floorBonus * (player.level / floorCount))
    ];
} else if (gameDifficulty === "extreme") {
    bossData.hp = bossData.hp + Math.round(30 * floorBonus * (player.level / floorCount));
    bossData.damageRange = [
        bossData.damageRange[0] + Math.round(4 * floorBonus * (player.level / floorCount)),
        bossData.damageRange[1] + Math.round(4 * floorBonus * (player.level / floorCount))
    ];
} else if (gameDifficulty === "insane") {
	bossData.hp = bossData.hp + Math.round(35 * floorBonus * (player.level / floorCount));
    bossData.damageRange = [
        bossData.damageRange[0] + Math.round(4 * floorBonus * (player.level / floorCount)),
        bossData.damageRange[1] + Math.round(4 * floorBonus * (player.level / floorCount))
    ];
} else if (gameDifficulty === "ultimate") {
	bossData.hp = bossData.hp + Math.round(60 * floorBonus * (player.level / floorCount));
    bossData.damageRange = [
        bossData.damageRange[0] + Math.round(10 * floorBonus * (player.level / floorCount)),
        bossData.damageRange[1] + Math.round(10 * floorBonus * (player.level / floorCount))
    ];
} else {
	bossData.hp = bossData.hp + Math.round(40 * floorBonus * (player.level / floorCount));
    bossData.damageRange = [
        bossData.damageRange[0] + Math.round(5 * floorBonus * (player.level / floorCount)),
        bossData.damageRange[1] + Math.round(5 * floorBonus * (player.level / floorCount))
    ];
}

  let rewardMultiplier = Math.pow(1.5, floorBonus);
	bossData.expReward   = [
		bossData.expReward[0] * rewardMultiplier,
		bossData.expReward[1] * rewardMultiplier
	];
	bossData.moneyReward = [
		bossData.moneyReward[0] * rewardMultiplier,
		bossData.moneyReward[1] * rewardMultiplier
	];
  currentEnemy = JSON.parse(JSON.stringify(bossData));
  currentEnemy.boss = true;
  currentEnemy.poison = false;
  currentEnemy.burned = false;
  currentEnemy.frozen = 0;
  currentEnemy.weaken = false;
  currentEnemy.maxHp = currentEnemy.hp;
  player.rage = false;
  player.iron = false;
  bossLevel = player.level + 10;
	currentEnemy.level = bossLevel;
	if (currentEnemy.baseMaxHp === undefined) {
		currentEnemy.baseMaxHp = currentEnemy.hp;
	}
	levelDiff = bossLevel - player.level;
	scale = 1 + (0.05 * levelDiff);
	newHp = Math.max(1, Math.round(currentEnemy.baseMaxHp * scale));
	currentEnemy.hp    = newHp;
	currentEnemy.maxHp = newHp;
  updateEnemyInfo();
  battleMenu.style.display = "block";
  
  battleLog.innerHTML = "";
  battleLog.style.display = "block";
  battleTint.style.display = "block";

  // Instead of simply unlocking actions, call the enemy turn wrapper after a delay
  setTimeout(enemyTurnWrapper, 250);
  }
	  }
  
      /*******************
       * AMBUSH BATTLE SYSTEM
       *******************/
      function startAmbushBattle(onComplete) {
  // store the finalizeRoom callback
  player.weaponSkill.usedThisBattle = false;
  skillUsedThisBattle = true;
  ambushCompleteCallback = onComplete || null;
  if (gameDifficulty !== "doom") {
    stopWorldMusic();
	ambushTrack.play();
  }
  battleLog.innerHTML = "";
  battleLog.style.display = "block";
  battleTint.style.display = "block";
  alert("You were ambushed!");

  // spawn 2–6 enemies
  const minEnemies = 2, maxEnemies = 6;
  const enemyCount = Math.floor(Math.random() * (maxEnemies - minEnemies + 1)) + minEnemies; 
  ambushEnemiesQueue = [];

  for (let i = 0; i < enemyCount; i++) {
    const allowed = getAllowedEnemies();
    const e = JSON.parse(JSON.stringify(
      allowed[Math.floor(Math.random() * allowed.length)]
    ));
    let floorBoost = 1 + floorCount * 0.1;
	let floorBonus = Math.max( Math.floor((floorCount / 10) * floorBoost), 1 );

if (gameDifficulty === "normal") {
    e.hp = Math.ceil(e.hp * floorBonus) + Math.ceil(20 * floorBonus * (player.level / floorCount));
    e.damageRange = [
        Math.ceil(e.damageRange[0] + 3 * floorBonus * (player.level / floorCount)),
        Math.ceil(e.damageRange[1] + 3 * floorBonus * (player.level / floorCount))
    ];
} else if (gameDifficulty === "hard") {
    e.hp = Math.ceil(e.hp * floorBonus) + Math.ceil(25 * floorBonus * (player.level / floorCount));
    e.damageRange = [
        Math.ceil(e.damageRange[0] + 3 * floorBonus * (player.level / floorCount)),
        Math.ceil(e.damageRange[1] + 3 * floorBonus * (player.level / floorCount))
    ];
} else if (gameDifficulty === "extreme" && gameDifficulty === "doom") {
    e.hp = Math.ceil(e.hp * floorBonus) + Math.round(25 * floorBonus * (player.level / floorCount));
    e.damageRange = [
        e.damageRange[0] + Math.round(4 * floorBonus * (player.level / floorCount)),
        e.damageRange[1] + Math.round(4 * floorBonus * (player.level / floorCount))
    ];
} else if (gameDifficulty === "insane") {
	e.hp = Math.ceil(e.hp * floorBonus) + Math.round(30 * floorBonus * (player.level / floorCount));
    e.damageRange = [
        e.damageRange[0] + Math.round(4 * floorBonus * (player.level / floorCount)),
        e.damageRange[1] + Math.round(4 * floorBonus * (player.level / floorCount))
    ];
} else if (gameDifficulty === "ultimate") {
	e.hp = Math.ceil(e.hp * floorBonus) + Math.round(30 * floorBonus * (player.level / floorCount));
    e.damageRange = [
        e.damageRange[0] + Math.round(10 * floorBonus * (player.level / floorCount)),
        e.damageRange[1] + Math.round(10 * floorBonus * (player.level / floorCount))
    ];
} else {
	e.hp = Math.ceil(e.hp * floorBonus) + Math.round(30 * floorBonus * (player.level / floorCount));
    e.damageRange = [
        e.damageRange[0] + Math.round(5 * floorBonus * (player.level / floorCount)),
        e.damageRange[1] + Math.round(5 * floorBonus * (player.level / floorCount))
    ];
}

	const mult = Math.pow(1.5, floorBonus);
    e.expReward   = [e.expReward[0]   * mult, e.expReward[1]   * mult];
    e.moneyReward = [e.moneyReward[0] * mult, e.moneyReward[1] * mult];
    e.poison = false;
	e.burned = false;
	e.frozen = 0;
    e.weaken = false;
	e.paralyzed = false;
	e.asleep = 0;
    ambushEnemiesQueue.push(e);
  }

  // start with the first enemy
  currentEnemy = ambushEnemiesQueue.shift();
  const minLv = Math.max(player.level - 3, 1);
        const maxLv = player.level + 5;
        const enemyLevel = Math.floor(Math.random() * (maxLv - minLv + 1)) + minLv;
        currentEnemy.level = enemyLevel;
        if (currentEnemy.baseMaxHp === undefined) {
          currentEnemy.baseMaxHp = currentEnemy.hp;
        }
        const levelDiff = enemyLevel - player.level;
        const scale = 1 + 0.05 * levelDiff;
        const newHp = Math.max(1, Math.round(currentEnemy.baseMaxHp * scale));
        currentEnemy.hp = currentEnemy.maxHp = newHp;
        // ───────────────────────────────────────────────────────────────
  updateEnemyInfo();
  battleMenu.style.display = "block";
  unlockActions();
}

function getEnemyByName(enemyName) {
  return enemies.find(e => e.name.toLowerCase() === enemyName.toLowerCase());
}

      function updateEnemyInfo() {
        let name = currentEnemy.name;
        if (currentEnemy.poison) name += " - Poisoned";
		if (currentEnemy.frozen) name += " - Frozen";
		if (currentEnemy.burned) name += " - Burned";
        if (currentEnemy.weaken) name += " - Weakened";
		if (currentEnemy.paralyzed) name += " - Paralyzed";
		if (currentEnemy.asleep) name += " - Asleep";
        enemyInfo.innerHTML = `
			<h3>${name}</h3>
			<p class="enemy-level">Level ${currentEnemy.level}</p>
			<p>HP: ${currentEnemy.hp} / ${currentEnemy.maxHp}</p>`;
      }

      function endBattle() {
		  const defeatedBoss = currentEnemy && currentEnemy.boss && currentEnemy.hp <= 0 ? currentEnemy.name : null;
		  
		  killCount++;
		  
  if (preBattleStats.attack !== undefined) {
    player.attack        = preBattleStats.attack;
	player.defense        = preBattleStats.defense;
    player.agility       = preBattleStats.agility;
    player.critMultiplier = preBattleStats.critMultiplier;
    player.critChance    = preBattleStats.critChance;
    player.rage          = false;
    player.iron          = false;
    preBattleStats = {};
  }
  
  if (preBattleStats.defense !== undefined) {
    player.attack        = preBattleStats.attack;
	player.defense        = preBattleStats.defense;
    player.agility       = preBattleStats.agility;
    player.critMultiplier = preBattleStats.critMultiplier;
    player.critChance    = preBattleStats.critChance;
    player.rage          = false;
    player.iron          = false;
    preBattleStats = {};
  }
  
  if (defeatedBoss === "Demon King") {
	alert("As you kill the Demon King, you take a deep sigh of relief as you realize you've finally beaten the final Legend, the strongest monster of this world.");
	alert("You stand pridefully on top of the Demon King's corpse as you become the hero and saviour of the world, when suddenly, a bright flash of light blinds you.");
	alert("''Greetings human, congratulations on coming this far. Find me, and I shall finally test you for myself''.");
  }
  if (defeatedBoss === "Omni") {
    alert("As you land the finishing blow, you suddenly feel as if the world shifted... no, reality shifted. A bright flash of light then blinds you once again, as you realize you're back in a familiar place, but... it's different, somhow.");
  }
  if (defeatedBoss === "Abominable Snowman") {
	alert("You find an ancient, abandoned port near the frozen shore. You explore it and find a boat. You meddle around and somehow got it to work as you then hop on and resume your journey, through the sea.");
  }
  if (defeatedBoss === "Leviathan") {
	alert("You slay the beast, as you then resume your journey. Finally, you find land, but something's off...");
  }
  if (defeatedBoss === "Island Turtle") {
	alert("The gigantic turtle roars and bellows as it falls, creating huge tsunamis as you struggle on your boat, eventually knocking you out.");
	alert("You wake up on your boat in a daze. You look around as you realize you're now sailing on a river, inside a huge cave... sparkling with stars and galaxies around you?");
  }
  if (defeatedBoss === " The World Serpent, Jörmungandr") {
	alert("You finally slay the enormous serpent, as your head suddenly begins to ache, causing you to fall unconscious once more.");
	alert("You wake up and realize you've crashed your boat on some land. You get up and see a familiar gate of fire. You step in and face a familiar world once more.");
  }
  if (defeatedBoss === "The Black King") {
	alert("You suddenly get a huge headache once again, but you shake it off... Reality is distorting.");
  }
  if (defeatedBoss === "Demon God") {
	alert("The Gates of Hell collapses in front of you, as a domain of light suddenly appears inside. You step inside, as you get a gut-wrenching feeling that your journey is about to end.");
  }
  if (defeatedBoss === "Warden Of Judgement, Will, And Balance") {
	alert("Your entire body aches as you fall to the ground. But you get back up, as you start to get a positive feeling this time, that your journey is finally coming to an end.");
  }
  if (defeatedBoss === "King God General Emperor, Supreme Divine Entity of Ultimacy, Archangel & Creator, Gabriel") {
    // 1) Fade screen to black
    const overlay = document.createElement('div');
    overlay.id = 'endingOverlay';
    Object.assign(overlay.style, {
      position: 'fixed', top: 0, left: 0,
      width: '100vw', height: '100vh',
      background: 'black', opacity: 0,
      transition: 'opacity 2s', zIndex: 10000
    });
    document.body.appendChild(overlay);
    requestAnimationFrame(() => overlay.style.opacity = '1');

    // 2) After fade-out, show image + text + choices
    overlay.addEventListener('transitionend', function onFade() {
      overlay.removeEventListener('transitionend', onFade);
      // Set background to ending image
      Object.assign(overlay.style, {
        background: black,
        opacity: 1, transition: ''
      });
      // Create text container
      const text = document.createElement('div');
      Object.assign(text.style, {
        position: 'absolute', bottom: '10%', left: '50%',
        transform: 'translateX(-50%)', color: 'white',
        padding: '20px', maxWidth: '80%', textAlign: 'center'
      });
      text.innerHTML = 
        `Congratulations, human. Thanks to thee, humanity hath finally completed their Third Trial. Thou hast all proven yourselves worthy of advancing as a civilization in this infinite universe.<br><br>` +
        `And as for thou, strange human, thou  hast proven yourself far beyond what we expected. It very looks like humanity hath found their hope, and it is thou. We are impressed by thy accomplishments, and we hast decided to invite thou to join us in The Beyonds.<br><br>` +
        `Will thou accept?`;
      overlay.appendChild(text);

      // Create Accept/Reject buttons
      const btnContainer = document.createElement('div');
      Object.assign(btnContainer.style, { marginTop: '20px' });
      const btnYes = document.createElement('button');
      btnYes.textContent = 'Accept';
      const btnNo = document.createElement('button');
      btnNo.textContent = 'Reject';
      [btnYes, btnNo].forEach(btn => {
        Object.assign(btn.style, { margin: '0 10px', padding: '10px 20px', fontSize: '18px' });
        btnContainer.appendChild(btn);
      });
      overlay.appendChild(btnContainer);

      // Accept: remove overlay and continue game
      btnYes.onclick = () => {
        overlay.remove();
        currentEnemy = null;
        resumeWorldMusicAfterBattle();
		gameDifficulty = "ultimate";
      };
      // Reject: reload game
      btnNo.onclick = () => location.reload();
    });

    // Skip the normal clean-up
    return;
  }
  
  battleMenu.style.display = "none";
  battleLog.style.display = "none";
  battleTint.style.display = "none";
  inventoryMenu.style.display = "none";
  
   // reward the player if the enemy died
   if (currentEnemy && currentEnemy.hp <= 0) {
    let gloryKill = false;
    if (gameDifficulty === "doom" && Math.random() < 0.2) {
      gloryKill = true;
      alert(`${currentEnemy.name} defeated! (GLORY KILL)`);
    } else {
      alert(`${currentEnemy.name} defeated!`);
    }

    // ——— compute and apply rewards ———
	 let bossTemplate = getBossForFloor(floorCount);
	 let bossData = JSON.parse(JSON.stringify(bossTemplate));
     let gainedExp, gainedMoney;
     if (currentEnemy.boss) {
       let [minE, maxE] = bossData.expReward;
       gainedExp   = Math.floor(Math.random() * (maxE - minE + 1)) + minE;
       let [minM, maxM] = bossData.moneyReward;
       gainedMoney = Math.floor(Math.random() * (maxM - minM + 1)) + minM;
     } else {
       let [minE, maxE] = currentEnemy.expReward;
       gainedExp   = Math.floor(Math.random() * (maxE - minE + 1)) + minE;
       let [minM, maxM] = currentEnemy.moneyReward;
       gainedMoney = Math.floor(Math.random() * (maxM - minM + 1)) + minM;
     }
    // double rewards on glory kill
    if (gloryKill) {
      gainedExp   *= 2;
      gainedMoney *= 2;
    }
     addExp(gainedExp);
     player.money = Math.round(player.money + gainedMoney * Math.round(1 + player.fortune * 0.08));
 
     // armor regeneration
    let armorHealAmt = Math.round(Math.random() * (20 - 10 + 1)) + 10;
    // double armor heal on glory kill
    if (gloryKill) armorHealAmt *= 2;
	if (gameDifficulty === "doom") {
       if (player.baseStats.maxArmor >= 50) {
        let armorHealAmt = Math.round(Math.random() * (20 - 10 + 1)) + 10;
        let heal = armorHealAmt;
         player.armor = Math.min(player.armor + heal, player.maxArmor);
       } else if (player.baseStats.maxArmor >= 100) {
        let armorHealAmt = Math.round(Math.random() * (30 - 10 + 1)) + 10;
        let heal = Math.round((armorHealAmt/20)*30);
        if (gloryKill) heal *= 2;
         player.armor = Math.min(player.armor + heal, player.maxArmor);
       } else if (player.baseStats.maxArmor >= 200) {
        let armorHealAmt = Math.round(Math.random() * (50 - 30 + 1)) + 30;
        let heal = Math.round((armorHealAmt/20)*50);
        if (gloryKill) heal *= 2;
         player.armor = Math.min(player.armor + heal, player.maxArmor);
       } else if (player.baseStats.maxArmor >= 300) {
        let armorHealAmt = Math.round(Math.random() * (75 - 35 + 1)) + 35;
        let heal = Math.round((armorHealAmt/20)*75);
        if (gloryKill) heal *= 2;
         player.armor = Math.min(player.armor + heal, player.maxArmor);
       } else if (player.baseStats.maxArmor >= 500) {
        let armorHealAmt = Math.round(Math.random() * (125 - 50 + 1)) + 50;
        let heal = Math.round((armorHealAmt/20)*125);
        if (gloryKill) heal *= 2;
         player.armor = Math.min(player.armor + heal, player.maxArmor);
       } else {
        let armorHealAmt = Math.round(Math.random() * (10 - 2 + 1)) + 5;
        let heal = Math.round((armorHealAmt/20)*10);
        if (gloryKill) heal *= 2;
         player.armor = Math.min(player.armor + heal, player.maxArmor);
       }
     } else {
		if (player.baseStats.maxArmor >= 100) {
        let armorHealAmt = Math.round(Math.random() * (20 - 10 + 1)) + 10;
        let heal = armorHealAmt;
         player.armor = Math.min(player.armor + heal, player.maxArmor);
       } else if (player.baseStats.maxArmor >= 200) {
        let armorHealAmt = Math.round(Math.random() * (30 - 10 + 1)) + 10;
        let heal = Math.round((armorHealAmt/20)*30);
        if (gloryKill) heal *= 2;
         player.armor = Math.min(player.armor + heal, player.maxArmor);
       } else if (player.baseStats.maxArmor >= 300) {
        let armorHealAmt = Math.round(Math.random() * (50 - 30 + 1)) + 30;
        let heal = Math.round((armorHealAmt/20)*50);
        if (gloryKill) heal *= 2;
         player.armor = Math.min(player.armor + heal, player.maxArmor);
       } else if (player.baseStats.maxArmor >= 500) {
        let armorHealAmt = Math.round(Math.random() * (75 - 35 + 1)) + 35;
        let heal = Math.round((armorHealAmt/20)*75);
        if (gloryKill) heal *= 2;
         player.armor = Math.min(player.armor + heal, player.maxArmor);
       } else if (player.baseStats.maxArmor >= 700) {
        let armorHealAmt = Math.round(Math.random() * (125 - 50 + 1)) + 50;
        let heal = Math.round((armorHealAmt/20)*125);
        if (gloryKill) heal *= 2;
         player.armor = Math.min(player.armor + heal, player.maxArmor);
       } else {
        let armorHealAmt = Math.round(Math.random() * (10 - 2 + 1)) + 5;
        let heal = Math.round((armorHealAmt/20)*10);
        if (gloryKill) heal *= 2;
         player.armor = Math.min(player.armor + heal, player.maxArmor);
       }
	 }
     updateStats();
   }

  // if more ambush enemies remain, queue the next one
  if (ambushEnemiesQueue && ambushEnemiesQueue.length > 0) {
    currentEnemy = ambushEnemiesQueue.shift();
    logBattle("Next enemy appears!");
    const minLv = Math.max(player.level - 3, 1);
    const maxLv = player.level + 5;
    const enemyLevel = Math.floor(Math.random() * (maxLv - minLv + 1)) + minLv;
    currentEnemy.level = enemyLevel;
    if (currentEnemy.baseMaxHp === undefined) {
        currentEnemy.baseMaxHp = currentEnemy.hp;
    }
    const levelDiff = enemyLevel - player.level;
    const scale = 1 + 0.05 * levelDiff;
    const newHp = Math.max(1, Math.round(currentEnemy.baseMaxHp * scale));
    currentEnemy.hp = currentEnemy.maxHp = newHp;
    updateEnemyInfo();
    battleMenu.style.display = "block";
    battleLog.style.display = "block";
    battleTint.style.display = "block";
    unlockActions();
    return;
  }

  // if this was an ambush, fire the finalizeRoom callback
  if (ambushCompleteCallback) {
    const cb = ambushCompleteCallback;
    ambushCompleteCallback = null;
    ambushEnemiesQueue = null;
	ambushTrack.pause();
	ambushTrack.currentTime = 0;
	bossTrack.pause();
	bossTrack.currentTime = 0;
	secTrack.pause();
	secTrack.currentTime = 0;
	omniTrack.pause();
	omniTrack.currentTime = 0;
	bkTrack.pause();
	bkTrack.currentTime = 0;
	dkTrack.pause();
	dkTrack.currentTime = 0;
	kocTrack.pause();
	kocTrack.currentTime = 0;
	semiTrack.pause();
	semiTrack.currentTime = 0;
	godTrack.pause();
	godTrack.currentTime = 0;
	warriorTrack.pause();
	warriorTrack.currentTime = 0;
	resumeWorldMusicAfterBattle();
    cb();
    return;
  }
  
  // otherwise, normal battle cleanup
  currentEnemy = null;
  ambushTrack.pause();
  ambushTrack.currentTime = 0;
  bossTrack.pause();
  bossTrack.currentTime = 0;
  secTrack.pause();
  secTrack.currentTime = 0;
  omniTrack.pause();
  omniTrack.currentTime = 0;
  bkTrack.pause();
  bkTrack.currentTime = 0;
  dkTrack.pause();
  dkTrack.currentTime = 0;
  kocTrack.pause();
  kocTrack.currentTime = 0;
  semiTrack.pause();
  semiTrack.currentTime = 0;
  godTrack.pause();
  godTrack.currentTime = 0;
  warriorTrack.pause();
  warriorTrack.currentTime = 0;
  if (!currentBGM) {
	  resumeWorldMusicAfterBattle();
  }
  updateGuildMissionProgress();
}

	   /*******************
       * PLAYER ATTACK SYSTEM
       *******************/

      function playerAttack(moveType) {
        if (!currentEnemy) return;
        if (!player.neverMiss && Math.random() < enemyDodgeChance) {
          logBattle(`${currentEnemy.name} dodged your attack!`);
		  if (player.passiveAbility === "Relentless") {
    // reset stats to pre-battle values on a miss
    player.attack  = preBattleStats.attack;
    player.magic   = preBattleStats.magic;
    player.defense = preBattleStats.defense;
    logBattle("<em>You lost momentum!</em>");
    updateStats();
  }
		  setTimeout(enemyTurnWrapper, 0);
          enemyTurn();
          return;
        }
		const extra = getGuildBonuses();
		let fsBonus = 0;
		if (player.passiveAbility === "Fighting Spirit") {
			fsBonus = (player.maxHp - player.hp) / player.maxHp;
		}
        let baseDamage;
        if (moveType === "attack") {
          const multiplier = Math.random() * (1.15 - 0.85) + 0.85;
          baseDamage = Math.floor(multiplier * player.attack * (1 + extra.damage + fsBonus));
        } else if (moveType === "magic") {
          const multiplier = Math.random() * (2 - 1) + 1;
          baseDamage = Math.floor(multiplier * player.magic * (1 + extra.damage + fsBonus));
        }
        let damage = Math.round(baseDamage);
        if (damage < 1) damage = 1;
        let resisted = false;
        if (currentEnemy.reductionAll) {
			if (ignoreEnemyResistances === true) {
				resisted = false;
			} else {
				damage = Math.round(damage * (1 - currentEnemy.reductionAll));
				resisted = true;
			}
        }
        if (moveType === "attack" && currentEnemy.reductionAttack) {
			if (ignoreEnemyResistances === true) {
				resisted = false;
			} else {
				damage = Math.round(damage * (1 - currentEnemy.reductionAttack));
				resisted = true;
			}
        }
        if (moveType === "magic" && currentEnemy.reductionMagic) {
			if (ignoreEnemyResistances === true) {
				resisted = false;
			} else {
				damage = Math.round(damage * (1 - currentEnemy.reductionMagic));
				resisted = true;
			}
        }
        let isCritical = false;
		let critMulValue = (player.perception / 100) + 2;
		let critDamageMultiplier = Math.min(critMulValue, 5);
        if (moveType === "attack") {
          if (Math.random() < 0.05 + (player.perception - 1) * 0.001) {
            damage = Math.round(damage * critDamageMultiplier);
            isCritical = true;
			if (player.outgoingDamageMultiplier && player.passiveAbility === "Reckless") {
				damage *= player.outgoingDamageMultiplier;
			}
			if (player.rage = true) {
				if (player.rage) {
					damage = Math.round(damage * 2);
					player.critChance *= 2;
				}
			}
          }
        }
		if (moveType === "magic") {
			if (player.outgoingDamageMultiplier && player.passiveAbility === "Reckless") {
				damage *= player.outgoingDamageMultiplier;
			}
			if (player.rage = true) {
				if (player.rage) {
					damage = Math.round(damage * 2);
				}
			}
		}
        if (isCritical) {
          logBattle(`You attacked and dealt ${damage} critical damage!`);
        } else if (resisted) {
			if (gameDifficulty !== "doom") {
				logBattle(`You ${moveType === "attack" ? "attacked" : "cast magic"} and dealt ${damage} resisted damage.`);
			} else {
				logBattle(`You ${moveType === "attack" ? "attacked" : "fired"} and dealt ${damage} resisted damage.`);
			}
        } else {
          if (gameDifficulty !== "doom") {
				logBattle(`You ${moveType === "attack" ? "attacked" : "cast magic"} and dealt ${damage} damage.`);
			} else {
				logBattle(`You ${moveType === "attack" ? "attacked" : "fired"} and dealt ${damage} damage.`);
			}
        }
        currentEnemy.hp -= damage;
        if (currentEnemy.hp < 0) currentEnemy.hp = 0;
        updateEnemyInfo();
        if (currentEnemy.hp <= 0) {
          processEnemyDefeat();
          return;
        }
		if (player.mercenaries.length > 0) {
    mercenaryAttack();
  }
		if (damage < 1) damage = 1;
		setTimeout(enemyTurnWrapper, 250);
      }
	  
function mercenaryAttack() {
    if (player.mercenaries && player.mercenaries.length > 0) {
        player.mercenaries.forEach((mercenary) => {
            // Apply a random multiplier to the base damage.
            let randomFactor = 0.8 + Math.random() * 0.4;  // multiplier between 0.8 and 1.2
            let damage = Math.floor(mercenary.baseDamage * randomFactor);
            logBattle("Your mercenary attacked " + currentEnemy.name + " for " + damage + " damage.");
            currentEnemy.hp -= damage;
        });
    }
}
	  
	  function dealPlayerDamage(options = {}) {
  // options: { multiplier, forceCrit, ignoreDodge }
  const { multiplier = 1, forceCrit = false, ignoreDodge = false } = options;
  // stash
  const origAttack = player.attack;
  const origCritMul = player.critMultiplier;
  const origNeverMiss = player.neverMiss;
  // apply
  player.attack *= multiplier;
  if (forceCrit) {
	  player.critMultiplier = 999;
	  isCritical = true;
  }
  if (ignoreDodge) player.neverMiss = true;
  // perform
  playerAttack("attack");
  // restore
  player.attack = origAttack;
  player.critMultiplier = origCritMul;
  player.neverMiss = origNeverMiss;
}

function dealPlayerMagicDamage(mult = 1) {
  // stash
  const origMagic = player.magic;
  // apply
  player.magic *= mult;
  // perform
  playerAttack("magic");
  // restore
  player.magic = origMagic;
}

/*******************
       * ENEMY TURN
       *******************/

      function enemyTurn() {
  // If Infinity Innate is active, drain mana instead of taking hits
  if (player.infinityActive) {
    player.mana = Math.max(0, player.mana - 1);
    updateManaDisplay();
    logBattle(`${currentEnemy.name} attacked, but nothing happened.`);
    if (player.mana === 0) {
      player.infinityActive = false;
      logBattle("Your Innate suddenly begins to fade.");
    }
    return;
  }

  // Dodge check
  if (Math.random() < player.dodgeChance + (player.agility - 1) * 0.001) {
    logBattle("Player dodged the enemy attack!");
    updateStats();
    return;
  }

  // Base damage roll
  const [minD, maxD] = currentEnemy.damageRange;
  let enemyDamage = Math.round(Math.random() * (maxD - minD + 1)) + minD;
  enemyDamage -= Math.round(enemyDamage * (player.defense / 200));
  if (enemyDamage < 0) enemyDamage = 1;
  enemyDamage = Math.ceil(enemyDamage / 2);

  // Critical hit?
  let enemyCritical = false;
  if (Math.random() < 0.05) {
    enemyDamage *= 2;
    enemyCritical = true;
  }

  // Iron passive halves incoming
  if (player.iron) {
    enemyDamage = Math.round(enemyDamage / 2);
  }
  // Other modifiers
  if (player.enemyDamageReduction) {
    enemyDamage *= player.enemyDamageReduction;
  }
  if (player.incomingDamageMultiplier) {
    enemyDamage *= player.incomingDamageMultiplier;
  }

  if (currentEnemy.frozen > 0) {
  currentEnemy.frozen--;
  logBattle(`${currentEnemy.name} is frozen and cannot move!`);
  if (currentEnemy.frozen === 0) logBattle(`${currentEnemy.name} defrosted!`);
  updateEnemyInfo();
  return;
  }
  
  if (currentEnemy.asleep > 0) {
  currentEnemy.asleep--;
  logBattle(`${currentEnemy.name} is asleep!`);
  if (currentEnemy.asleep === 0) logBattle(`${currentEnemy.name} woke up!`);
  updateEnemyInfo();
  return;
  }
  
  if (currentEnemy.paralyzed) {
	if (Math.random() < 0.33) {
      logBattle(`${currentEnemy.name} is paralyzed and couldn't move!`);
      updateEnemyInfo();
      return;
    }
  }
  
  const rawEnemyDamage = Math.round(enemyDamage);
  player.lastEnemyDamage = rawEnemyDamage;

  if (player.armor > 0) {
    if (player.lastEnemyDamage <= player.armor) {
      player.armor -= player.lastEnemyDamage;
      player.lastEnemyDamage = 0;
    } else {
      player.lastEnemyDamage -= player.armor;
      player.armor = 0;
	  logBattle("Your ARMOR has depleted!");
    }
  }

  if (player.lastEnemyDamage > 0) {
    player.hp -= player.lastEnemyDamage;
    if (player.hp < 0) player.hp = player.immortal ? 1 : 0;
  }

  if (player.hp < 0) {
	if (player.immortal) {
		player.hp = 1;
	} else {
		player.hp = 0;
	}
  }
  
  if (player.immortal) {
	player.hp = Math.max(player.hp, 1);
  }
  updateStats();

  // Log the attack
  if (enemyCritical) {
    logBattle(`${currentEnemy.name} attacked and dealt ${rawEnemyDamage} critical damage!`);
  } else {
    logBattle(`${currentEnemy.name} attacked and dealt ${rawEnemyDamage} damage.`);
  }
  updateStats();
  
  if (player.burning && Math.random() < 0.67) {
  currentEnemy.burned = true;
  logBattle(`${currentEnemy.name} was burnt!`);
  updateEnemyInfo();
  }
  updateStats();

  // Check for death
  if (player.hp <= 0) {
    showDeathMenu();
    return;
  }

  // --- NEW: Reflective passive bounces 50% back immediately ---
  if (player.reflective) {
    const reflectDmg = Math.ceil(player.lastEnemyDamage * 0.5);
    logBattle(`You reflected ${reflectDmg} damage back!`);
    currentEnemy.hp = Math.max(0, currentEnemy.hp - reflectDmg);
    updateEnemyInfo();
    if (currentEnemy.hp <= 0) {
      processEnemyDefeat();
      return;
    }
  }

  // Boss self-heal chance
  if (currentEnemy.boss && Math.random() < 0.10) {
    const healAmt = Math.ceil(currentEnemy.maxHp * 0.10);
    currentEnemy.hp = Math.min(currentEnemy.hp + healAmt, currentEnemy.maxHp);
    logBattle(`${currentEnemy.name} healed ${healAmt} HP!`);
    updateEnemyInfo();
    return;
  }
}
	  
	  function enemyTurnWrapper() {
  enemyTurn();
  // If the enemy is still alive and not defeated during its turn...
  if (currentEnemy && currentEnemy.hp > 0) {
    // Process poison damage if the enemy is poisoned:
    if (currentEnemy.poison) {
      const poisonDamage = Math.max(Math.round(currentEnemy.hp * 0.02), 1);
      logBattle(`${currentEnemy.name} took ${poisonDamage} poison damage!`);
      currentEnemy.hp -= poisonDamage;
      if (currentEnemy.hp < 0) currentEnemy.hp = 0;
      updateEnemyInfo();
    }
	if (currentEnemy.burned) {
	  const burnDamage = Math.max(Math.round(currentEnemy.hp * 0.02), 1);   // reuse the same function
	  logBattle(`${currentEnemy.name} took ${burnDamage} burn damage!`);
	  currentEnemy.hp -= burnDamage;
	  if (currentEnemy.hp < 0) currentEnemy.hp = 0;
	  updateEnemyInfo();
	}
	if (player.passiveAbility === "Adaptable") {
		player.defense += 1;
	}
	if (player.passiveHealingPerTurn) {
    let healAmt = Math.floor(player.maxHp * player.passiveHealingPerTurn);
    player.hp = Math.min(player.maxHp, player.hp + healAmt);
    logBattle(`Adaptable heals you for ${healAmt} HP!`);
    updateStats();
	}
	if (player.passiveAbility === "Relentless") {
  player.attack  += 1;
  player.magic   += 1;
  player.defense += 1;
  }
  setTimeout(() => {
    unlockActions();
  }, 125);
    // Check if the enemy died after poison damage.
    if (currentEnemy.hp <= 0) {
      alert(`${currentEnemy.name} defeated!`);
      endBattle();
      return;
    }
	// Mercenary dodge check
if (player.mercenaries.length > 0) {
  // did enemy hit? if they fail the dodge roll, mercenary dies immediately
  if (Math.random() > player.mercenaries[0].dodgeChance) {
    const idx = Math.floor(Math.random() * player.mercenaries.length);
    logBattle(`Your mercenary was attacked by ${currentEnemy.name} and has fallen!`);
    player.mercenaries.splice(idx, 1);
  } else {
    logBattle(`${currentEnemy.name} attacked your mercenary, but they dodged!`);
  }
  return; // prevent them from targeting you directly this turn
}
 else {
	}
  }
  setTimeout(newTurn, 250);
}

      function attemptRun() {
        if (ambushEnemiesQueue && ambushEnemiesQueue.length > 0) {
          logBattle("You're surrounded by monsters, you can't escape!");
		  setTimeout(enemyTurnWrapper, 250);
          return;
        }
        if (currentEnemy && currentEnemy.boss) {
          logBattle(`You tried to escape, but the ${currentEnemy.name} blocked your way!`);
		  setTimeout(enemyTurnWrapper, 250);
          return;
        }
        if (Math.random() < 0.5) {
          logBattle("You ran away!");
          alert("Successfully escaped!");
		  setTimeout(enemyTurnWrapper, 250);
		  endBattle();
        } else {
          logBattle("You attempted to run but failed!");
		  setTimeout(enemyTurnWrapper, 250);
        }
      }
	  
	  function processEnemyDefeat() {
    // Check if the active ability is Necromancy.
    if (player.activeAbility === "Necromancy") {
        // Instead of simply alerting defeat, prompt with two choices.
        // We use confirm() to simulate two options: OK = "Yes", Cancel = "Finish Off".
        let choice = confirm(
            "Player defeated " + currentEnemy.name + 
            "! Would you like for it to become your soldier?\n\n" +
            "Press OK for Yes, or Cancel to Finish Off."
        );
        if (choice) {
            // "Yes" selected – determine chance based on whether enemy is a boss.
            let successChance = currentEnemy.boss ? (0.33) : 0.5;
            if (Math.random() < successChance) {
                alert("You have resurrected " + currentEnemy.name + "!");
                if (currentEnemy.boss) {
                    player.mercenaries.push({
                        baseDamage: player.attack * 2,
                        critChance: 0.10,
                        dodgeChance: 0.67,
                    });
                } else {
                    player.mercenaries.push({
                        baseDamage: player.attack / 2,
                        critChance: 0.10,
                        dodgeChance: 0.5,
                    });
                }
            } else {
                alert("You failed to resurrect " + currentEnemy.name + ".");
            }
            endBattle();
        } else {
            endBattle();
        }
    } else {
        endBattle();
    }
}

	  /*******************
       * ABILITIES
       *******************/
	   
	   function applyPassiveAbilityEffects() {
  switch (player.passiveAbility) {
    case "None":
      // No changes
      break;
    case "Berserker":
      // Doubles the player's Attack stat
	  player.baseStats.attack += 5;
	  updateStats();
	  updateManaDisplay();
      break;
	case "Big":
	  player.baseStats.attack  += 5;
	  player.baseStats.maxArmor += 20;
	  player.armor += 20;
	  player.baseStats.maxHp   += 100;
	  player.hp += 100;
	  player.baseStats.agility -= 10;
	  updateStats();
	  break;
    case "Arcane":
	  player.baseStats.magic += 5;
	  player.baseStats.maxMana *= 2;
	  player.mana = player.maxMana;
	  updateStats();
	  updateManaDisplay();
      break;
    case "Hunter":
      // Increase crit chance by 10%
      player.critChance = (player.critChance || 0) + 0.10;
      player.alwaysHit = true;
      ignoreEnemyResistances = true;
	  player.baseStats.agility += 2;
	  player.baseStats.perception += 5;
	  updateStats();
      break;
	case "Quick":
	  player.baseStats.agility += 5;
	  updateStats();
      break;
    case "Tough":
      player.enemyDamageReduction = 0.33;
	  player.armor += 30;
	  player.baseStats.maxArmor += 30;
      player.immuneToCrits = true;
	  updateStats();
      break;
    case "Golden":
      player.moneyGainMultiplier = 2;
      player.enemyDamageReduction = 0.75;
      player.expGainMultiplier = 1.1;
      ignoreEnemyResistances = true;
      break;
	case "Burning":
	  // When enemy hits you, we’ll roll in enemyTurn()
	  player.burning = true;
	  break;
    case "Adaptable":
      player.expGainMultiplier = 2;
      player.passiveHealingPerTurn = 0.02;
      break;
	case "Reflective":
      player.reflective = true;
      break;
    case "Reckless":
      player.outgoingDamageMultiplier = 2;
      // Increase enemy damage taken by 50% (i.e. enemy damage multiplier).
      player.incomingDamageMultiplier = 1.5;
      break;
    case "Aura Farmer":
      player.upgradesRemaining = 2;
      break;
    case "Six Eyes":
      player.overrideManaCost = 1;
      break;
	case "Heavenly Restricted":
      // Override the player's base stats.
	  player.baseStats.maxHp = 500;
      player.hp = 500;
	  player.baseStats.maxArmor = 100;
      player.armor = 100;
      player.baseStats.attack = 100;
      player.baseStats.defense = 60;
      player.baseStats.magic = 0;
      player.baseStats.maxMana = 0;
      player.mana = 0;
      player.baseStats.agility = 60;
      player.baseStats.perception = 60;
      player.baseStats.potential = 0;
      player.baseStats.fortune = 1;
      player.baseStats.luck = 1;
	  ignoreEnemyResistances = true;

      // Disable the active ability.
      player.activeAbility = "None";

      // Prevent the player from leveling up by setting the required EXP to Infinity.
      player.expToLevel = Infinity;

      // Optionally update UI elements if they exist.
      const activeAbilityEl = document.getElementById("hudPlayerActive");
      if (activeAbilityEl) {
        activeAbilityEl.innerText = "None";
      }

      console.log(
        "Heavenly Restricted is in effect: player stats overwritten, active ability disabled, leveling up blocked."
      );
	  updateStats();
	  updateManaDisplay();
      break;

	case "Immortality":
	  player.immortal = true;
	  break;

	case "Invincible":
	  player.defense += 99;
	  player.baseStats.defense += 99;
	  player.armor += 100;
	  player.baseStats.maxArmor += 100;
	  updateStats();
	  break;
	  
	case "Demon Slayer":
	  player.baseStats.attack += 8;
	  updateStats();
	  break;
	
	case "Scourge of Hell":
	  player.armor += 50;
	  player.maxArmor += 50;
	  player.baseStats.maxArmor += 50;
	  updateStats();
	  break;
	
	case "The Doom Slayer":
	  player.baseStats.attack += 4;
	  player.baseStats.magic += 4;
	  player.baseStats.durability += 9;
	  player.mana += 10;
	  player.maxMana += 10;
	  player.baseStats.maxMana += 10;
	  player.armor += 10;
	  player.maxArmor += 10;
	  player.baseStats.maxArmor += 10;
	  player.baseStats.agility += 9;
	  player.baseStats.perception += 4;
	  updateManaDisplay();
	  updateStats();
	  break;
	  
	case "Hellwalker":
	  player.baseStats.agility += 19;
	  player.baseStats.perception += 9;
	  updateStats();
	  break;
	
	case "Unchained Predator":
	  player.mana += 20;
	  player.maxMana += 20;
	  player.baseStats.maxMana += 20;
	  updateManaDisplay();
	  updateStats();
	  break;
	  
	case "Heavensent Executioner":
	  player.baseStats.magic += 8;
	  updateStats();
	  break;
	  
    default:
      break;
  }
  updateStats();
  updateManaDisplay();
}

// Listen for Q:
document.addEventListener("keydown", e => {
  if (e.key.toLowerCase() === "q") {
	let manaCost = player.overrideManaCost || 10;
    if (!skillUsedThisBattle) {
      logBattle("You're too exhausted to do that again...");
    // re-unlock so battle can continue
    setTimeout(() => unlockActions(), 250);
    return;
    } else {
      if (player.mana < manaCost) {
		if (player.activeAbility !== "Sacrifice" && player.activeAbility !== "Rip and Tear" && player.activeAbility !== "None") {
			logBattle("Insufficient Mana!");
		}
      }
      useActiveAbility();
      skillUsedThisBattle = false;
      }
    }
  });

function useActiveAbility() { 
  if (skillUsedThisBattle = false) {
    logBattle("You're too exhausted to do that again...");
    // re-unlock so battle can continue
    setTimeout(() => unlockActions(), 250);
    return;
  }
  manaCost = player.overrideManaCost || 10;
  if (player.activeAbility !== "Sacrifice" && player.activeAbility !== "Rip and Tear" && player.activeAbility !== "None") {
	if (player.mana < manaCost) {
		logBattle("Insufficient Mana!");
		return;
	}
  }

  if (player.activeAbility !== "Sacrifice" && player.activeAbility !== "Rip and Tear" && player.activeAbility !== "None") {
	player.mana -= manaCost;
  } else {
	player.mana = player.mana;
  }
  updateManaDisplay();

  switch (player.activeAbility) {
    case "None":
      logBattle("But nothing happened...");
	  updateManaDisplay();
      break;

    case "Rage":
	  logBattle("<em>Overflow. Break your Limits. Rage!</em>");
      player.rage = true;
	  player.attack = player.attack * 2;
	  player.magic = Math.ceil(player.magic * 1.5);
	  player.perception = player.perception * 2;
	  updateManaDisplay();
	  updateStats();
      break;
	  
	case "Sacrifice":
	  updateManaDisplay();
	  logBattle("<em>Blood for strength. Pain for flame. Light the torch that leads the way. Sacrifice!</em>");
	  player.rage = true;
	  player.attack = player.attack * 3;
	  player.magic = Math.ceil(player.magic * 1.5);
	  player.perception = player.perception * 3;
	  const sacrificeCost = Math.floor(player.maxHp * 0.10);
	  if (player.hp <= sacrificeCost) {
		logBattle("You can't keep going like this...");
		updateManaDisplay();
		return;
	  }
	  player.hp = Math.max(player.hp - sacrificeCost, 1);
	  updateStats();
	  break;
	
	case "Rip and Tear":
	  updateManaDisplay();
	  logBattle("<em>RIP AND TEAR... UNTIL IT'S DONE!</em>");
	  player.attack = Math.round(player.attack * 1.5);
	  player.perception = player.perception * 3;
	  const ripAndTearCost = Math.floor(player.hp * 0.10);
	  if (player.hp <= ripAndTearCost) {
		logBattle("You can't keep going like this...");
		updateManaDisplay();
		return;
	  }
	  player.hp = Math.max(player.hp - ripAndTearCost, 1);
	  updateStats();
	  break;

    case "Maxima":
	  logBattle("<em>Single Point. Focus. Maximum Output. Maxima!</em>");
      // +10× magic attack, enemy +20% dodge
      const origDodge = currentEnemy.dodgeChance || 0;
      currentEnemy.dodgeChance = origDodge + 0.20;
      dealPlayerMagicDamage(10);
      currentEnemy.dodgeChance = origDodge;
      if (player.passiveAbility === "Six Eyes") {
		player.mana -= 0;
	  } else {
		player.mana -= manaCost; 
	  }
      updateManaDisplay();
      break;
	  
	case "Super Strike":
	  logBattle("<em>Through and through. Body and Soul. Super Strike!</em>");
	  dealPlayerDamage({ multiplier: 10 });
      if (player.passiveAbility === "Six Eyes") {
		player.mana -= 0;
	  } else {
		player.mana -= manaCost; 
	  }
      updateManaDisplay();
      break;

    case "Heal":
	  logBattle("<em>Rewind. Heal!</em>");
      const healAmt = Math.floor(player.maxHp * 0.5);
      player.hp = Math.min(player.maxHp, player.hp + healAmt);
      updateStats();
      break;

    case "Hunt":
	  logBattle("<em>No escape. With one strike. Hunt!</em>");
      ignoreEnemyResistances = true;
      const origPer = player.perception;
      player.perception = 9999;
      playerAttack("attack");
      player.perception = origPer;
      ignoreEnemyResistances = false;
      break;

    case "Strike":
	  logBattle("<em>Through and Through. Impact. Strike!</em>");
      // extra physical attack at 2× damage
      dealPlayerDamage(2);
      break;

    case "Blast":
	  logBattle("<em>Single Point. Focus. Blast!</em>");
      // extra magic attack at 2× magic
      dealPlayerMagicDamage(2);
      break;
	  
	case "Reversal":
	  const lostHp = player.maxHp - player.hp;
	  if (lostHp <= 0) {
		logBattle("<em>Vengeance. Obliterate. Reflect. Reversal!... but nothing happened?</em>");
	  } else {
		logBattle("<em>Vengeance. Obliterate. Reflect. Reversal!</em>");
		currentEnemy.hp = Math.max(0, currentEnemy.hp - lostHp);
		updateEnemyInfo();
		if (currentEnemy.hp <= 0) {
			processEnemyDefeat();
			endBattle();
			return;
		}
	  }
	break;

	case "Counter":
	  const dmg = player.lastEnemyDamage * 2;
	  if (player.lastEnemyDamage <= 0) {
		logBattle("<em>Full Counter!... but nothing happened?</em>");
	  } else {
		logBattle("<em>Full Counter!</em>");
		currentEnemy.hp = Math.max(0, currentEnemy.hp - dmg);
		updateEnemyInfo();
		if (currentEnemy.hp <= 0) {
			processEnemyDefeat();
			endBattle();
			return;
		}
	  }
	break;
	
	case "Dash":
	  logBattle("<em>Grace. Stealth. Break Space. Dash!</em>");
      player.agility = player.agility + 10;
	  updateStats();
      break;

	case "Fireball":
	  logBattle("<em>Spark. Grow. Shine Bright. Raze. Fireball!</em>");
	  dealPlayerMagicDamage(1);
	  currentEnemy.burned = true;
	  logBattle(`${currentEnemy.name} was burned!`);
	  updateEnemyInfo();
	  break;
	  
	case "Acid Spit":
	  logBattle("<em>Hawk Tuah!</em>");
	  dealPlayerMagicDamage(1);
	  currentEnemy.poison = true;
	  logBattle(`${currentEnemy.name} was poisoned!`);
	  updateEnemyInfo();
	  break;
	  
	case "Thunderbolt":
	  logBattle("<em>Shock. Strike. Ignite. Thunderbolt!</em>");
	  dealPlayerMagicDamage(1);
	  currentEnemy.paralyzed = true;
	  logBattle(`${currentEnemy.name} was paralyzed and may be unable to move!`);
	  updateEnemyInfo();
	  break;
	  
	case "Freeze":
	  logBattle("<em>Cold. Shiver. Silence. Freeze!</em>");
	  dealPlayerMagicDamage(1);
	  const freezeTurns = Math.floor(Math.random() * 4) + 3; // 3 to 6 turns
	  currentEnemy.frozen = freezeTurns;
	  logBattle(`${currentEnemy.name} is frozen for ${freezeTurns} turns!`);
	  updateEnemyInfo();
	  break;
	  
	case "Mesmerizing Voice":
	  logBattle("<em>Hush little baby don't say a word, I'm gonna buy you a mockingbird~</em>");
	  const sleepTurns = Math.floor(Math.random() * 4) + 3; // 3 to 6 turns
	  currentEnemy.asleep = sleepTurns;
	  logBattle(`${currentEnemy.name} fell asleep for ${sleepTurns} turns!`);
	  updateEnemyInfo();
	  break;
	
	case "Necromancy":
	  alert("That's not how that works, dummy!");
      logBattle("<em>You tried to activate your ability, but it failed!</em>");
	  player.mana += manaCost;
	  skillUsedThisBattle = true;
	  updateStats();
	  updateManaDisplay();
      break;
	  
	case "Resurrection":
	  alert("That's not how that works, dummy!");
      logBattle("<em>You tried to activate your ability, but it failed!</em>");
	  player.mana += manaCost;
	  skillUsedThisBattle = true;
	  updateStats();
	  updateManaDisplay();
      break;
	
    case "Blade of Gold":
	  logBattle("<em>Heaven's Edge. Tear The Sky. Rip Through Negativity. Shine Bright. Blade of Gold!</em>");
      // convert all money into attack for remainder of battle
      player.attack += player.money;
	  player.money -= player.money;
	  updateStats();
	  if (player.passiveAbility === "Six Eyes</em>") {
		player.mana -= 0;
	  } else {
		player.mana -= manaCost; 
	  }
      updateManaDisplay();
      break;
	  
	case "Shining Armor":
	  logBattle("<em>Fortify. Defend The Gods. Divine Nightingale. Shine Bright. Shining Armor!</em>");
      // convert all money into attack for remainder of battle
      player.defense += player.money;
	  player.money -= player.money;
	  updateStats();
	  if (player.passiveAbility === "Six Eyes") {
		player.mana -= 0;
	  } else {
		player.mana -= manaCost; 
	  }
      updateManaDisplay();
      break;
	
	case "Switch":
      useSwitchSkill();
      break;

    case "Infinity":
      useInfinitySkill();
      break;
    default:
      logBattle("No active skill to use.");
  }

  skillUsedThisBattle = false;
  // advance turn
  setTimeout(newTurn, 500);
}

function useInfinitySkill() {
  const effectRoll = Math.random();

  if (effectRoll < 0.2) {
    // Effect 1 - Immune to all damage for this turn
    player.infinityActive = true;
    logBattle("<em>All Else Means Nothing. Incomparable. Existent And Nonexistent. Incomprehensible. Beyond All Else. Infinity!</em>");
  } else if (effectRoll < 0.4) {
    dealPlayerMagicDamage(5);
    logBattle("<em>Phase. Twilight. Eyes of Wisdo. Lapse: Blue!</em>");
  } else if (effectRoll < 0.6) {
    dealPlayerDamage(5);
    logBattle("<em>Phase. Paramita. Pillars of Light. Cursed Technique Reversal: Red!</em>");
  } else if (effectRoll < 0.8) {
    player.hp += Math.min(player.maxHp / 2);
    updateStats();
    logBattle("<em>You're so right... YOU'RE SO RIGHT! Reverse Cursed Technique!</em>");
  } else {
    dealPlayerMagicDamage(10);
	player.mana -= manaCost;
    logBattle("<em>Nine Ropes. Polarized Light. Crow and Declaration. Between Front and Back. Imaginary Technique: Hollow Purple!</em>");
  }
}

function useSwitchSkill() {
  const selfDamage = Math.floor(player.hp * 0.33);
  player.hp = Math.max(player.hp - selfDamage, 1);
  
  const isVessel = player.passiveAbility === "Vessel";
  const boostPct = isVessel ? 1 : 0.5;
  const statsToBoost = [
    { key: "attack" },
    { key: "magic" },
    { key: "defense" },
    { key: "agility" },
    { key: "perception" },
  ];

  statsToBoost.forEach(stat => {
    const base = player[stat.key];
    const increase = Math.max(Math.floor(base * 0.50), 10);
    player[stat.key] += increase;
    logBattle("<em>I'll be gone. Looks like it's your turn... Switch!</em>");
	logBattle("<em>Finally... this will be a MASSACRE!</em>");
  });
  
  if (isVessel) {
    player.critChance = 1.0;
    player.overrideManaCost = 1;
    logBattle("<em>The King of Curses... has returned!</em>");
  }
  updateManaDisplay();
  updateStats();
}

document.addEventListener("keydown", e => {
  if (e.key.toLowerCase() !== "e") return;

  // must be in battle
  if (!currentEnemy) {
    alert("But nothing happened...");
    return;
  }

  const ws = player.weaponSkill;
  
  if (ws.name === "None") {
	if (gameDifficulty !== "doom") {
		logBattle("But nothing happened...");
		return;
	} else {
		if (ws.usedThisBattle) {
			logBattle("You're too exhausted to use that again...");
			return;
		} else {
			logBattle("<em>DEMONS EVERYWHERE... MUST KILL THEM ALL!</em>");
			dealPlayerDamage(1);
			ws.usedThisBattle = true;
		}
	}
  }
  if (ws.usedThisBattle) {
    logBattle("You're too exhausted to use that again...");
    return;
  }
  if (player.mana < 5) {
    logBattle("Insufficient Mana.");
    return;
  }

  // spend flat 5 mana
  player.mana -= 5;
  updateManaDisplay();

  // execute the right effect
  switch (ws.name) {
    case "Assassinate":
      logBattle("<em>You dashed at the target and attacked them!</em>");
      ignoreEnemyResistances = true;
      let origPer = player.perception;
      player.perception = 9999;
      playerAttack("attack");
      player.perception = origPer;
      ignoreEnemyResistances = false;
      break;

    case "Heavy Slash":
	  logBattle("<em>With one big windup, you strike with your sword!</em>");
      dealPlayerDamage(2);
	  break;

	case "Smash":
	  logBattle("<em>You muster up all your strength as you lift up your hammer in the air, before smashing it onto the enemy.</em>");
      dealPlayerDamage(1);
	  break;
	
	case "Bash":
	  logBattle("<em>You put up your shield, before charging straight at the enemy!</em>");
      dealPlayerDamage(2);
	  break;
	
    case "Execution":
      logBattle("<em>Excalibur... Execution!</em>");
      dealPlayerDamage(5);
      break;

    case "Blast Minima":
      logBattle("<em>Single Point. Focus. Blast!</em>");
      dealPlayerMagicDamage(2);
      break;

	case "Pummel":
	  logBattle("<em>Fueled by rage, you charge at your opponent and begin barraging them with attacks</em>")
	  dealPlayerDamage(1);
	  dealPlayerDamage(1);
	  dealPlayerDamage(1);
	  dealPlayerDamage(1);
	  dealPlayerDamage(1);
	  break;

    case "Rewind":
      logBattle("<em>Return. Revert. Undo. Regenerate. Maximum Output. Rewind!</em>");
      player.hp = Math.min(player.maxHp, Math.floor(player.maxHp * 0.5));
      updateStats();
      break;

    case "Outrage":
      logBattle("<em>You feel an intense rage burning inside you!</em>");
      if (player.hp <= player.maxHp * 0.25) {
        logBattle("You can't keep going like this...");
      } else {
        player.hp = Math.floor(player.hp * 0.75);
        player.attack   *= 2;
        player.agility  *= 2;
        player.perception *= 2;
        updateStats();
      }
      break;

	case "Glory Slash":
	  ignoreEnemyResistances = true;
      origPer = player.perception;
      player.perception = 9999;
      playerAttack("attack");
      player.perception = origPer;
      ignoreEnemyResistances = false;
	  break;
	
	case "Launch":
	  dealPlayerDamage(2);
	  currentEnemy.burned = true;
	  break;
	
	case "Sentinel Slam":
	  dealPlayerDamage(2);
	  break;
	
	case "Divine Execution":
	  dealPlayerDamage(5);
	  break;
	
	case "Planet Breaker":
	  ignoreEnemyResistances = true;
	  dealPlayerMagicDamage(5);
	  ignoreEnemyResistances = false;
	  break;
	
	case "Demon Evisceration":
	  ignoreEnemyResistances = true;
	  dealPlayerMagicDamage(2);
	  ignoreEnemyResistances = false;
	  break;

    default:
      logBattle("But nothing happened...");
  }

  ws.usedThisBattle = true;
  // advance turn
  setTimeout(newTurn, 500);
});
	  
      /*******************
       * BACKGROUND COLOR UPDATE
       *******************/
      function updateBackgroundColor() {
  // ——— Doom override ———
  if (gameDifficulty === "doom") {
    // stay in Hell forever, world 666
    document.body.style.background = "#b30003";
    const worldCounterEl = document.getElementById("worldCounter");
    if (worldCounterEl) {
      worldCounterEl.textContent = "Hell 666 - " + Math.floor(roomMoves);
    }
    // ensure BGM is Hell’s
    if (currentWorld !== "Hell") {
      playWorldMusic("Hell");
    }
    return;
  }
  
  if (gameDifficulty === "bossRush") {
	const nextBossFloor = Math.ceil(floorCount / BOSS_RUSH_INTERVAL) * BOSS_RUSH_INTERVAL;
	const nextBoss = getBossForFloor(nextBossFloor);
  let bgColor = "black";
  let worldNum = 0;
  let worldName = "";
  switch (nextBoss.name) {
    case "Goblin King":
      bgColor = "#113b00";
      worldNum = 1;
      worldName = "Deep Forests";
      break;
    case "Zombie Mutant":
      bgColor = "#2a5e31";
      worldNum = 2;
      worldName = "Abandoned Graveyard";
      break;
    case "Giant Lord":
      bgColor = "#5c2c00";
      worldNum = 3;
      worldName = "Deathly Cliffs";
      break;
    case "Skeleton King":
      bgColor = "#8a8a8a";
      worldNum = 4;
      worldName = "Bone Castle";
      break;
    case "Spider Queen":
      bgColor = "#202421";
      worldNum = 5;
      worldName = "Silkwoven Caverns";
      break;
    case "The Witch":
      bgColor = "#1e0033";
      worldNum = 6;
      worldName = "Arcane Swamps";
      break;
    case "Titan Golem":
      bgColor = "#242424";
      worldNum = 7;
      worldName = "Shi Mountains";
      break;
    case "Wyvern":
      bgColor = "#a32c00";
      worldNum = 8;
      worldName = "Archaic Caverns";
      break;
    case "Giant Sandworm":
      bgColor = "#ffe863";
      worldNum = 9;
      worldName = "Scorching Desert";
      break;
    case "Titanoboa Lord":
      bgColor = "#1c0a00";
      worldNum = 10;
      worldName = "Never-Ending Tunnels";
      break;
    case "Abominable Snowman":
      bgColor = "#cedede";
      worldNum = 11;
      worldName = "Freezing Tundra";
      break;
    case "Omegalodon":
      bgColor = "#2954a3";
      worldNum = 12;
      worldName = "The Black Sea";
      break;
    case "Leviathan":
      bgColor = "#0300a1";
      worldNum = 13;
      worldName = "Vast Ocean";
      break;
    case "Angel":
      bgColor = "#ffffff";
      worldNum = 14;
      worldName = "Sky Dimension";
      break;
    case "Mega Meta Mecha Annihilator - Model: Ultima":
      bgColor = "#7bb8c7";
      worldNum = 15;
      worldName = "Future Megalopolis";
      break;
    case "Grand Knight":
      bgColor = "#260d00";
      worldNum = 16;
      worldName = "Ancient Kingdom";
      break;
    case "Six-Eyed Calamity":
      bgColor = "#b700ff";
      worldNum = 17;
      worldName = "Shinjuku";
      break;
    case "Hydra":
      bgColor = "#ba0000";
      worldNum = 18;
      worldName = "Molten Treasure Trove";
      break;
    case "Guardian of Hell, Cerberus":
      bgColor = "#b30003";
      worldNum = 19;
      worldName = "The Underworld";
      break;
    case "Demon King":
      bgColor = "#7d0000";
      worldNum = 20;
      worldName = "Hell";
      break;
    case "Omni":
      bgColor = "#fcd928";
      worldNum = 21;
      worldName = "The Beyond";
      break;
    case "Goblin Emperor":
      bgColor = "#113b00";
      worldNum = 22;
      worldName = "Forest Empire";
      break;
    case "Giant Cyclops, Eater of Men":
      bgColor = "#2a5e31";
      worldNum = 23;
      worldName = "Abandoned Graveyard";
      break;
	case "Orc Lord":
      bgColor = "#063800";
      worldNum = 24;
      worldName = "Dark Forest";
      break;
    case "Medusa, Lady of Stone":
      bgColor = "#5c2c00";
      worldNum = 25;
      worldName = "Deathly Cliffs";
      break;
	case "Ogre King":
      bgColor = "#211000";
      worldNum = 26;
      worldName = "Ogre Cave";
      break;
    case "The Minotaur":
      bgColor = "#8a8a8a";
      worldNum = 27;
      worldName = "Bone Castle";
      break;
    case "Arachni Empress":
      bgColor = "#202421";
      worldNum = 28;
      worldName = "Silkwoven Caverns";
      break;
    case "Grand Sorceress":
      bgColor = "#1e0033";
      worldNum = 29;
      worldName = "Arcane Temple";
      break;
    case "Primordial Automaton":
      bgColor = "#242424";
      worldNum = 30;
      worldName = "The Depths";
      break;
    case "Dragon King":
      bgColor = "#a32c00";
      worldNum = 31;
      worldName = "Dragon King's Lair";
      break;
    case "Devourer of Worlds":
      bgColor = "#ffe863";
      worldNum = 32;
      worldName = "Scorching Desert";
      break;
    case "Frost Queen, Borealis":
      bgColor = "#cedede";
      worldNum = 33;
      worldName = "Freezing Tundra";
      break;
    case "Charybdis":
      bgColor = "#2954a3";
      worldNum = 34;
      worldName = "Valrr Trench";
      break;
	case "Queen Ant":
      bgColor = "#00b82e";
      worldNum = 35;
      worldName = "Jeju Island";
      break;
	case "Ant King, Beru":
      bgColor = "#752300";
      worldNum = 36;
      worldName = "Giant Ant Nest";
      break;
    case "Seraphim":
      bgColor = "#ffffff";
      worldNum = 37;
      worldName = "Sky Dimension";
      break;
    case "Mega Meta Mecha Annihilator - Model: Grande":
      bgColor = "#7bb8c7";
      worldNum = 38;
      worldName = "Future Megalopolis";
      break;
    case "Grand Knight II":
      bgColor = "#260d00";
      worldNum = 39;
      worldName = "Ancient Kingdom";
      break;
    case "King of Curses":
      bgColor = "#b700ff";
      worldNum = 40;
      worldName = "Shibuya";
      break;
    case "The Restricted One, Kyojiro Allista":
      bgColor = "#ba0000";
      worldNum = 41;
      worldName = "Molten Treasure Trove";
      break;
    case "The Brazen Bull, Khalkotauri":
      bgColor = "#32e800";
      worldNum = 42;
      worldName = "Open Fields";
      break;
	case "Kraken":
      bgColor = "#0300a1";
      worldNum = 43;
      worldName = "Violent Seas";
      break;
	case "King Crab":
      bgColor = "#32e800";
      worldNum = 44;
      worldName = "Khaos Island";
      break;
	case "Ghost Leviathan":
      bgColor = "#00543e";
      worldNum = 45;
      worldName = "Phantom Waters";
      break;
	case "Island Turtle":
      bgColor = "#32e800";
      worldNum = 46;
      worldName = "Mysterious Island";
      break;
	case "The World Serpent, Jörmungandr":
      bgColor = "#1c0a00";
      worldNum = 47;
      worldName = "River of Eternity";
      break;
	case "The Behemoth":
      bgColor = "#b30003";
      worldNum = 48;
      worldName = "The Underworld";
      break;
    case "Demon God":
      bgColor = "#7d0000";
      worldNum = 49;
      worldName = "7th Layer of Hell";
      break;
    case "The Black King":
      bgColor = "#000000";
      worldNum = 50;
      worldName = "Shadow Realm";
      break;
	case "Supreme Witch, Calamitas":
      bgColor = "#bd0000";
      worldNum = 51;
      worldName = "Realm of Calamity";
      break;
    case "Warden Of Judgement, Will, And Balance":
      bgColor = "#ffffff";
      worldNum = 52;
      worldName = "Even Further Beyond";
      break;
    case "King God General Emperor, Supreme Divine Entity of Ultimacy, Archangel & Creator, Gabriel":
      bgColor = "#fcf3dc";
      worldNum = 53;
      worldName = "Realm Of The Gods";
      break;
    default:
      bgColor = "black";
      worldNum = 0;
      worldName = "Welcome to Roguelike!";
  }
  
  document.body.style.background = bgColor;
  const worldCounterEl = document.getElementById("worldCounter");
  if (worldCounterEl) {
    worldCounterEl.textContent = worldName + " " + worldNum + "-" + Math.floor(roomMoves);
  }
  
  // FIX: Trigger playing of the appropriate world music.
  if (worldName) {
    playWorldMusic(worldName);
  }
  } else {
	const nextBossFloor = Math.ceil(floorCount / 20) * 20;
	const nextBoss = getBossForFloor(nextBossFloor);
  let bgColor = "black";
  let worldNum = 0;
  let worldName = "";
  switch (nextBoss.name) {
    case "Goblin King":
      bgColor = "#113b00";
      worldNum = 1;
      worldName = "Deep Forests";
      break;
    case "Zombie Mutant":
      bgColor = "#2a5e31";
      worldNum = 2;
      worldName = "Abandoned Graveyard";
      break;
    case "Giant Lord":
      bgColor = "#5c2c00";
      worldNum = 3;
      worldName = "Deathly Cliffs";
      break;
    case "Skeleton King":
      bgColor = "#8a8a8a";
      worldNum = 4;
      worldName = "Bone Castle";
      break;
    case "Spider Queen":
      bgColor = "#202421";
      worldNum = 5;
      worldName = "Silkwoven Caverns";
      break;
    case "The Witch":
      bgColor = "#1e0033";
      worldNum = 6;
      worldName = "Arcane Swamps";
      break;
    case "Titan Golem":
      bgColor = "#242424";
      worldNum = 7;
      worldName = "Shi Mountains";
      break;
    case "Wyvern":
      bgColor = "#a32c00";
      worldNum = 8;
      worldName = "Archaic Caverns";
      break;
    case "Giant Sandworm":
      bgColor = "#ffe863";
      worldNum = 9;
      worldName = "Scorching Desert";
      break;
    case "Titanoboa Lord":
      bgColor = "#1c0a00";
      worldNum = 10;
      worldName = "Never-Ending Tunnels";
      break;
    case "Abominable Snowman":
      bgColor = "#cedede";
      worldNum = 11;
      worldName = "Freezing Tundra";
      break;
    case "Omegalodon":
      bgColor = "#2954a3";
      worldNum = 12;
      worldName = "The Black Sea";
      break;
    case "Leviathan":
      bgColor = "#0300a1";
      worldNum = 13;
      worldName = "Vast Ocean";
      break;
    case "Angel":
      bgColor = "#ffffff";
      worldNum = 14;
      worldName = "Sky Dimension";
      break;
    case "Mega Meta Mecha Annihilator - Model: Ultima":
      bgColor = "#7bb8c7";
      worldNum = 15;
      worldName = "Future Megalopolis";
      break;
    case "Grand Knight":
      bgColor = "#260d00";
      worldNum = 16;
      worldName = "Ancient Kingdom";
      break;
    case "Six-Eyed Calamity":
      bgColor = "#b700ff";
      worldNum = 17;
      worldName = "Shinjuku";
      break;
    case "Hydra":
      bgColor = "#ba0000";
      worldNum = 18;
      worldName = "Molten Treasure Trove";
      break;
    case "Guardian of Hell, Cerberus":
      bgColor = "#b30003";
      worldNum = 19;
      worldName = "The Underworld";
      break;
    case "Demon King":
      bgColor = "#7d0000";
      worldNum = 20;
      worldName = "Hell";
      break;
    case "Omni":
      bgColor = "#fcd928";
      worldNum = 21;
      worldName = "The Beyond";
      break;
    case "Goblin Emperor":
      bgColor = "#113b00";
      worldNum = 22;
      worldName = "Forest Empire";
      break;
    case "Giant Cyclops, Eater of Men":
      bgColor = "#2a5e31";
      worldNum = 23;
      worldName = "Abandoned Graveyard";
      break;
	case "Orc Lord":
      bgColor = "#063800";
      worldNum = 24;
      worldName = "Dark Forest";
      break;
    case "Medusa, Lady of Stone":
      bgColor = "#5c2c00";
      worldNum = 25;
      worldName = "Deathly Cliffs";
      break;
	case "Ogre King":
      bgColor = "#211000";
      worldNum = 26;
      worldName = "Ogre Cave";
      break;
    case "The Minotaur":
      bgColor = "#8a8a8a";
      worldNum = 27;
      worldName = "Bone Castle";
      break;
    case "Arachni Empress":
      bgColor = "#202421";
      worldNum = 28;
      worldName = "Silkwoven Caverns";
      break;
    case "Grand Sorceress":
      bgColor = "#1e0033";
      worldNum = 29;
      worldName = "Arcane Temple";
      break;
    case "Primordial Automaton":
      bgColor = "#242424";
      worldNum = 30;
      worldName = "The Depths";
      break;
    case "Dragon King":
      bgColor = "#a32c00";
      worldNum = 31;
      worldName = "Dragon King's Lair";
      break;
    case "Devourer of Worlds":
      bgColor = "#ffe863";
      worldNum = 32;
      worldName = "Scorching Desert";
      break;
    case "Frost Queen, Borealis":
      bgColor = "#cedede";
      worldNum = 33;
      worldName = "Freezing Tundra";
      break;
    case "Charybdis":
      bgColor = "#2954a3";
      worldNum = 34;
      worldName = "Valrr Trench";
      break;
	case "Queen Ant":
      bgColor = "#00b82e";
      worldNum = 35;
      worldName = "Jeju Island";
      break;
	case "Ant King, Beru":
      bgColor = "#752300";
      worldNum = 36;
      worldName = "Giant Ant Nest";
      break;
    case "Seraphim":
      bgColor = "#ffffff";
      worldNum = 37;
      worldName = "Sky Dimension";
      break;
    case "Mega Meta Mecha Annihilator - Model: Grande":
      bgColor = "#7bb8c7";
      worldNum = 38;
      worldName = "Future Megalopolis";
      break;
    case "Grand Knight II":
      bgColor = "#260d00";
      worldNum = 39;
      worldName = "Ancient Kingdom";
      break;
    case "King of Curses":
      bgColor = "#b700ff";
      worldNum = 40;
      worldName = "Shibuya";
      break;
    case "The Restricted One, Kyojiro Allista":
      bgColor = "#ba0000";
      worldNum = 41;
      worldName = "Molten Treasure Trove";
      break;
    case "The Brazen Bull, Khalkotauri":
      bgColor = "#32e800";
      worldNum = 42;
      worldName = "Open Fields";
      break;
	case "Kraken":
      bgColor = "#0300a1";
      worldNum = 43;
      worldName = "Violent Seas";
      break;
	case "King Crab":
      bgColor = "#32e800";
      worldNum = 44;
      worldName = "Khaos Island";
      break;
	case "Ghost Leviathan":
      bgColor = "#00543e";
      worldNum = 45;
      worldName = "Phantom Waters";
      break;
	case "Island Turtle":
      bgColor = "#32e800";
      worldNum = 46;
      worldName = "Mysterious Island";
      break;
	case "The World Serpent, Jörmungandr":
      bgColor = "#1c0a00";
      worldNum = 47;
      worldName = "River of Eternity";
      break;
	case "The Behemoth":
      bgColor = "#b30003";
      worldNum = 48;
      worldName = "The Underworld";
      break;
    case "Demon God":
      bgColor = "#7d0000";
      worldNum = 49;
      worldName = "7th Layer of Hell";
      break;
    case "The Black King":
      bgColor = "#000000";
      worldNum = 50;
      worldName = "Shadow Realm";
      break;
	case "Supreme Witch, Calamitas":
      bgColor = "#bd0000";
      worldNum = 51;
      worldName = "Realm of Calamity";
      break;
    case "Warden Of Judgement, Will, And Balance":
      bgColor = "#ffffff";
      worldNum = 52;
      worldName = "Even Further Beyond";
      break;
    case "King God General Emperor, Supreme Divine Entity of Ultimacy, Archangel & Creator, Gabriel":
      bgColor = "#fcf3dc";
      worldNum = 53;
      worldName = "Realm Of The Gods";
      break;
    default:
      bgColor = "black";
      worldNum = 0;
      worldName = "Welcome to Roguelike!";
  }
  
  document.body.style.background = bgColor;
  const worldCounterEl = document.getElementById("worldCounter");
  if (worldCounterEl) {
    worldCounterEl.textContent = worldName + " " + worldNum + "-" + Math.floor(roomMoves);
  }
  
  // FIX: Trigger playing of the appropriate world music.
  if (worldName) {
    playWorldMusic(worldName);
  }
  }
}

      /*******************
       * ITEM USAGE IN BATTLE
       *******************/
      function showInventoryMenu(battleMode) {
  inventoryMenu.style.display = "block";
  inventoryMenu.innerHTML = "<h3>Choose an item: </h3>";
  let hasUsableItem = false;
  player.inventory.forEach((item, index) => {
    if (item) {
      if (battleMode && !item.usableInBattle) return;
      if (!battleMode && !item.usableOutOfBattle) return;
      hasUsableItem = true;
      const btn = document.createElement("button");
      btn.textContent = item.name;
      btn.addEventListener("click", () => {
        useItem(item, index, battleMode);
      });
	  const cat = item.category.charAt(0).toUpperCase() + item.category.slice(1);
	  btn.dataset.tooltip = `${cat}-type <br>"${item.description}"`;
      inventoryMenu.appendChild(btn);
    }
  });
  attachTooltip("#inventoryMenu button[data-tooltip]");
  
  if (!hasUsableItem) {
    inventoryMenu.innerHTML += '<p>No usable items available.</p>';
    setTimeout(() => {
      unlockActions();
    }, 250);
  }
	  }

      function useItem(item, index, battleMode) {
        // Check if the item can be used in the current context.
        if (battleMode && !item.usableInBattle) {
          alert(item.name + " cannot be used in battle!");
          return;
        }
        if (!battleMode && !item.usableOutOfBattle) {
          alert(item.name + " cannot be used out of battle!");
          return;
        }
        if (item.usageScope === "passive") {
          alert(item.name + " is a passive item and cannot be used.");
          return;
        }
        inventoryMenu.style.display = "none";
        if (battleMode) {
          // Effects when used in battle:
          switch (item.name) {
            case "Medkit":
            case "Healing Potion":
			let effMaxHp = Math.floor(getEffectiveMaxHp());
			if (gameDifficulty !== "doom") {
              player.hp = Math.min(player.hp + Math.round(player.maxHp * 0.25), player.maxHp);
			} else {
			  player.hp = Math.min(player.hp + Math.round(effMaxHp * 0.05), effMaxHp);
			}
			  updateStats();
			if (gameDifficulty !== "doom") {
              logBattle("You used Healing Potion and healed 25% HP.");
			} else {
			  logBattle("You used a medkit and healed some HP.");
			}
			  updateStats();
			  updateEnemyInfo();
              break;
			
			case "Magazine":
			case "Mana Potion":
			if (gameDifficulty !== "doom") {
              player.mana = Math.min(player.mana + Math.round(player.maxMana * 0.25), player.maxMana);
			} else {
			  player.mana = player.maxMana;
			}
			  updateManaDisplay();
			if (gameDifficulty !== "doom") {
              logBattle("You used Mana Potion and healed 25% mana.");
			} else {
			  logBattle("You used a magazine and reloaded your gun.");
			}
              updateStats();
			  updateEnemyInfo();
              break;

	    case "Adrenaline":
            case "Rage Potion":
              player.rage = true;
			  player.attack *= 2;
			  player.magic = Math.ceil(player.magic *= 1.5);
			  player.perception *= 2;
			if (gameDifficulty !== "doom") {
              logBattle("You used a Rage Potion. Damage doubled this battle!");
			} else {
			  logBattle("<em>RIP AND TEAR... RIP AND TEAR... RIP AND TEAR!</em>");
			}
              updateStats();
			  updateEnemyInfo();
              break;

	    case "Gas Bomb":
            case "Poison Potion":
              currentEnemy.poison = true;
	    if (gameDifficulty !== "doom") {
              logBattle(`You threw a Poison Potion and poisoned ${currentEnemy.name}!`);
	    } else {
	      logBattle(`You threw a Gas Bomb and poisoned ${currentEnemy.name}!`);
	    }
              updateStats();
			  updateEnemyInfo();
              break;
		
		case "Lullaby Potion":
	    case "Sleeping Gas":
			let asleepTurns = Math.floor(Math.random() * 4) + 3;
			  currentEnemy.frozen = asleepTurns;
			if (gameDifficulty !== "doom") {
              logBattle(`You threw a Lullaby Potion and put ${currentEnemy.name} to sleep!`);
			} else {
			  logBattle(`You used some Sleeping Gas and put ${currentEnemy.name} to sleep!`);
			}
			  updateStats();
			  updateEnemyInfo();
              break;
			  
		case "EMP Grenade":
		case "Shock Potion":
			currentEnemy.paralyzed = true;
			if (gameDifficulty !== "doom") {
              logBattle(`You threw a Shock Potion and paralyzed ${currentEnemy.name}!`);
			} else {
			  logBattle(`You threw an EMP Grenade and paralyzed ${currentEnemy.name}!`);
			}
            updateStats();
			updateEnemyInfo();
			break;
			
            case "Weaken Potion":
              currentEnemy.weaken = true;
	    if (gameDifficulty !== "doom") {
              logBattle(`You threw a Weaken potion and weakened ${currentEnemy.name}!`);
	    }
              updateStats();
			  updateEnemyInfo();
              break;
	    
	    case "Armor+":
            case "Iron Potion":
              player.iron = true;
			  player.armor += 20;
			  player.maxArmor += 20;
	    if (gameDifficulty !== "doom") {
              logBattle("You used an Iron Potion. Enemy damage halved this battle!");
	    } else {
 	      logBattle("You activated your Armor+ and boosted your defenses!");
	    }
              updateStats();
			  updateEnemyInfo();
              break;

			case "Molotov":
              currentEnemy.burned = true;
              logBattle(`You threw the Molotov and burned ${currentEnemy.name}!`);
              updateStats();
			  updateEnemyInfo();
              break;

			case "Subzero Bomb":
			case "Frost Potion":
			  let turns = Math.floor(Math.random() * 4) + 3;
			  currentEnemy.frozen = turns;
			if (gameDifficulty !== "doom") {
			  logBattle(`You used a Frost Potion and ${currentEnemy.name} was frozen!`);
			} else {
			  logBattle(`You threw a Subzero Bomb and ${currentEnemy.name} was frozen!`);
			}
			  updateStats();
			  updateEnemyInfo();
              break;

          // Continue with enemy's turn if applicable.
		  unlockActions();
		  setTimeout(enemyTurnWrapper, 250);
          // Effects when used out-of-battle:
          switch (item.name) {
	    case "Medkit":
            case "Healing Potion":
			let effMaxHp = Math.floor(getEffectiveMaxHp());
			if (gameDifficulty !== "doom") {
              player.hp = Math.min(player.hp + Math.round(player.maxHp * 0.25), player.maxHp);
			} else {
			  player.hp = Math.min(player.hp + Math.round(effMaxHp * 0.05), effMaxHp);
			}
			  updateStats();
			if (gameDifficulty !== "doom") {
              logBattle("You used Healing Potion and healed 25% HP.");
			} else {
			  logBattle("You used a medkit and healed some HP.");
			}
              updateStats();
			  updateEnemyInfo();
              break;
			
			case "Magazine":
			case "Mana Potion":
			if (gameDifficulty !== "doom") {
              player.mana = Math.min(player.mana + Math.round(player.maxMana * 0.25), player.maxMana);
			} else {
			  player.mana = player.maxMana;
			}
			  updateManaDisplay();
			if (gameDifficulty !== "doom") {
              logBattle("You used Mana Potion and healed 25% mana.");
			} else {
			  logBattle("You used a magazine and reloaded your gun.");
			}
              updateStats();
			  updateEnemyInfo();
              break;

	    case "Adrenaline":
            case "Rage Potion":
              player.rage = true;
			  player.attack *= 2;
			  player.magic = Math.ceil(player.magic *= 1.5);
			  player.perception *= 2;
			if (gameDifficulty !== "doom") {
              logBattle("You used a Rage Potion. Damage doubled this battle!");
			} else {
			  logBattle("<em>RIP AND TEAR... RIP AND TEAR... RIP AND TEAR!</em>");
			}
              updateStats();
			  updateEnemyInfo();
              break;

	    case "Gas Bomb":
            case "Poison Potion":
              currentEnemy.poison = true;
	    if (gameDifficulty !== "doom") {
              logBattle(`You threw a Poison Potion and poisoned ${currentEnemy.name}!`);
	    } else {
	      logBattle(`You threw a Gas Bomb and poisoned ${currentEnemy.name}!`);
	    }
              updateStats();
			  updateEnemyInfo();
              break;

            case "Weaken Potion":
              currentEnemy.weaken = true;
              logBattle(`You threw a Weaken potion and weakened ${currentEnemy.name}!`);
              updateStats();
			  updateEnemyInfo();
              break;
			  
			case "Lullaby Potion":
	    case "Sleeping Gas":
			let asleepTurns = Math.floor(Math.random() * 4) + 3;
			  currentEnemy.frozen = asleepTurns;
			if (gameDifficulty !== "doom") {
              logBattle(`You threw a Lullaby Potion and put ${currentEnemy.name} to sleep!`);
			} else {
			  logBattle(`You used some Sleeping Gas and put ${currentEnemy.name} to sleep!`);
			}
			  updateStats();
			  updateEnemyInfo();
              break;
			  
			case "EMP Grenade":
		case "Shock Potion":
			currentEnemy.paralyzed = true;
			if (gameDifficulty !== "doom") {
              logBattle(`You threw a Shock Potion and paralyzed ${currentEnemy.name}!`);
			} else {
			  logBattle(`You threw an EMP Grenade and paralyzed ${currentEnemy.name}!`);
			}
            updateStats();
			updateEnemyInfo();
			break;
	    
	    case "Armor+":
            case "Iron Potion":
              player.iron = true;
			  player.armor += 20;
			  player.maxArmor += 20;
	    if (gameDifficulty !== "doom") {
              logBattle("You used an Iron Potion. Enemy damage halved this battle!");
	    } else {
 	      logBattle("You activated your Armor+ and boosted your defenses!");
	    }
              updateStats();
			  updateEnemyInfo();
              break;

			case "Molotov":
              currentEnemy.burned = true;
              logBattle(`You threw the Molotov and burned ${currentEnemy.name}!`);
              updateStats();
			  updateEnemyInfo();
              break;

			case "Subzero Bomb":
			case "Frost Potion":
			  let turns = Math.floor(Math.random() * 4) + 3;
			  currentEnemy.frozen = turns;
			if (gameDifficulty !== "doom") {
			  logBattle(`You used a Frost Potion and ${currentEnemy.name} was frozen!`);
			} else {
			  logBattle(`You threw a Subzero Bomb and ${currentEnemy.name} was frozen!`);
			}
			  updateStats();
			  updateEnemyInfo();
              break;

            default:
              alert(item.name + " has no effect.");
              return;
          }
		}
        player.inventory[index] = null;
        updateInventoryDisplay();
		updateEnemyInfo();
        updateStats();
		setTimeout(enemyTurnWrapper, 250);
		unlockActions();
		}
      }

      /*******************
       * SHOP SYSTEM
       *******************/
      function openShopMenu() {
        const shuffled = shuffle([...shopItemsList]);
        const selectedItems = shuffled.slice(0, 3);
		shopMenu.classList.add("jump-zoom-shop");
        shopItemsDiv.innerHTML = "";
        selectedItems.forEach((item) => {
          const btn = document.createElement("button");
          btn.textContent = `${item.name} - $${item.cost}`;
          btn.addEventListener("click", () => {
            buyItem(item);
          });
		  const cat = item.category.charAt(0).toUpperCase() + item.category.slice(1);
		  btn.dataset.tooltip = `${cat}-type <br>"${item.description}"`;
          shopItemsDiv.appendChild(btn);
        });
		attachTooltip("#shopItems button[data-tooltip]");
        shopMenu.style.display = "block";
		battleTint.style.display = "block";
      }

      function hasItem(name) {
        return player.inventory.some(i => i && i.name === name);
      }

      function buyItem(item) {
        if (item.type === "equipment" && hasItem(item.name)) {
          alert("You can only buy " + item.name + " once!");
          return;
        }
        const freeIndex = player.inventory.findIndex(slot => slot === null);
        if (freeIndex === -1) {
          alert("Inventory full! Cannot buy more items.");
          return;
        }
        if (player.money < item.cost) {
          alert("Not enough money!");
          return;
        }
        player.money -= item.cost;
        player.inventory[freeIndex] = {
          ...item
        };
        updateStats();
		updateInventoryDisplay();
        alert(`${item.name} purchased!`);
      }
	  
      document.getElementById("closeShopBtn").addEventListener("click", () => {
        shopMenu.style.display = "none";
		battleTint.style.display = "none";
      });
	  
	  // Open Sell Menu: list non-null inventory slots
sellBtn.addEventListener("click", () => {
  sellItemsDiv.innerHTML = "";
  player.inventory.forEach((item, idx) => {
    if (!item) return;

    let sellPrice;
    if (item.name === "Excalibur") {
      sellPrice = 10000;
    } else if (item.name === "Gun") {
      sellPrice = 500;
    } else if (item.name === "Ammo Box") {
      sellPrice = 250;
    } else if (item.name === "Previous Hero's Cape") {
      sellPrice = 0;
    } else if (item.name === "Grand Knight's Armor") {
      sellPrice = 10000;
    } else if (item.name === "Crucible") {
      sellPrice = 10000;
    } else if (item.name === "BFG9000") {
      sellPrice = 5000;
    } else if (item.name === "Argent Energy Storage") {
      sellPrice = 2500;
    } else if (item.name === "Dark Ages Mantle") {
      sellPrice = 1000;
    } else if (item.name === "Praetor Suit") {
      sellPrice = 10000;
    } else if (item.name === "Sorceress' Staff") {
      sellPrice = 10000;
    } else if (item.name === "Dragon's Fang") {
      sellPrice = 10000;
    } else if (item.name === "BFG10000") {
      sellPrice = 10000;
    } else if (item.name === "Titan's Fang") {
      sellPrice = 10000;
    } else if (item.name === "Nike Black Air Force") {
      sellPrice = 3000;
    } else if (item.name === "Delta V-Jump Boots") {
      sellPrice = 5000;
    } else {
      const shopDef = shopItemsList.find(si => si.name === item.name);
      sellPrice = shopDef ? Math.floor(shopDef.cost / 2) : 0;
    }

    // --- build button ---
    const btn = document.createElement("button");
    btn.textContent = `${item.name} — Sell for $${sellPrice}`;
    btn.style.display = "block";
    btn.style.width   = "100%";
    btn.style.margin  = "5px 0";
    btn.addEventListener("click", () => {
      player.money         += sellPrice;
      player.inventory[idx] = null;
      updateStats();
	  updateInventoryDisplay();
      btn.remove();
      alert(`Sold ${item.name} for $${sellPrice}.`);
    });
    sellItemsDiv.appendChild(btn);
  });

  sellMenu.style.display   = "block";
  shopMenu.style.display   = "none";
  battleTint.style.display = "block";
});

// Close Sell Menu
closeSellBtn.addEventListener("click", () => {
  sellMenu.style.display = "none";
  shopMenu.style.display = "block";
});

      /*******************
       * EXP & LEVEL UP
       *******************/
      function addExp(amount) {
        let multiplier = 1 + (player.potential - 1) * 0.08;
        player.exp = Math.round(player.exp + Math.floor(amount * multiplier));
        updateStats();
        while (player.exp >= player.expToLevel) {
          levelUp();
        }
      }
      let upgradesRemaining = 0;

      function levelUp() {
        player.level += 1;
        player.exp -= player.expToLevel;
        if (gameDifficulty === "easy") {
			player.expToLevel = player.expToLevel + Math.round(Math.pow(5, 1 + (player.level * 0.1)) + (player.exp * 0.33));
		} else if (gameDifficulty === "normal") {
			player.expToLevel = player.expToLevel + Math.round(Math.pow(5, 1 + (player.level * 0.1)) + (player.exp * 0.25));
		} else if (gameDifficulty === "ultimate") {
			player.expToLevel = player.expToLevel + Math.round(Math.pow(5, 1 + (player.level * 0.1)));
		} else {
        	player.expToLevel = player.expToLevel + Math.round(Math.pow(5, 1 + (player.level * 0.1)) + (player.exp * 0.1));
		}

		if (player.passiveAbility === "Aura Farmer") {
			player.baseStats.maxHp += 20;
			player.baseStats.attack += 1;
			player.baseStats.magic += 1;
			player.baseStats.maxArmor += 10;
			player.baseStats.maxMana += 5;
			player.baseStats.defense += 1;
			player.baseStats.agility += 1;
			player.baseStats.perception += 1;
			player.baseStats.potential += 1;
			player.baseStats.luck += 1;
			player.baseStats.fortune += 1;
		}
        updateStats();
        let currentRoomType = map[player.x + "_" + player.y].type;
        upgradesRemaining += (currentRoomType === ROOM_TYPES.ALTAR ? 3 : 1);
        levelUpMenu.style.display = "block";
		battleTint.style.display = "block";
		if (gameDifficulty === "doom" || gameDifficulty === "ultimate") {
			initiateLevelUp(1);
		}
      }

      function initiateLevelUp(upgradeCount) {
        upgradesRemaining += upgradeCount;
        levelUpMenu.style.display = "block";
		battleTint.style.display = "block";
      }
	  
      levelUpMenu.addEventListener("click", function(e) {
        if (e.target.tagName.toLowerCase() === "button") {
          const stat = e.target.getAttribute("data-stat");
          if (stat === "hp") {
            player.maxHp += 20 + Math.round((player.level / player.maxHp) + (player.attack / player.maxHp) + (player.defense / player.maxHp));
			player.baseStats.maxHp += 20 + Math.round((player.level / player.maxHp) + (player.attack / player.maxHp) + (player.defense / player.maxHp));
			if (gameDifficulty !== "extreme" && gameDifficulty !== "insane" && gameDifficulty !== "calamity" && gameDifficulty !== "doom") {
				player.hp = player.maxHp;
			}
			updateStats();
		  } else if (stat === "magic") {
			player.maxMana += 5;
			player.baseStats.maxMana += 5;
			if (gameDifficulty !== "extreme" && gameDifficulty !== "insane" && gameDifficulty !== "calamity" && gameDifficulty !== "doom") {
				player.mana = player.maxMana;
			}
			player.magic += 1;
			player.baseStats.magic += 1;
			updateManaDisplay();
			updateStats();
		  } else if (stat === "defense") {
			player.defense += 1;
			player.baseStats.defense += 1;
			if (gameDifficulty !== "doom") {
				player.maxArmor += 10;
				player.baseStats.maxArmor += 10;
			}
		  } else {
            player[stat] += 1;
			player.baseStats[stat] += 1;
			updateStats();
          }
		  updateManaDisplay();
          updateStats();
		  applyEquipmentEffects();
          upgradesRemaining--;
          logBattle(`Player leveled up! ${stat.toUpperCase()} increased.`);
          if (upgradesRemaining <= 0) {
            levelUpMenu.style.display = "none";
			if (battleMenu.style.display !== "block") {
				battleTint.style.display = "none";
			}
          }
        }
      });
	  
      /*******************
       * BATTLE LOG UTILS
       *******************/
      function logBattle(message) {
  const p = document.createElement("p");
  p.innerHTML = message;
  battleLog.appendChild(p);
  battleLog.scrollTop = battleLog.scrollHeight;
}
      /*******************
       * DEATH HANDLING
       *******************/
      function showDeathMenu() {
  battleMenu.style.display     = "none";
  battleLog.style.display      = "none";
  battleTint.style.display     = "block";
  inventoryMenu.style.display  = "none";
  deathMenu.style.display      = "block";
  
  stopTimer();
  const finalTime = document.getElementById("timerDisplay").textContent;
  const worldText = document.getElementById("worldCounter").textContent;
  const statsDiv = document.createElement("div");
  statsDiv.innerHTML = `
    <p>
	  <br>
      Final Level: ${player.level}<br><br>
      World Reached: ${worldText}<br><br>
      Time Survived: ${finalTime}<br><br>
      Monsters Killed: ${killCount}
	  <br>
    </p>
  `;
  
  // Find the first button in the deathMenu (either retry or resurrection)
  const firstBtn = deathMenu.querySelector("button");
  // Insert our stats *before* that button
  deathMenu.insertBefore(statsDiv, firstBtn);

  const btn = document.getElementById("resurrectBtn");
  if (player.activeAbility === "Resurrection") {
    btn.style.display = "inline-block";
  } else {
    btn.style.display = "none";
  }
}
      document.getElementById("retryBtn").addEventListener("click", function() {
        initGame();
		location.reload();
      });
	  
	  document.getElementById("resurrectBtn").addEventListener("click", () => {
  // 1) Hide death UI
  deathMenu.style.display = "none";
  battleTint.style.display = "none";

  // 2) Restore the player
  player.hp   = player.maxHp;
  player.mana = player.maxMana;
  updateStats();
  updateManaDisplay();

  // 3) Remove Resurrection so it can’t be used again
  player.activeAbility = "None";
  document.getElementById("hudPlayerActive").innerText = "None";

  // 4) Hide this button permanently
  document.getElementById("resurrectBtn").style.display = "none";
});
	  
	  function showOverlay() {
  // Check if an overlay element already exists; if not, create one.
  let overlay = document.getElementById('overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'overlay';
    // Style the overlay to cover the entire viewport.
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.background = 'rgba(0, 0, 0, 0.5)'; // semi-transparent black
    overlay.style.zIndex = '400';  // Adjust z-index to be beneath modal menus
    document.body.appendChild(overlay);
  }
  // Display the overlay.
  overlay.style.display = 'block';
}

function hideOverlay() {
  // Hide the overlay if it exists.
  const overlay = document.getElementById('overlay');
  if (overlay) {
    overlay.style.display = 'none';
  }
}

      /*******************
       * BATTLE MENU EVENTS
       *******************/
      document.getElementById("attackBtn").addEventListener("click", () => {
		if (actionsLocked) return;
		lockActions();
		playerAttack("attack");

		if (Math.random() < player.agility * 0.0005) {
			dealPlayerDamage(1);
		}
      });
	  
	  function updateManaDisplay() {
  document.querySelectorAll("#manaText").forEach(el => {
    el.innerText = `${player.mana}/${player.maxMana}`;
  });

  const percentage = (player.mana / player.maxMana) * 100;
  document.getElementById("manaBarInner").style.width = `${percentage}%`;
  
  const spellCost = player.overrideManaCost || (gameDifficulty === "doom" ? 10 : 2);
  magicBtn.disabled = player.mana < spellCost;
}
	  
      const magicBtn = document.getElementById("magicBtn");
magicBtn.addEventListener("click", () => {
  if (actionsLocked) return;
  lockActions();

  // Determine spell cost: normally 2, but Six Eyes forces it to 1
  const spellCost = player.overrideManaCost || (gameDifficulty === "doom") ? 10 : 2;

  // Perform the magic attack
  playerAttack("magic");

  // Subtract mana (never below 0)
  player.mana = Math.max(0, player.mana - spellCost);
  updateManaDisplay();
  if (player.mana < spellCost) {
	  if (gameDifficulty !== "doom") {
        logBattle("Insufficient Mana. Cannot cast spells.");
	  } else {
		logBattle("Out of ammo...");
	  }
	  magicBtn.disabled = true;
    } else {
		magicBtn.disabled = false;
	}
	
	if (player.equipment.weapon && player.equipment.weapon.name === "Flame Belch" && currentEnemy.burned === false) {
      currentEnemy.burned = true;
	  logBattle(`You used the Flame Belch and incinerated ${currentEnemy.name}!`);
	  logBattle(`${currentEnemy.name} was burned!`);
	  updateStats();
	  updateManaDisplay();
	  updateEnemyInfo();
    }
});

document.getElementById("abilityBtn").addEventListener("click", () => {
  // Prevent spamming during animations/battles
  if (actionsLocked) return;
  lockActions();
  
  let manaCost = player.overrideManaCost || 10;
    if (!skillUsedThisBattle) {
      logBattle("You're too exhausted to do that again...");
    // re-unlock so battle can continue
    setTimeout(() => unlockActions(), 250);
    return;
    } else {
      if (player.mana < manaCost) {
		if (player.activeAbility !== "Sacrifice" && player.activeAbility !== "Rip and Tear" && player.activeAbility !== "None") {
			logBattle("Insufficient Mana!");
		}
      }
      useActiveAbility();
      skillUsedThisBattle = false;
      }
  
  setTimeout(() => unlockActions(), 250);
});

      document.getElementById("itemsBtn").addEventListener("click", () => {
		showInventoryMenu();
      });
      document.getElementById("runBtn").addEventListener("click", () => {
        if (actionsLocked) return;
		lockActions();
		attemptRun();
      });
      document.getElementById("itemsBtn").addEventListener("click", () => {
		showInventoryMenu(!!currentEnemy);
      });
	  
	  /*******************
       * CASINO FUNCTIONS
       *******************/
	  
      let casinoBet = 0;
      let casinoPlayerTotal = 0;
      let casinoEnemyTotal = 0;

      function openCasino(onComplete) {
  casinoCompleteCallback = onComplete || null;
  // reset hit buttons
  hitButtons.forEach(btn => {
    btn.style.display = "";   // back to whatever your CSS says
  });
  stopWorldMusic()
  casinoMusic.play();
  casinoPlayerTotal = 0;
  casinoEnemyTotal = 0;
  casinoPlayerTotalEl.textContent = casinoPlayerTotal;
  casinoEnemyTotalEl.textContent = casinoEnemyTotal;
  betInput.value = 1;
  casinoGameArea.style.display = "none";
  casinoMenu.style.display = "block";
  battleTint.style.display = "block";
}
	  
	  function finalizeCasinoRound() {
  // Calculate the absolute difference from 21 for both player and enemy
  const playerDiff = Math.abs(21 - casinoPlayerTotal);
  const enemyDiff = Math.abs(21 - casinoEnemyTotal);
  let outcome;
  // Decide outcome based on totals.
  // If both bust (over 21), choose the one closer to 21.
  if (casinoPlayerTotal >= 21 && casinoEnemyTotal >= 21) {
    outcome = playerDiff < enemyDiff ? "win" : (playerDiff > enemyDiff ? "lose" : "push");
  } 
  // If only one of them is over 21, then that side loses.
  else if (casinoPlayerTotal >= 21) {
    outcome = "lose";
  } 
  else if (casinoEnemyTotal >= 21) {
    outcome = "win";
  }
  // If neither busted, compare closeness.
  else {
    outcome = playerDiff < enemyDiff ? "win" : (playerDiff > enemyDiff ? "lose" : "push");
  }
  
  if (outcome === "win") {
    player.money += casinoBet;
    alert("You win! Gained $" + casinoBet);
  } else if (outcome === "lose") {
    player.money -= casinoBet;
    alert("You lose! Lost $" + casinoBet);
  } else {
    alert("Push! No money won or lost.");
  }
  updateStats();
  casinoMenu.style.display = "none";
  battleTint.style.display = "none";
  hideOverlay();
  if (casinoCompleteCallback) {
    const cb = casinoCompleteCallback;
    casinoCompleteCallback = null;
    cb();
  }
  casinoMusic.pause();
  casinoMusic.currentTime = 0;
  resumeWorldMusicAfterBattle();
}
	  
      placeBetBtn.addEventListener("click", () => {
        const bet = parseInt(betInput.value);
        if (isNaN(bet) || bet < 1) {
          alert("Please enter a valid bet amount.");
          return;
        }
        if (bet > player.money) {
          alert("You cannot bet more than you have!");
          return;
        }
        casinoBet = bet * Math.round(1 + player.fortune * 0.08);
        casinoGameArea.style.display = "block";
      });
      hitButtons.forEach((btn) => {
  btn.addEventListener("click", function onHit() {
    // Hide this hit button once pressed.
    btn.style.display = "none";
    
    // Player draws a card.
    const card = Math.floor(Math.random() * 13) + 1;
    casinoPlayerTotal += card;
    casinoPlayerTotalEl.textContent = casinoPlayerTotal;
    
    // If player's total exceeds 21 immediately, handle bust.
    if (casinoPlayerTotal >= 21) {
      alert("It's a bust! You lost.");
      concludeCasinoGame(true);
      return;
    }

	if (casinoEnemyTotal >= 21) {
        alert("Dealer had a bust! They lost.");
        concludeCasinoGame();
        return;
      }
    
    // Dealer draws a card if below 17.
    if (casinoEnemyTotal < 17) {
      const enemyCard = Math.floor(Math.random() * 13) + 1;
      casinoEnemyTotal += enemyCard;
      casinoEnemyTotalEl.textContent = casinoEnemyTotal;
      
      // If the dealer’s total goes over 21 immediately, win for the player.
      if (casinoEnemyTotal >= 21) {
        alert("Dealer had a bust! They lost.");
        concludeCasinoGame();
        return;
      }
    }
    
    // Check if no hit buttons remain visible.
    const remainingButtons = Array.from(hitButtons).filter(b => b.style.display !== "none");
    if (remainingButtons.length === 0) {
      // All hit buttons have vanished; finalize round based on closeness to 21.
      finalizeCasinoRound();
    }
  });
});

      standBtn.addEventListener("click", () => {
        while (casinoEnemyTotal < 17) {
          const enemyCard = Math.floor(Math.random() * 13) + 1;
          casinoEnemyTotal += enemyCard;
        }
        casinoEnemyTotalEl.textContent = casinoEnemyTotal;
        concludeCasinoGame();
      });
      hitButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          playerHit();
        });
      });
      // Modify the stand button event.
      standBtn.addEventListener("click", () => {
        while (casinoEnemyTotal < 17) {
          const enemyCard = Math.floor(Math.random() * 13) + 1;
          casinoEnemyTotal += enemyCard;
        }
        casinoEnemyTotalEl.textContent = casinoEnemyTotal;
        concludeCasinoGame();
      });

      function concludeCasinoGame(forcedLoss = false) {
        if (casinoPlayerTotal === 0) {
          alert("Your total is 0 – Penalty!");
          playerHit();
          return;
        }
        let playerBust = casinoPlayerTotal >= 21;
        let enemyBust = casinoEnemyTotal >= 21;
        let outcome;
        if (forcedLoss || playerBust) {
          outcome = "lose";
        } else if (enemyBust) {
          outcome = "win";
        } else {
          let bonus = hasItem("Dice") ? 2 : 0;
          let effectivePlayerTotal = Math.max(casinoPlayerTotal - bonus, 0);
          let playerDiff = 21 - effectivePlayerTotal;
          let enemyDiff = 21 - casinoEnemyTotal;
          if (playerDiff < 0) playerDiff = Infinity;
          if (enemyDiff < 0) enemyDiff = Infinity;
          if (playerDiff < enemyDiff) {
            outcome = "win";
          } else if (enemyDiff < playerDiff) {
            outcome = "lose";
          } else {
            outcome = "push";
          }
        }
        if (outcome === "win") {
          player.money += casinoBet;
          alert("You win! Gained $" + casinoBet);
        } else if (outcome === "lose") {
          player.money -= casinoBet;
          alert("You lose! Lost $" + casinoBet);
          if (player.money <= 0) {
            alert("You have run out of money and must leave the casino.");
          }
        } else {
          alert("Push! No money won or lost.");
        }
        updateStats();
        casinoMenu.style.display = "none";
		battleTint.style.display = "none";
		if (casinoCompleteCallback) {
    const cb = casinoCompleteCallback;
	casinoMusic.pause();
	casinoMusic.currentTime = 0;
    casinoCompleteCallback = null;
    cb();
  }
casinoMusic.pause();
casinoMusic.currentTime = 0;
      }
	  
	  function handleTrapRoom() {
  // 67% chance it doesn’t go off
  if (Math.random() < 0.67) {
    alert("You sense something's off… but nothing happens.");
    return;
  }

  // 20–30% of max HP
  const minPct = 0.20, maxPct = 0.30;
  const pct = Math.random() * (maxPct - minPct) + minPct;
  let damage = Math.floor(player.maxHp * pct);

  // if it was a disguised trap, only 1/3 damage
  if (map[ player.x + "_" + player.y ].disguisedTrap) {
    damage = Math.floor(damage / 3);
    alert("You fell into a trap!");
  } else {
    alert("You stepped on a trap!");
  }

  player.hp = Math.max(player.hp - damage, 0);
  alert(`You take ${damage} damage.`);
  updateStats();

  if (player.hp <= 0) {
    // immediate death handling
    battleTint.style.display = "none";
    battleMenu.style.display = "none";
    deathMenu.style.display = "block";
  }
}

function getEffectiveMaxHp() {
  const extra = getGuildBonuses();
  return player.maxHp * (1 + extra.hp);
}

function updatePlayerStatsUI() {
  // Update HP text: The hpText element might now show effective values.
  const effectiveMaxHp = getEffectiveMaxHp();
  document.getElementById("hpText").innerText = `${player.hp}/${effectiveMaxHp.toFixed(0)}`;
}

/*******************
       * STATS UI
       *******************/
      function updateStats() {
  const extra = getGuildBonuses();

  // ——— HP text & bar ———
  const effMaxHp = Math.floor(getEffectiveMaxHp());
  document.querySelectorAll("#hpText").forEach(el => {
    el.textContent = `${player.hp}/${effMaxHp}`;
  });
  // bar % uses effective max
  const hpPercent = (player.hp / effMaxHp) * 100;
  document.getElementById("hpBarInner").style.width = `${hpPercent}%`;
  
  // ——— Armor text & bar ———
  document.querySelectorAll("#armorText").forEach(el => {
	el.textContent = `${player.armor}/${player.maxArmor}`;
  });
  const armorPercent = (player.armor / player.maxArmor) * 100;
  document.getElementById("armorBarInner").style.width = `${armorPercent}%`;

  // ——— EXP text & bar ———
  document.querySelectorAll("#expText").forEach(el => {
    el.textContent = `${player.exp}/${player.expToLevel}`;
  });
  const expPercent = (player.exp / player.expToLevel) * 100;
  document.getElementById("expBarInner").style.width = `${expPercent}%`;

  // ——— Attack & Magic (both get damage bonus) ———
  const effAttack = Math.floor(player.attack * (1 + extra.damage));
  document.querySelectorAll("#attackStat").forEach(el => {
    el.textContent = effAttack;
  });
  const effMagic = Math.floor(player.magic * (1 + extra.damage));
  document.querySelectorAll("#magicStat").forEach(el => {
    el.textContent = effMagic;
  });

  // ——— The rest of your stats remain unchanged ———
  document.querySelectorAll("#defenseStat").forEach(el => {
    el.textContent = player.defense;
  });
  document.querySelectorAll("#agilityStat").forEach(el => {
    el.textContent = player.agility;
  });
  document.querySelectorAll("#perceptionStat").forEach(el => {
    el.textContent = player.perception;
  });
  document.querySelectorAll("#potentialStat").forEach(el => {
    el.textContent = player.potential;
  });
  document.querySelectorAll("#luckStat").forEach(el => {
    el.textContent = player.luck;
  });
  document.querySelectorAll("#fortuneStat").forEach(el => {
    el.textContent = player.fortune;
  });
  document.querySelectorAll("#moneyStat").forEach(el => {
    el.textContent = player.money;
  });

  // ——— Player Level label ——— (unchanged)
  document.querySelectorAll("#playerLevel").forEach(el => {
    if (gameDifficulty === "doom") {
      el.textContent = `Doom Guy Level: ${player.level}`;
    } else {
      el.textContent = `Player Level: ${player.level}`;
    }
  });
}

function updateInventoryDisplay() {
  const slots = document.querySelectorAll("#inventorySlots .inventorySlot");
  slots.forEach((slot, i) => {
    // Clear out old content, listeners, and classes
    slot.innerHTML = "";
    slot.className = "inventorySlot";

    const item = player.inventory[i];
    if (item) {
	  const cat = item.category.charAt(0).toUpperCase() + item.category.slice(1);
	  slot.dataset.tooltip = `${cat}-type <br>"${item.description}"`;
      // 1. Show only the first word of the item name
      const firstWord = item.name.split(" ")[0];
      const nameEl = document.createElement("span");
      nameEl.textContent = firstWord;
      slot.appendChild(nameEl);

      // 2. Create the delete button (hidden by default)
      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.textContent = "×";
      slot.appendChild(delBtn);

      // 3. Hover handlers to show/hide the button
      slot.addEventListener("mouseover", () => {
        delBtn.style.display = "inline";
      });
      slot.addEventListener("mouseout", () => {
        delBtn.style.display = "none";
      });

      // 4. Click handler to remove the item and refresh UI
      delBtn.addEventListener("click", () => {
        player.inventory[i] = null;
        updateStats();    // this also calls updateInventoryDisplay under the hood
      });

      // 5. Colorize slot based on existing item.type/category
      let cls;
      if (item.type === "equipment") {
        cls = item.category.toLowerCase();
	if (cls === "weapon") {
		cls = "weapon";
     	}
	if (cls === "armor") {
		cls = "armor";
     	}
	if (cls === "accessory") {
		cls = "accessory";
     	}
        if (cls === "dual-wieldable") {
		cls = "weapon";
     	}
      } else if (item.type === "misc" || item.category === "dragonball") {
        cls = "dragonball";
      } else {
        cls = "consumable";
      }
      slot.classList.add(cls);
    }
  });
  attachTooltip("#inventorySlots .inventorySlot[data-tooltip]");
}

/* Revised applyEquipmentEffects: resets to player.baseStats, then reapplies gear bonuses */
function applyEquipmentEffects() {
  // 1) Reset player stats from their true baseStats
  Object.assign(player, player.baseStats);
  player.canRowMovement = false;
  player.autoWinCasino = false;

  // 2) Apply each equipped item's effects on top
  Object.values(player.equipment).forEach(item => {
    if (item && equipmentEffects[item.name]) {
      equipmentEffects[item.name](player);
    }
  });
  
  const wpn = player.equipment.weapon && player.equipment.weapon.name;
  const skillName = weaponSkillMap[wpn] || "None";
  player.weaponSkill.name = skillName;
  player.weaponSkill.usedThisBattle = false;

  // update all UI spots
  document.querySelectorAll("#hudWeaponSkill").forEach(el => {
    el.textContent = skillName;
  });
  
  updateStats();
  updateManaDisplay();
}

// Open / close the Equipment modal
equipmentBtn.addEventListener("click", () => {
  equipmentMenu.style.display = "block";
  battleTint.style.display    = "block";
});
// (A) When closing the equipment menu, also hide inventoryMenu
closeEquipmentBtn.addEventListener("click", () => {
  equipmentMenu.style.display = "none";
  inventoryMenu.style.display  = "none";
  battleTint.style.display     = "none";
});

// Populate slots when opening
// (B) Update the UI‐refresh to use "None"
function updateEquipmentUI() {
  document.querySelectorAll(".equipmentSlot").forEach(el => {
    const slot = el.dataset.slot;
    el.querySelector(".slot-item").textContent =
      player.equipment[slot]?.name || "Empty";
  });
}
// Call this once on load to show “Empty” everywhere:
updateEquipmentUI();

// Clicking a slot → show only matching inventory items
document.querySelectorAll(".equipmentSlot").forEach(slotEl => {
  slotEl.addEventListener("click", () => {
    const category = slotEl.dataset.slot; // "weapon"|"armor"|"accessory"
    showEquipmentInventory(category);
  });
});

function showEquipmentInventory(category) {
  inventoryMenu.style.display = "block";
  inventoryMenu.innerHTML = `<h3>Select a ${category} to equip:</h3>`;
  let any = false;

  player.inventory.forEach((item, idx) => {
    if (!item || item.type !== "equipment") return;

    if (category === "armor") {
      if (item.category !== "armor") return;
    } else {
      if (item.category !== category && item.category !== "dual-wieldable") return;
    }

    any = true;
    const btn = document.createElement("button");
    btn.textContent = item.name;
    btn.addEventListener("click", () => {
      equipItem(category, idx);
      inventoryMenu.style.display = "none";
    });
    inventoryMenu.appendChild(btn);
  });

  if (!any) {
    inventoryMenu.innerHTML += "<p>No items available.</p>";
  }
}

// Equip logic: swap into slot (unequipping old one back into inventory)
function equipItem(category, invIndex) {
  const newItem = player.inventory[invIndex];
  const oldItem = player.equipment[category];

  // Put old item back if present
  if (oldItem) player.inventory[invIndex] = oldItem;
  else         player.inventory[invIndex] = null;

  // Equip new one
  player.equipment[category] = newItem;

  applyEquipmentEffects();
  updateEquipmentUI();
  updateInventoryDisplay();
  
  inventoryMenu.style.display = "none";
}

// Unequip via the “×” button
document.querySelectorAll(".unequipBtn").forEach(btn => {
  btn.addEventListener("click", e => {
    e.stopPropagation();
    const category = btn.dataset.slot;
    const itm = player.equipment[category];
    if (!itm) return;

    const freeIdx = player.inventory.findIndex(s => s === null);
    if (freeIdx < 0) {
      alert("Inventory is full!");
      return;
    }

    // Move it back, clear the slot
    player.inventory[freeIdx] = itm;
    player.equipment[category]  = null;

    applyEquipmentEffects();
    updateEquipmentUI();
    updateInventoryDisplay();
  });
});

let lastHealTime = Date.now();

setInterval(() => {
  if (battleTint.style.display === "block") {
    lastHealTime = Date.now();
    return;
  }
  if (Date.now() - lastHealTime >= 333) {
    if (player.armor < player.maxArmor) {
      player.armor = Math.min(player.armor + 1, player.maxArmor);
      updateStats();
      updateManaDisplay();
      updateInventoryDisplay();
    }
    lastHealTime = Date.now();
  }
  if (Date.now() - lastHealTime >= 10000) {
    if (player.hp < player.maxHp) {
      player.hp = Math.min(player.hp + 1, player.maxHp);
      updateStats();
      updateManaDisplay();
      updateInventoryDisplay();
    }
    lastHealTime = Date.now();
  }
}, 50);



function checkDragonBalls() {
  const balls = player.inventory.filter(i => i && i.name === "DragonBall").length;
  if (balls >= 7) {
    player.inventory = player.inventory.map(i =>
      (i && i.name === "DragonBall") ? null : i
    );
    updateInventoryDisplay();
    showWishMenu();
  }
}

function showWishMenu() {
  document.getElementById("wishMenu").style.display = "flex";
}

document.getElementById("wishPowerBtn").addEventListener("click", () => {
  initiateLevelUp(50);
  alert("Your wish has been granted... Seek the Dragon Balls once more if you wish to see me again.");
  closeWishMenu();
});

document.getElementById("wishRichesBtn").addEventListener("click", () => {
  player.money += 1000000000;
  updateStats();
  alert("Your wish has been granted... Seek the Dragon Balls once more if you wish to see me again.");
  closeWishMenu();
});

document.getElementById("wishFameBtn").addEventListener("click", () => {
  player.luck      += 20;
  player.fortune   += 20;
  player.potential += 20;
  player.hp   = player.maxHp * 2;
  player.mana = player.maxMana * 2;

  player.guildUnlocked     = true;
  player.guildMissionStage = 7;
  player.guildMissionKills = getCurrentMissionRequirement();

  updateStats();
  updateManaDisplay();
  updateGuildRankUI();
  alert("Your wish has been granted... Seek the Dragon Balls once more if you wish to see me again.");
  closeWishMenu();
});

function closeWishMenu() {
  document.getElementById("wishMenu").style.display = "none";
}

      /*******************
       * START THE GAME
       *******************/
	   
	   (function() {
  const titleScreen   = document.getElementById("titleScreen");
  const playButton    = document.getElementById("playButton");
  const dotsEl        = document.getElementById("dots");

  // Prevent any title‐screen audio/UI until loading completes
  titleScreen.style.display = "none";
  const delay = 10000 + Math.random() * 10000;

  setTimeout(() => {
    // 1) change text to "Completed!"
    const textDiv = loadingScreen.querySelector(".loading-text");
    textDiv.textContent = "Loading Completed!";

    // 2) after a short moment, fade out
    setTimeout(() => {
      loadingScreen.style.opacity = "0";

      // 3) once fade completes, remove overlay & show title screen
      loadingScreen.addEventListener("transitionend", () => {
        loadingScreen.remove();
        titleScreen.style.display = "flex";
        // also reveal playButton if your logic shows it then:
        playButton.style.display = "";
      }, { once: true });

    }, 500); // hold “Completed!” for 0.5s

  }, delay);
})();
	   
initGame();
    </script>
  <div id="tooltip"></div>
  </body>
</html>